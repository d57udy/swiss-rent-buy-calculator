<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Tax System Toggle</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .debug-box { background: #f0f0f0; padding: 15px; margin: 15px 0; border-radius: 5px; font-family: monospace; }
        .tax-system { border: 2px solid #007aff; padding: 15px; border-radius: 8px; margin: 15px 0; }
        button { background: #007aff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 10px 5px; }
        button:hover { background: #0056cc; }
        label { display: block; margin: 8px 0; cursor: pointer; }
        input[type="number"] { width: 120px; padding: 5px; margin: 5px; }
        .result { background: #e8f5e8; padding: 10px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Debug: Tax System Toggle Issue</h1>
    <p>This page will debug why the tax system toggle isn't affecting the calculation results.</p>
    
    <div class="tax-system">
        <h3>Tax System Selection</h3>
        <label>
            <input type="radio" name="taxSystem" value="current" checked> Current System (2025-2027)
        </label>
        <label>
            <input type="radio" name="taxSystem" value="postReform"> Post-Reform System (2027+)
        </label>
    </div>
    
    <div>
        <h3>Test Parameters</h3>
        <label>Purchase Price: <input type="number" id="purchasePrice" value="1000000"></label>
        <label>Down Payment: <input type="number" id="downPayment" value="200000"></label>
        <label>Mortgage Rate %: <input type="number" id="mortgageRate" value="2.5" step="0.1"></label>
        <label>Monthly Rent: <input type="number" id="monthlyRent" value="3000"></label>
        <label>Marginal Tax Rate %: <input type="number" id="marginalTaxRate" value="25"></label>
        <label>Imputed Rental Value: <input type="number" id="imputedRentalValue" value="15000"></label>
        <label>Property Tax Deductions: <input type="number" id="propertyTaxDeductions" value="5000"></label>
        <button onclick="debugCalculation()">Debug Calculate</button>
        <button onclick="compareBothSystems()">Compare Both Systems</button>
    </div>
    
    <div id="debugOutput"></div>

    <script src="calculator.js"></script>
    <script>
        function debugCalculation() {
            // Step 1: Check what tax system is selected
            const taxSystemElement = document.querySelector('input[name="taxSystem"]:checked');
            const taxSystemValue = taxSystemElement ? taxSystemElement.value : 'NOT FOUND';
            const postReform = taxSystemValue === 'postReform';
            
            console.log('=== DEBUG CALCULATION ===');
            console.log('Tax system element:', taxSystemElement);
            console.log('Tax system value:', taxSystemValue);
            console.log('PostReform boolean:', postReform);
            
            // Step 2: Build parameters exactly like the main calculator
            const params = {
                purchasePrice: parseFloat(document.getElementById('purchasePrice').value),
                downPayment: parseFloat(document.getElementById('downPayment').value),
                mortgageRate: parseFloat(document.getElementById('mortgageRate').value) / 100,
                monthlyRent: parseFloat(document.getElementById('monthlyRent').value),
                propertyAppreciationRate: 0.02, // Default
                investmentYieldRate: 0.03, // Default
                termYears: 15, // Default
                annualMaintenanceCosts: 0, // Default
                amortizationYears: 0, // Default
                annualAmortization: 0, // Default
                totalRenovations: 0, // Default
                additionalPurchaseCosts: 0, // Default
                imputedRentalValue: parseFloat(document.getElementById('imputedRentalValue').value),
                propertyTaxDeductions: parseFloat(document.getElementById('propertyTaxDeductions').value),
                marginalTaxRate: parseFloat(document.getElementById('marginalTaxRate').value) / 100,
                annualRentalCosts: 5000, // Default
                scenarioMode: 'equalConsumption',
                postReform: postReform
            };
            
            console.log('Parameters:', params);
            
            // Step 3: Call calculator
            const result = SwissRentBuyCalculator.calculate(params);
            
            console.log('Result:', result);
            
            // Step 4: Display debug info
            document.getElementById('debugOutput').innerHTML = `
                <div class="debug-box">
                    <h3>Debug Results</h3>
                    <strong>Tax System Selected:</strong> ${taxSystemValue}<br>
                    <strong>PostReform Parameter:</strong> ${postReform}<br>
                    <strong>PostReform in Result:</strong> ${result.PostReform}<br>
                    <br>
                    <strong>Result Value:</strong> CHF ${Math.round(result.ResultValue).toLocaleString()}<br>
                    <strong>Decision:</strong> ${result.Decision}<br>
                    <br>
                    <strong>Year 1 Tax Components:</strong><br>
                    • Imputed Rental Tax: CHF ${Math.round(result.YearlyBreakdown[0].taxImputedRent).toLocaleString()}<br>
                    • Interest Tax Savings: CHF ${Math.round(result.YearlyBreakdown[0].taxSavingsInterest).toLocaleString()}<br>
                    • Property Tax Savings: CHF ${Math.round(result.YearlyBreakdown[0].taxSavingsPropertyExpenses).toLocaleString()}<br>
                    • Net Tax Difference: CHF ${Math.round(result.YearlyBreakdown[0].annualTaxDifference).toLocaleString()}
                </div>
            `;
        }
        
        function compareBothSystems() {
            const params = {
                purchasePrice: parseFloat(document.getElementById('purchasePrice').value),
                downPayment: parseFloat(document.getElementById('downPayment').value),
                mortgageRate: parseFloat(document.getElementById('mortgageRate').value) / 100,
                monthlyRent: parseFloat(document.getElementById('monthlyRent').value),
                propertyAppreciationRate: 0.02,
                investmentYieldRate: 0.03,
                termYears: 15,
                annualMaintenanceCosts: 0,
                amortizationYears: 0,
                annualAmortization: 0,
                totalRenovations: 0,
                additionalPurchaseCosts: 0,
                imputedRentalValue: parseFloat(document.getElementById('imputedRentalValue').value),
                propertyTaxDeductions: parseFloat(document.getElementById('propertyTaxDeductions').value),
                marginalTaxRate: parseFloat(document.getElementById('marginalTaxRate').value) / 100,
                annualRentalCosts: 5000,
                scenarioMode: 'equalConsumption'
            };
            
            const currentResult = SwissRentBuyCalculator.calculate({...params, postReform: false});
            const postReformResult = SwissRentBuyCalculator.calculate({...params, postReform: true});
            
            const difference = postReformResult.ResultValue - currentResult.ResultValue;
            
            document.getElementById('debugOutput').innerHTML = `
                <div class="result">
                    <h3>System Comparison</h3>
                    <strong>Current System:</strong> CHF ${Math.round(currentResult.ResultValue).toLocaleString()} (PostReform: ${currentResult.PostReform})<br>
                    <strong>Post-Reform System:</strong> CHF ${Math.round(postReformResult.ResultValue).toLocaleString()} (PostReform: ${postReformResult.PostReform})<br>
                    <strong>Difference:</strong> CHF ${Math.round(difference).toLocaleString()}<br>
                    <br>
                    <strong>Current Tax Components:</strong><br>
                    • Imputed: ${Math.round(currentResult.YearlyBreakdown[0].taxImputedRent)} | Interest: ${Math.round(currentResult.YearlyBreakdown[0].taxSavingsInterest)} | Property: ${Math.round(currentResult.YearlyBreakdown[0].taxSavingsPropertyExpenses)}<br>
                    <strong>Post-Reform Tax Components:</strong><br>
                    • Imputed: ${Math.round(postReformResult.YearlyBreakdown[0].taxImputedRent)} | Interest: ${Math.round(postReformResult.YearlyBreakdown[0].taxSavingsInterest)} | Property: ${Math.round(postReformResult.YearlyBreakdown[0].taxSavingsPropertyExpenses)}<br>
                    <br>
                    <strong>Status:</strong> ${difference !== 0 ? '✅ Systems show different results' : '❌ No difference detected!'}
                </div>
            `;
        }
        
        // Add event listeners to show when tax system changes
        document.querySelectorAll('input[name="taxSystem"]').forEach(radio => {
            radio.addEventListener('change', function() {
                console.log('Tax system changed to:', this.value);
                document.getElementById('debugOutput').innerHTML = '<div class="debug-box">Tax system changed to: ' + this.value + '. Click "Debug Calculate" to test.</div>';
            });
        });
    </script>
</body>
</html>