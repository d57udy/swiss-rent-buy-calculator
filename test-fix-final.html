<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Fix Test</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        .test-result { background: #f0f0f0; padding: 15px; margin: 15px 0; border-radius: 5px; }
        .success { background: #d4edda; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; border-left: 4px solid #dc3545; }
        button { background: #007aff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
    </style>
</head>
<body>
    <h1>Final Fix Verification</h1>
    <p>Testing if the tax system toggle now works correctly after fixing the new calculator issue.</p>
    
    <button onclick="testFix()">Test Tax System Toggle Fix</button>
    
    <div id="results"></div>

    <script src="calculator.js"></script>
    <script src="new-calculator-prototype.js"></script>
    <script>
        function testFix() {
            // Test parameters similar to user's case
            const params = {
                purchasePrice: 1200000,
                downPayment: 240000,
                mortgageRate: 0.025,
                annualMaintenanceCosts: 15000,
                amortizationYears: 10,
                annualAmortization: 19200,
                totalRenovations: 0,
                additionalPurchaseCosts: 24000,
                imputedRentalValue: 26000,
                propertyTaxDeductions: 12000,
                marginalTaxRate: 0.26,
                propertyAppreciationRate: 0.02,
                monthlyRent: 3300,
                annualRentalCosts: 6000,
                investmentYieldRate: 0.035,
                termYears: 15,
                scenarioMode: 'equalConsumption'
            };
            
            console.log('=== FINAL FIX TEST ===');
            
            // Test with both calculators explicitly
            const oldCalcCurrent = SwissRentBuyCalculator.calculate({...params, postReform: false});
            const oldCalcPostReform = SwissRentBuyCalculator.calculate({...params, postReform: true});
            
            // Test new calculator to confirm it ignores postReform
            const newCalcTest = window.SwissRentBuyCalculatorNew ? 
                window.SwissRentBuyCalculatorNew.calculate({...params, postReform: true}) : 
                { ResultValue: 'N/A', PostReform: 'N/A' };
            
            // Test the engine selection logic
            const calcEngine = SwissRentBuyCalculator; // This should now always use the old calculator
            const engineResult = calcEngine.calculate({...params, postReform: true});
            
            const difference = oldCalcPostReform.ResultValue - oldCalcCurrent.ResultValue;
            
            const resultHTML = `
                <div class="test-result ${Math.abs(difference) > 100 ? 'success' : 'error'}">
                    <h3>Fix Verification Results</h3>
                    <strong>Old Calculator (supports postReform):</strong><br>
                    • Current System: CHF ${Math.round(oldCalcCurrent.ResultValue).toLocaleString()}<br>
                    • Post-Reform System: CHF ${Math.round(oldCalcPostReform.ResultValue).toLocaleString()}<br>
                    • Difference: CHF ${Math.round(difference).toLocaleString()}<br>
                    <br>
                    <strong>New Calculator Test (should ignore postReform):</strong><br>
                    • Result: ${typeof newCalcTest.ResultValue === 'number' ? 'CHF ' + Math.round(newCalcTest.ResultValue).toLocaleString() : newCalcTest.ResultValue}<br>
                    • PostReform Flag: ${newCalcTest.PostReform}<br>
                    <br>
                    <strong>Engine Selection Test:</strong><br>
                    • Using: ${calcEngine === SwissRentBuyCalculator ? 'SwissRentBuyCalculator (OLD - CORRECT)' : 'SwissRentBuyCalculatorNew (NEW - WRONG)'}<br>
                    • Result: CHF ${Math.round(engineResult.ResultValue).toLocaleString()}<br>
                    • PostReform Flag: ${engineResult.PostReform}<br>
                    <br>
                    <strong>Status:</strong> ${Math.abs(difference) > 100 ? '✅ FIX SUCCESSFUL - Tax systems show different results' : '❌ Still broken - No difference detected'}<br>
                    <strong>Expected:</strong> Tax systems should show different results (difference > CHF 100)<br>
                    <strong>Actual:</strong> Difference is CHF ${Math.round(Math.abs(difference)).toLocaleString()}
                </div>
            `;
            
            document.getElementById('results').innerHTML = resultHTML;
            
            console.log('Old calc current:', oldCalcCurrent.ResultValue, 'PostReform:', oldCalcCurrent.PostReform);
            console.log('Old calc post-reform:', oldCalcPostReform.ResultValue, 'PostReform:', oldCalcPostReform.PostReform);
            console.log('Engine selection result:', engineResult.ResultValue, 'PostReform:', engineResult.PostReform);
            console.log('Fix successful:', Math.abs(difference) > 100);
        }
        
        // Auto-run test
        window.onload = testFix;
    </script>
</body>
</html>