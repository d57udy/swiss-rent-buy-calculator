<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'">
    <title>Swiss Rent vs Buy Calculator</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f7;
            color: #1d1d1f;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #1d1d1f;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 1px solid #d2d2d7;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            color: #86868b;
            font-size: 16px;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            color: #007aff;
            border-bottom-color: #007aff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .form-section h3 {
            margin: 0 0 20px 0;
            color: #1d1d1f;
            font-size: 18px;
            border-bottom: 2px solid #007aff;
            padding-bottom: 8px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }
        
        .input-label {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1d1d1f;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 8px;
            cursor: help;
        }
        
        .tooltip .info-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: #007aff;
            color: white;
            border-radius: 50%;
            text-align: center;
            font-size: 12px;
            line-height: 16px;
            font-weight: bold;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 300px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 13px;
            line-height: 1.4;
            font-weight: normal;
        }
        
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .input-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .checkbox-container input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .checkbox-container label {
            font-size: 14px;
            color: #666;
            font-weight: normal;
        }
        
        input[type="number"], select {
            padding: 12px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            width: 100%;
            max-width: 300px;
        }
        
        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #007aff;
        }
        
        input[type="number"]:disabled {
            background-color: #f5f5f5;
            color: #999;
        }
        
        .unit {
            color: #666;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .button {
            background: #007aff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 20px;
        }
        
        .button:hover {
            background: #0056b3;
        }
        
        .button.secondary {
            background: #f2f2f7;
            color: #1d1d1f;
        }
        
        .button.secondary:hover {
            background: #e5e5ea;
        }
        
        .results {
            background: #f2f2f7;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px 0;
            border-bottom: 1px solid #d2d2d7;
        }
        
        .result-item:last-child {
            border-bottom: none;
            font-weight: 600;
            font-size: 18px;
        }
        
        .decision-buy {
            color: #34c759;
        }
        
        .decision-rent {
            color: #ff3b30;
        }
        
        .decision-even {
            color: #ff9500;
        }
        
        .pivot-table {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        .pivot-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .pivot-table th, .pivot-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #d2d2d7;
        }
        
        .pivot-table th {
            background: #f2f2f7;
            font-weight: 600;
        }
        
        .cell-buy {
            background: rgba(52, 199, 89, 0.2);
        }
        
        .cell-rent {
            background: rgba(255, 59, 48, 0.2);
        }
        
        .cell-even {
            background: rgba(255, 149, 0, 0.2);
        }
        
        .loading {
            text-align: center;
            color: #86868b;
            padding: 20px;
        }
        
        .sweep-controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .sweep-param {
            background: #f2f2f7;
            padding: 20px;
            border-radius: 8px;
        }
        
        .sweep-param h4 {
            margin: 0 0 15px 0;
            color: #1d1d1f;
        }
        
        .range-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        
        .range-inputs input {
            padding: 8px;
            font-size: 14px;
        }
        
        .save-load-controls {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 20px;
            padding: 0 10px;
        }
        
        .save-load-button {
            background: #f2f2f7;
            color: #1d1d1f;
            padding: 8px 16px;
            border: 1px solid #d2d2d7;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .save-load-button:hover {
            background: #e5e5ea;
            border-color: #007aff;
        }
        
        .save-load-button.save {
            background: #007aff;
            color: white;
            border-color: #007aff;
        }
        
        .save-load-button.save:hover {
            background: #0056b3;
        }
        
        #loadFileInput {
            display: none;
        }
        
        .save-load-status {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: right;
            min-height: 16px;
        }
        
        .save-load-status.success {
            color: #34c759;
        }
        
        .save-load-status.error {
            color: #ff3b30;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .range-inputs {
                grid-template-columns: 1fr;
            }
            
            .tooltip .tooltiptext {
                width: 250px;
                margin-left: -125px;
            }
            
            .save-load-controls {
                justify-content: center;
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Swiss Rent vs Buy Calculator</h1>
        
        <!-- Save/Load Controls -->
        <div class="save-load-controls">
            <button class="save-load-button" id="loadParametersBtn">
                📁 Load Parameters
            </button>
            <button class="save-load-button save" id="saveParametersBtn">
                💾 Save Parameters
            </button>
            <input type="file" id="loadFileInput" accept=".json">
        </div>
        <div class="save-load-status" id="saveLoadStatus"></div>
        
        <div class="tab-container">
            <button class="tab active" data-tab="single">Single Calculation</button>
            <button class="tab" data-tab="breakeven">Max Bid Finder</button>
            <button class="tab" data-tab="sweep">Parameter Sweep</button>
            <button class="tab" data-tab="about">About</button>
        </div>
        
        <!-- Single Calculation Tab -->
        <div class="tab-content active" id="single">
            <div style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid #007aff;">
                <p style="margin: 0; color: #1d1d1f; line-height: 1.5;">Calculate whether renting or buying a property makes more financial sense for your situation. This tool analyzes all costs, tax implications, and investment opportunities over your chosen time period to help you make an informed decision.</p>
            </div>
            <!-- Purchase Parameters Section -->
            <div class="form-section">
                <h3>Purchase Parameters</h3>
                
                <div class="input-group">
                    <div class="input-label">
                        Purchase Price
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext">The total price you would pay to purchase the property, including all costs.</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <input type="number" id="purchasePrice" value="2000000" step="1000" min="0">
                        <span class="unit">CHF</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        Down Payment / Mortgage Configuration
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext">Choose how to specify your financing: either set the down payment directly, calculate it automatically (20%), or maximize your mortgage up to a specified limit while maintaining the mandatory 20% minimum down payment.</span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div class="checkbox-container">
                            <input type="radio" id="autoDownPayment" name="downPaymentMode" value="auto" checked>
                            <label for="autoDownPayment">Set mortgage to 80% of purchase price, down-payment to 20%
                                <div class="tooltip" style="margin-left: 5px;">
                                    <span class="info-icon">i</span>
                                    <span class="tooltiptext">Automatically sets total LTV to 80% (typically ~66.6% first‑rank + up to ~13.4% second‑rank). Down payment is 20% of the purchase price. Under Swiss rules the second‑rank portion must be amortized down to 66.6% LTV within 15 years.</span>
                                </div>
                            </label>
                        </div>
                        <div class="checkbox-container">
                            <input type="radio" id="manualDownPayment" name="downPaymentMode" value="manual">
                            <label for="manualDownPayment">Specify down payment manually
                                <div class="tooltip" style="margin-left: 5px;">
                                    <span class="info-icon">i</span>
                                    <span class="tooltiptext">Enter any down payment you plan to use. For regulatory realism, a warning appears if equity falls below 20% of the purchase price.</span>
                                </div>
                            </label>
                        </div>
                        <div class="checkbox-container">
                            <input type="radio" id="mortgageAmountMode" name="downPaymentMode" value="mortgage">
                            <label for="mortgageAmountMode">Maximize mortgage up to 80% of purchase price, but below specified limit
                                <div class="tooltip" style="margin-left: 5px;">
                                    <span class="info-icon">i</span>
                                    <span class="tooltiptext">Sets the mortgage to min(specified limit, 80% × purchase price). Down payment = purchase price − mortgage. Guarantees at least 20% down payment.</span>
                                </div>
                            </label>
                        </div>
                        <div class="checkbox-container">
                            <input type="radio" id="mortgageLtv66Mode" name="downPaymentMode" value="mortgage66">
                            <label for="mortgageLtv66Mode">Maximize mortgage up to 66.6% of purchase price, but below specified limit (no 2nd rank mortgage)
                                <div class="tooltip" style="margin-left: 5px;">
                                    <span class="info-icon">i</span>
                                    <span class="tooltiptext">Sets the mortgage to min(specified limit, 66.6% × purchase price). Down payment = purchase price − mortgage (≥ 33.4%). This avoids a second‑rank mortgage by keeping LTV at or below 66.6%.</span>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="input-container" id="downPaymentInput">
                        <label>Down Payment:</label>
                        <input type="number" id="downPayment" value="400000" step="1000" min="0" disabled>
                        <span class="unit">CHF</span>
                    </div>
                    
                    <div class="input-container" id="mortgageAmountInput" style="display: none;">
                        <label>Maximum Mortgage Amount:
                            <div class="tooltip" style="margin-left: 5px; display:inline-flex;">
                                <span class="info-icon">i</span>
                                <span class="tooltiptext">Used by the “maximize mortgage” modes. The mortgage will be the smaller of this limit and the LTV cap (80% or 66.6% of purchase price). Down payment is the remainder.</span>
                            </div>
                        </label>
                        <input type="number" id="mortgageAmount" value="1600000" step="1000" min="0">
                        <span class="unit">CHF</span>
                    </div>
                    
                    <div id="downPaymentWarning" style="display: none; margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 6px; color: #856404; font-size: 14px;">
                        <strong>Warning:</strong> Down payment is below 20% minimum. Adjusting to 20%.
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        Additional Purchase Costs
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext">Additional costs when buying: notary fees, land registry, real estate agent commission, taxes.</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <input type="number" id="additionalPurchaseCosts" value="5000" step="1000" min="0">
                        <span class="unit">CHF</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        Total Renovations
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext">One-time renovation and improvement costs over the analysis period.</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <input type="number" id="totalRenovations" value="0" step="1000" min="0">
                        <span class="unit">CHF</span>
                    </div>
                </div>
            </div>
            
            <!-- Mortgage Parameters Section -->
            <div class="form-section">
                <h3>Mortgage Parameters</h3>
                
                <div class="input-group">
                    <div class="input-label">
                        Mortgage Interest Rate
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext">Annual interest rate for your mortgage. Current Swiss rates typically range from 0.5% to 3%.</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <input type="number" id="mortgageRate" value="0.9" step="0.1" min="0">
                        <span class="unit">% per year</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        Amortization Period
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext">Period over which you pay down the mortgage. Swiss regulations require amortization to 66.6% (2/3) LTV within 15 years.</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <input type="number" id="amortizationYears" value="10" step="1" min="1" max="20">
                        <span class="unit">years</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        Annual Amortization Amount
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext">Annual amount paid to reduce mortgage principal. Choose calculation method below.</span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div class="checkbox-container">
                            <input type="radio" id="autoAmortization" name="amortizationMode" value="auto" checked>
                            <label for="autoAmortization">Calculate automatically (mortgage ÷ amortization period)</label>
                        </div>
                        <div class="checkbox-container">
                            <input type="radio" id="swissAmortization" name="amortizationMode" value="swiss">
                            <label for="swissAmortization">Swiss regulation: amortize to 66.6% (2/3) LTV within 15 years
                                <div class="tooltip" style="margin-left: 5px;">
                                    <span class="info-icon">i</span>
                                    <span class="tooltiptext">Swiss mortgage regulations require that mortgages above 66.6% LTV (second mortgage) must be amortized down to 66.6% (2/3) within 15 years. This calculates the minimum required annual amortization to comply with Swiss banking regulations. If your LTV is already 66.6% or below, no mandatory amortization is required.</span>
                                </div>
                            </label>
                        </div>
                        <div class="checkbox-container">
                            <input type="radio" id="manualAmortization" name="amortizationMode" value="manual">
                            <label for="manualAmortization">Specify amortization amount manually</label>
                        </div>
                    </div>
                    
                    <div class="input-container">
                        <input type="number" id="annualAmortization" value="32000" step="1000" min="0" disabled>
                        <span class="unit">CHF per year</span>
                    </div>
                </div>
            </div>
            
            <!-- Property Costs Section -->
            <div class="form-section">
                <h3>Property Costs</h3>
                
                <div class="input-group">
                    <div class="input-label">
                        Annual Maintenance Costs
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext">Annual costs for property maintenance, repairs, and upkeep. Typically 1-1.5% of property value per year.</span>
                        </div>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" id="autoMaintenance" checked>
                        <label for="autoMaintenance">Calculate automatically (1.25% of purchase price)</label>
                    </div>
                    <div class="input-container">
                        <input type="number" id="annualMaintenanceCosts" value="25000" step="1000" min="0" disabled>
                        <span class="unit">CHF per year</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        Property Appreciation Rate
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext">Expected annual increase in property value. Swiss real estate has historically appreciated 1-3% annually.</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <input type="number" id="propertyAppreciation" value="1.0" step="0.1" min="-5" max="10">
                        <span class="unit">% per year</span>
                    </div>
                </div>
            </div>
            
            <!-- Tax Parameters Section -->
            <div class="form-section">
                <h3>Tax Parameters</h3>
                
                <div class="input-group">
                    <div class="input-label">
                        Imputed Rental Value
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext">Taxable benefit of living in your own property. Swiss tax authorities typically assess this at 60-70% of market rent.</span>
                        </div>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" id="autoImputedRental" checked>
                        <label for="autoImputedRental">Calculate automatically (65% of annual rent)</label>
                    </div>
                    <div class="input-container">
                        <input type="number" id="imputedRentalValue" value="42900" step="1000" min="0" disabled>
                        <span class="unit">CHF per year</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        Property Tax Deductions
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext">Annual tax-deductible expenses for property ownership: maintenance, repairs, mortgage interest, insurance, utilities.</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <input type="number" id="propertyTaxDeductions" value="13000" step="1000" min="0">
                        <span class="unit">CHF per year</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        Marginal Tax Rate
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext">Your marginal tax rate (federal + cantonal + municipal). Varies by canton and income level, typically 15-45%.</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <input type="number" id="marginalTaxRate" value="30.0" step="0.1" min="0" max="50">
                        <span class="unit">%</span>
                    </div>
                </div>
            </div>
            
            <!-- Rental Parameters Section -->
            <div class="form-section">
                <h3>Rental Parameters</h3>
                
                <div class="input-group">
                    <div class="input-label">
                        Monthly Rent
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext">Monthly rent for a comparable property. This is the alternative to buying.</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <input type="number" id="monthlyRent" value="5500" step="100" min="0">
                        <span class="unit">CHF per month</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        Annual Rental Costs
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext">Additional annual costs when renting: utilities, insurance, small repairs not covered by landlord.</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <input type="number" id="annualRentalCosts" value="20000" step="1000" min="0">
                        <span class="unit">CHF per year</span>
                    </div>
                </div>
            </div>
            
            <!-- Investment Parameters Section -->
            <div class="form-section">
                <h3>Investment Parameters</h3>
                
                <div class="input-group">
                    <div class="input-label">
                        Investment Yield Rate
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext">Expected annual return on alternative investments (stocks, bonds, funds) if you rent instead of buying.</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <input type="number" id="investmentYield" value="3.5" step="0.1" min="0" max="15">
                        <span class="unit">% per year</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        Analysis Period
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext">Time horizon for the rent vs buy comparison. Typically 5-15 years to account for transaction costs and market cycles.</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <input type="number" id="termYears" value="10" step="1" min="1" max="30">
                        <span class="unit">years</span>
                    </div>
                </div>
            </div>
            
            <!-- Comparison Mode -->
            <div class="form-section">
                <h3>Comparison Mode</h3>
                <div class="input-group">
                    <div class="input-label">
                        Scenario
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext">Choose how to compare rent vs buy: Equal consumption (baseline), Cash-flow parity (invests the monthly difference and withdraws when negative), or Equal savings (renter invests the buyer's amortization-equivalent each year).</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <label style="margin-right: 16px; display: inline-flex; align-items: center; gap: 6px;">
                            <input type="radio" name="scenarioMode" value="equalConsumption" checked>
                            <span>Equal consumption (baseline)</span>
                        </label>
                        <label style="margin-right: 16px; display: inline-flex; align-items: center; gap: 6px;">
                            <input type="radio" name="scenarioMode" value="cashflowParity">
                            <span>Cash-flow parity (invest actual monthly difference)</span>
                        </label>
                        <label style="display: inline-flex; align-items: center; gap: 6px;">
                            <input type="radio" name="scenarioMode" value="equalSavings">
                            <span>Equal savings (amortization equivalent)</span>
                        </label>
                    </div>
                </div>

                <div style="margin-top: 10px; background: #f9f9fb; border: 1px solid #e5e5ea; border-left: 4px solid #007aff; border-radius: 8px; padding: 12px; font-size: 13px; line-height: 1.5; color: #1d1d1f;">
                    <div style="font-weight: 600; margin-bottom: 6px;">About these scenarios</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 10px;">
                        <div>
                            <div style="font-weight: 600; color: #0b7dda; margin-bottom: 4px;">Equal consumption (standard)</div>
                            <ul style="margin: 0 0 0 16px; padding: 0;">
                                <li>Compares the economic cost of housing services.</li>
                                <li>Buyer’s amortization is treated as equity and reflected via “− property value + remaining mortgage.”</li>
                                <li>Renter invests only the initial capital not tied up (down payment + purchase costs).</li>
                                <li>Renter’s investment income is taxed at your marginal rate.</li>
                                <li>Matches common banking and regulatory framing.</li>
                            </ul>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #0b7dda; margin-bottom: 4px;">Cash-flow parity (invest actual monthly difference)</div>
                            <ul style="margin: 0 0 0 16px; padding: 0;">
                                <li>Renter invests the monthly budget advantage; if the renter pays more than the buyer, the difference is withdrawn.</li>
                                <li>Contributions/withdrawals vary over time; all flows compound at the investment yield; investment income is taxed.</li>
                                <li>Treats savings discipline realistically and mirrors the cash budget each year.</li>
                            </ul>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #0b7dda; margin-bottom: 4px;">Equal savings (amortization equivalent)</div>
                            <ul style="margin: 0 0 0 16px; padding: 0;">
                                <li>Assumes renter also saves and invests the amortization-equivalent each year (during amortization period).</li>
                                <li>Those contributions compound at the investment yield; investment income is taxed.</li>
                                <li>Useful to test disciplined saving behavior and market-return sensitivity.</li>
                                <li>Typically shifts results toward renting when investment return &gt; property appreciation.</li>
                            </ul>
                        </div>
                    </div>
                    <div style="margin-top: 8px; color: #3c3c43;">
                        <strong>Guidance:</strong> Use <em>Equal consumption</em> for baseline comparisons and affordability framing. Choose <em>Cash-flow parity</em> to mirror your real monthly budget (invest when cheaper to rent, withdraw when renting is costlier). Choose <em>Equal savings</em> to answer “what if I invest with the same discipline as amortization?”.
                    </div>
                </div>
            </div>

            <button class="button" id="calculateBtn">Calculate</button>
            
            <div id="singleResults" class="results" style="display: none;"></div>
        </div>
        
        <!-- Max Bid Finder Tab -->
        <div class="tab-content" id="breakeven">
            <div style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid #007aff;">
                <p style="margin: 0; color: #1d1d1f; line-height: 1.5;">Find the maximum price you should bid for a property to break even with renting. This tool uses all your detailed parameters from the single calculation to find the purchase price where buying and renting have equal total costs.</p>
            </div>
            
            <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                <p style="margin: 0; color: #856404; line-height: 1.5;"><strong>How it works:</strong> This tool copies all your detailed parameters from the Single Calculation tab and searches for the maximum purchase price where the financial benefit equals zero (break-even point). Only adjust the search parameters below if needed.</p>
            </div>
            
            <div class="form-section">
                <h3>Search Configuration</h3>
                
                <div class="input-group">
                    <div class="input-label">Min Search Price</div>
                    <div class="input-container">
                        <input type="number" id="beMinPrice" value="1500000" step="10000">
                        <span class="unit">CHF</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">Max Search Price</div>
                    <div class="input-container">
                        <input type="number" id="beMaxPrice" value="10000000" step="10000">
                        <span class="unit">CHF</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">Search Tolerance</div>
                    <div class="input-container">
                        <input type="number" id="beTolerance" value="2500" step="500">
                        <span class="unit">CHF</span>
                    </div>
                </div>
            </div>
            
            <button class="button" id="breakevenBtn">Find Max Bid Price</button>
            
            <div id="breakevenResults" class="results" style="display: none;"></div>
        </div>
        
        <!-- Parameter Sweep Tab -->
        <div class="tab-content" id="sweep">
            <div style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid #007aff;">
                <p style="margin: 0; color: #1d1d1f; line-height: 1.5;">Analyze how changing market conditions affect the rent vs buy decision. This tool runs multiple scenarios across different property appreciation rates, investment yields, and mortgage rates, displaying results in an interactive color-coded table.</p>
            </div>
            <h3>Parameter Sweep Configuration</h3>
            
            <div class="sweep-controls">
                <div class="sweep-param">
                    <h4>Property Appreciation (%/year)</h4>
                    <div class="range-inputs">
                        <input type="number" id="propAppMin" placeholder="Min" value="-1" step="0.5">
                        <input type="number" id="propAppMax" placeholder="Max" value="5" step="0.5">
                        <input type="number" id="propAppStep" placeholder="Step" value="1" step="0.1">
                    </div>
                </div>
                
                <div class="sweep-param">
                    <h4>Investment Yield (%/year)</h4>
                    <div class="range-inputs">
                        <input type="number" id="invYieldMin" placeholder="Min" value="-1" step="0.5">
                        <input type="number" id="invYieldMax" placeholder="Max" value="8" step="0.5">
                        <input type="number" id="invYieldStep" placeholder="Step" value="1" step="0.1">
                    </div>
                </div>
                
                <div class="sweep-param">
                    <h4>Mortgage Rate (%)</h4>
                    <div class="range-inputs">
                        <input type="number" id="mortRateMin" placeholder="Min" value="1" step="0.1">
                        <input type="number" id="mortRateMax" placeholder="Max" value="5" step="0.1">
                        <input type="number" id="mortRateStep" placeholder="Step" value="1" step="0.1">
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <button class="button" id="sweepBtn">Run Parameter Sweep</button>
            </div>
            
            <div id="sweepResults"></div>
        </div>
        
        <!-- About Tab -->
        <div class="tab-content" id="about">
            <div style="max-width: 800px;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="color: #007aff; margin-bottom: 10px;">Swiss Rent vs Buy Calculator</h2>
                    <div style="color: #666; font-size: 14px; margin-bottom: 5px;">Version <span id="app-version">2.1.0</span></div>
                    <div style="color: #666; font-size: 14px;">Created by <strong>d57udy</strong></div>
                </div>

                <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                    <h3 style="margin-top: 0; color: #1d1d1f;">Project Overview</h3>
                    <p style="line-height: 1.6; color: #333;">
                        This comprehensive financial calculator was created to facilitate informed home purchase decisions in Switzerland. 
                        It provides sophisticated analysis tools beyond traditional rent vs buy calculators, helping you make one of 
                        life's most important financial decisions with confidence.
                    </p>
                </div>

                <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                    <h3 style="margin-top: 0; color: #1d1d1f;">Inspiration & Enhanced Functionality</h3>
                    <p style="line-height: 1.6; color: #333; margin-bottom: 15px;">
                        Originally inspired by leading Swiss rent vs buy calculators, 
                        this tool extends the basic analysis with powerful additional features:
                    </p>
                    <ul style="line-height: 1.6; color: #333; padding-left: 20px;">
                        <li><strong>Maximum Bid Price Finder:</strong> Determine the highest price you should bid for a property to break even with renting</li>
                        <li><strong>Parameter Sweep Analysis:</strong> Test hundreds of market scenarios to understand decision sensitivity</li>
                        <li><strong>Swiss-Specific Modeling:</strong> Accurate tax calculations, mortgage regulations, and market standards</li>
                        <li><strong>Comprehensive Testing:</strong> Extensively tested calculation logic and Swiss financial modeling</li>
                        <li><strong>Export Capabilities:</strong> Download detailed results for further analysis in Excel or other tools</li>
                    </ul>
                </div>


                <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                    <h3 style="margin-top: 0; color: #1d1d1f;">Open Source & Transparent</h3>
                    <p style="line-height: 1.6; color: #333; margin-bottom: 15px;">
                        This calculator is made available under the <strong>Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License (CC BY-NC-SA 4.0)</strong>. 
                        You can review the complete source code, calculation methodology, and validation testing to understand exactly how your 
                        financial analysis is performed.
                    </p>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #2196f3;">
                        <h4 style="margin: 0 0 10px 0; color: #1976d2; font-size: 16px;">License Terms - You are free to:</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #333; line-height: 1.5;">
                            <li><strong>Share:</strong> Copy and redistribute in any medium or format</li>
                            <li><strong>Adapt:</strong> Remix, transform, and build upon the material</li>
                        </ul>
                        <h4 style="margin: 15px 0 10px 0; color: #1976d2; font-size: 16px;">Under these conditions:</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #333; line-height: 1.5;">
                            <li><strong>Attribution:</strong> Credit d57udy and link to this site</li>
                            <li><strong>NonCommercial:</strong> You may not use the material for commercial purposes</li>
                            <li><strong>ShareAlike:</strong> Distribute derivatives under the same license</li>
                        </ul>
                    </div>
                    <div style="text-align: center;">
                        <a href="https://github.com/yourusername/swiss-rent-buy-calculator" target="_blank" rel="noopener noreferrer"
                           style="display: inline-block; background: #007aff; color: white; padding: 10px 20px; 
                                   border-radius: 6px; text-decoration: none; font-weight: 600; margin-right: 10px;">
                            📁 View Source Code
                        </a>
                        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer"
                           style="display: inline-block; background: #ff9800; color: white; padding: 10px 20px; 
                                   border-radius: 6px; text-decoration: none; font-weight: 600;">
                            📜 View License
                        </a>
                    </div>
                </div>

                <div style="background: linear-gradient(135deg, #007aff 0%, #0056b3 100%); padding: 25px; 
                            border-radius: 8px; color: white; text-align: center; margin-bottom: 25px;">
                    <h3 style="margin-top: 0; color: white;">Like this project?</h3>
                    <p style="line-height: 1.6; margin-bottom: 20px; opacity: 0.9;">
                        If this calculator has helped you make an informed property decision, consider sharing it 
                        with others or buying me a coffee to support continued development!
                    </p>
                    
                    <!-- Social Media Sharing -->
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: white; margin-bottom: 15px; font-size: 16px;">Share with others:</h4>
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <a href="https://twitter.com/intent/tweet?text=Check%20out%20this%20comprehensive%20Swiss%20Rent%20vs%20Buy%20Calculator!%20It%20helped%20me%20make%20an%20informed%20property%20decision.&url=https://yoursite.com" 
                               target="_blank" rel="noopener noreferrer" style="display: inline-block; background: rgba(255,255,255,0.2); color: white; 
                                      padding: 8px 16px; border-radius: 6px; text-decoration: none; font-weight: 600;
                                      border: 1px solid rgba(255,255,255,0.3); transition: all 0.3s ease; font-size: 14px;>
                                🐦 Twitter
                            </a>
                            <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://yoursite.com" 
                               target="_blank" rel="noopener noreferrer" style="display: inline-block; background: rgba(255,255,255,0.2); color: white; 
                                      padding: 8px 16px; border-radius: 6px; text-decoration: none; font-weight: 600;
                                      border: 1px solid rgba(255,255,255,0.3); transition: all 0.3s ease; font-size: 14px;>
                                💼 LinkedIn
                            </a>
                            <a href="https://www.facebook.com/sharer/sharer.php?u=https://yoursite.com" 
                               target="_blank" rel="noopener noreferrer" style="display: inline-block; background: rgba(255,255,255,0.2); color: white; 
                                      padding: 8px 16px; border-radius: 6px; text-decoration: none; font-weight: 600;
                                      border: 1px solid rgba(255,255,255,0.3); transition: all 0.3s ease; font-size: 14px;>
                                📘 Facebook
                            </a>
                            <a href="https://reddit.com/submit?url=https://yoursite.com&title=Swiss%20Rent%20vs%20Buy%20Calculator" 
                               target="_blank" rel="noopener noreferrer" style="display: inline-block; background: rgba(255,255,255,0.2); color: white; 
                                      padding: 8px 16px; border-radius: 6px; text-decoration: none; font-weight: 600;
                                      border: 1px solid rgba(255,255,255,0.3); transition: all 0.3s ease; font-size: 14px;>
                                🤖 Reddit
                            </a>
                        </div>
                    </div>
                    
                    <!-- Buy Me a Coffee -->
                    <div>
                        <h4 style="color: white; margin-bottom: 15px; font-size: 16px;">Support development:</h4>
                        <a href="https://www.buymeacoffee.com/d57udy" target="_blank" rel="noopener noreferrer"
                           style="display: inline-block; background: #FFDD00; color: #000; 
                                  padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 600;
                                  border: none; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                            ☕ Buy me a coffee
                        </a>
                    </div>
                    
                    <p style="font-size: 13px; margin-top: 15px; margin-bottom: 0; opacity: 0.8;">
                        Your support helps keep this tool free and continuously improved.
                    </p>
                </div>

                <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                    <h3 style="margin-top: 0; color: #1d1d1f;">Important Disclaimer</h3>
                    <p style="line-height: 1.6; color: #666; font-size: 14px; margin-bottom: 15px;">
                        This calculator is designed for <strong>educational and planning purposes only</strong> and is 
                        <strong>not professional financial advice</strong>. While extensively validated against industry 
                        standards, <strong>there are no guarantees</strong> regarding the accuracy of calculations or 
                        their applicability to your specific situation.
                    </p>
                    <p style="line-height: 1.6; color: #666; font-size: 14px; margin-bottom: 15px;">
                        Always consult qualified professionals including real estate agents, mortgage brokers, tax advisors, 
                        and financial planners before making property purchase decisions. The authors assume no liability 
                        for financial decisions made based on this tool.
                    </p>
                    <p style="line-height: 1.6; color: #333; font-size: 14px; margin-bottom: 0; text-align: center; 
                       font-style: italic;">
                        This tool was built with ❤️ to help the Swiss community make informed real estate decisions.
                    </p>
                </div>

                <div style="text-align: center; color: #999; font-size: 12px; border-top: 1px solid #eee; 
                            margin-top: 30px; padding-top: 20px;">
                    <p style="margin: 0 0 10px 0;">
                        Swiss Rent vs Buy Calculator v<span id="footer-version">2.1.0</span> • 
                        Created with ❤️ for the Swiss real estate community<br>
                        Independent implementation • Not affiliated with any Swiss financial institution
                    </p>
                    <p style="margin: 0; font-size: 11px;">
                        Licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer"
                        style="color: #007aff; text-decoration: none;">CC BY-NC-SA 4.0</a> • 
                        Attribution required • ShareAlike derivatives
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script src="calculator.js"></script>
    <script>
        // Auto-calculation functions
        function updateCalculatedFields() {
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
            const monthlyRent = parseFloat(document.getElementById('monthlyRent').value) || 0;
            const amortizationYears = parseFloat(document.getElementById('amortizationYears').value) || 10;
            
            // Handle down payment modes
            const downPaymentMode = document.querySelector('input[name="downPaymentMode"]:checked').value;
            let downPayment = 0;
            let actualMortgageAmount = 0;
            let showWarning = false;
            
            if (downPaymentMode === 'auto') {
                // Auto down payment (20%)
                downPayment = Math.round(purchasePrice * 0.2);
                document.getElementById('downPayment').value = downPayment;
                document.getElementById('downPayment').disabled = true;
                document.getElementById('downPaymentInput').style.display = 'block';
                document.getElementById('mortgageAmountInput').style.display = 'none';
            } else if (downPaymentMode === 'manual') {
                // Manual down payment with 20% minimum validation
                downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
                const minDownPayment = Math.round(purchasePrice * 0.2);
                if (downPayment < minDownPayment && purchasePrice > 0) {
                    downPayment = minDownPayment;
                    document.getElementById('downPayment').value = downPayment;
                    showWarning = true;
                }
                document.getElementById('downPayment').disabled = false;
                document.getElementById('downPaymentInput').style.display = 'block';
                document.getElementById('mortgageAmountInput').style.display = 'none';
            } else if (downPaymentMode === 'mortgage') {
                // Maximize mortgage up to 80% of purchase price, but below specified limit
                const maxMortgageLimit = parseFloat(document.getElementById('mortgageAmount').value) || 0;
                const ltvCap = 0.8;
                const ltvCapAmount = Math.round(purchasePrice * ltvCap);
                actualMortgageAmount = Math.min(maxMortgageLimit, ltvCapAmount);
                downPayment = purchasePrice - actualMortgageAmount;
                const minDownPayment = Math.round(purchasePrice * (1 - ltvCap));
                if (downPayment < minDownPayment && purchasePrice > 0) {
                    downPayment = minDownPayment;
                    actualMortgageAmount = purchasePrice - downPayment;
                    showWarning = true;
                }
                
                document.getElementById('downPayment').value = downPayment;
                document.getElementById('downPayment').disabled = true;
                document.getElementById('downPaymentInput').style.display = 'block';
                document.getElementById('mortgageAmountInput').style.display = 'block';
            } else if (downPaymentMode === 'mortgage66') {
                // Maximize mortgage up to 66.6% of purchase price, but below specified limit (no 2nd rank)
                const maxMortgageLimit = parseFloat(document.getElementById('mortgageAmount').value) || 0;
                const ltvCap = 2/3; // 66.6%
                const ltvCapAmount = Math.round(purchasePrice * ltvCap);
                actualMortgageAmount = Math.min(maxMortgageLimit, ltvCapAmount);
                downPayment = purchasePrice - actualMortgageAmount; // ≥ 33.4%
                
                document.getElementById('downPayment').value = downPayment;
                document.getElementById('downPayment').disabled = true;
                document.getElementById('downPaymentInput').style.display = 'block';
                document.getElementById('mortgageAmountInput').style.display = 'block';
            }
            
            // Show/hide warning
            document.getElementById('downPaymentWarning').style.display = showWarning ? 'block' : 'none';
            
            // Calculate final mortgage amount for other calculations
            const finalMortgageAmount = purchasePrice - downPayment;
            
            // Auto maintenance (1.25%)
            if (document.getElementById('autoMaintenance').checked) {
                document.getElementById('annualMaintenanceCosts').value = Math.round(purchasePrice * 0.0125);
                document.getElementById('annualMaintenanceCosts').disabled = true;
            } else {
                document.getElementById('annualMaintenanceCosts').disabled = false;
            }
            
            // Handle amortization modes
            const amortizationMode = document.querySelector('input[name="amortizationMode"]:checked').value;
            
            if (amortizationMode === 'auto') {
                // Standard calculation: mortgage ÷ amortization period
                document.getElementById('annualAmortization').value = Math.round(finalMortgageAmount / amortizationYears);
                document.getElementById('annualAmortization').disabled = true;
            } else if (amortizationMode === 'swiss') {
                // Swiss regulation: amortize to 66.6% (2/3) LTV within 15 years
                const currentLTV = finalMortgageAmount / purchasePrice;
                const targetLTV = 2/3; // 66.6%
                
                if (currentLTV > targetLTV) {
                    // Calculate amount needed to amortize down to 66.6% LTV
                    const targetMortgageAmount = purchasePrice * targetLTV;
                    const amortizationNeeded = finalMortgageAmount - targetMortgageAmount;
                    // Divide by 15 years (Swiss regulation requirement)
                    const swissAnnualAmortization = Math.round(amortizationNeeded / 15);
                    document.getElementById('annualAmortization').value = swissAnnualAmortization;
                } else {
                    // If already at or below 66.6% LTV, no mandatory amortization required
                    document.getElementById('annualAmortization').value = 0;
                }
                document.getElementById('annualAmortization').disabled = true;
            } else {
                // Manual mode
                document.getElementById('annualAmortization').disabled = false;
            }
            
            // Auto imputed rental (65% of annual rent)
            if (document.getElementById('autoImputedRental').checked) {
                document.getElementById('imputedRentalValue').value = Math.round(monthlyRent * 12 * 0.65);
                document.getElementById('imputedRentalValue').disabled = true;
            } else {
                document.getElementById('imputedRentalValue').disabled = false;
            }
        }
        
        // Tab functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tabName).classList.add('active');
            });
        });

        // Auto-calculation event listeners
        document.getElementById('purchasePrice').addEventListener('input', updateCalculatedFields);
        document.getElementById('downPayment').addEventListener('input', updateCalculatedFields);
        document.getElementById('mortgageAmount').addEventListener('input', updateCalculatedFields);
        document.getElementById('monthlyRent').addEventListener('input', updateCalculatedFields);
        document.getElementById('amortizationYears').addEventListener('input', updateCalculatedFields);
        
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateCalculatedFields);
        });
        
        document.querySelectorAll('input[name="downPaymentMode"]').forEach(radio => {
            radio.addEventListener('change', updateCalculatedFields);
        });
        
        document.querySelectorAll('input[name="amortizationMode"]').forEach(radio => {
            radio.addEventListener('change', updateCalculatedFields);
        });

        // Single calculation
        document.getElementById('calculateBtn').addEventListener('click', () => {
            const params = {
                purchasePrice: parseFloat(document.getElementById('purchasePrice').value),
                downPayment: parseFloat(document.getElementById('downPayment').value),
                mortgageRate: parseFloat(document.getElementById('mortgageRate').value) / 100,
                monthlyRent: parseFloat(document.getElementById('monthlyRent').value),
                propertyAppreciationRate: parseFloat(document.getElementById('propertyAppreciation').value) / 100,
                investmentYieldRate: parseFloat(document.getElementById('investmentYield').value) / 100,
                marginalTaxRate: parseFloat(document.getElementById('marginalTaxRate').value) / 100,
                termYears: parseInt(document.getElementById('termYears').value),
                annualMaintenanceCosts: parseFloat(document.getElementById('annualMaintenanceCosts').value),
                amortizationYears: parseInt(document.getElementById('amortizationYears').value),
                annualAmortization: parseFloat(document.getElementById('annualAmortization').value),
                totalRenovations: parseFloat(document.getElementById('totalRenovations').value),
                additionalPurchaseCosts: parseFloat(document.getElementById('additionalPurchaseCosts').value),
                imputedRentalValue: parseFloat(document.getElementById('imputedRentalValue').value),
                propertyTaxDeductions: parseFloat(document.getElementById('propertyTaxDeductions').value),
                annualRentalCosts: parseFloat(document.getElementById('annualRentalCosts').value),
                scenarioMode: document.querySelector('input[name="scenarioMode"]:checked')?.value || 'equalConsumption'
            };

            const result = SwissRentBuyCalculator.calculate(params);
            displaySingleResult(result);
        });

        function displaySingleResult(result) {
            const resultsDiv = document.getElementById('singleResults');
            const decisionClass = result.Decision.toLowerCase();
            const modeText = result.ScenarioMode === 'equalSavings'
                ? 'Equal savings (amortization equivalent)'
                : (result.ScenarioMode === 'cashflowParity' ? 'Cash-flow parity' : 'Equal consumption');
            const modeInfo = result.ScenarioMode === 'equalSavings'
                ? 'Renter invests amortization-equivalent each year; gains taxed.'
                : (result.ScenarioMode === 'cashflowParity'
                    ? 'Renter invests the positive monthly difference and withdraws when negative; gains taxed.'
                    : 'Renter invests initial capital only (down payment + costs); gains taxed.');

            // Compute monthly comparison deltas
            const buyMonthly = result.TotalMonthlyExpenses || 0;
            const rentMonthly = result.TotalMonthlyRentingExpenses || 0;
            // Compare full monthly totals consistently (not rent-only)
            const buyVsRentDelta = Math.round(buyMonthly - rentMonthly);
            const rentVsBuyDelta = -buyVsRentDelta;

            // Compute break-even year (first year with cumulativeAdvantage >= 0 and previous < 0)
            let breakEvenYear = null;
            if (Array.isArray(result.YearlyBreakdown)) {
                for (let i = 0; i < result.YearlyBreakdown.length; i++) {
                    const curr = result.YearlyBreakdown[i].cumulativeAdvantage;
                    const prev = i > 0 ? result.YearlyBreakdown[i - 1].cumulativeAdvantage : null;
                    if ((prev !== null && prev < 0 && curr >= 0) || (i === 0 && curr >= 0)) {
                        breakEvenYear = result.YearlyBreakdown[i].year;
                        break;
                    }
                }
                if (!breakEvenYear) {
                    // fallback: year with minimal absolute advantage
                    let minAbs = Infinity;
                    result.YearlyBreakdown.forEach(y => {
                        const a = Math.abs(y.cumulativeAdvantage);
                        if (a < minAbs) { minAbs = a; breakEvenYear = y.year; }
                    });
                }
            }

            // Build collapsible section helper
            function section(title, color, id, inner) {
                return `
                <div class="collapsible" style="margin-bottom: 16px; background: white; border: 1px solid #e5e5ea; border-left: 4px solid ${color}; border-radius: 8px; overflow: hidden;">
                    <div class="collapsible-header" data-target="${id}" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; background: #f8f9fa;">
                        <div style="font-weight: 600; color: #1d1d1f;">${title}</div>
                        <div style="color: #6c757d; font-size: 12px;">Click to expand/collapse</div>
                    </div>
                    <div id="${id}" class="collapsible-body" style="padding: 14px;">
                        ${inner}
                    </div>
                </div>`;
            }

            // Summary with mode badge
            const summary = `
                <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                    <div style="flex: 1; padding: 16px; background: white; border-radius: 8px; border-left: 4px solid ${decisionClass === 'buy' ? '#34c759' : decisionClass === 'rent' ? '#ff3b30' : '#ff9500'};">
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: ${decisionClass === 'buy' ? '#34c759' : decisionClass === 'rent' ? '#ff3b30' : '#ff9500'};">${result.Decision}</div>
                        <div style="font-size: 15px; color: #1d1d1f;">${result.CompareText}</div>
                    </div>
                    <div title="${modeInfo}" style="white-space: nowrap; font-size: 12px; color: #1d1d1f; background: #f2f2f7; border: 1px solid #e5e5ea; padding: 8px 10px; border-radius: 999px;">Mode: <strong>${modeText}</strong></div>
                </div>`;

            // Monthly snapshot side-by-side
            const buyDeltaText = buyVsRentDelta >= 0 ? `+CHF ${buyVsRentDelta.toLocaleString()}` : `CHF ${Math.abs(buyVsRentDelta).toLocaleString()} less`;
            const buyDeltaColor = buyVsRentDelta >= 0 ? '#ff3b30' : '#34c759';
            const rentDeltaText = rentVsBuyDelta >= 0 ? `+CHF ${rentVsBuyDelta.toLocaleString()}` : `CHF ${Math.abs(rentVsBuyDelta).toLocaleString()} less`;
            const rentDeltaColor = rentVsBuyDelta >= 0 ? '#ff3b30' : '#34c759';

            const monthlySnapshot = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px;">
                    <div style="padding: 14px; background: #f0f8ff; border: 1px solid #d6e9ff; border-radius: 8px;">
                        <div style="font-weight: 600; color: #007aff; margin-bottom: 8px;">Monthly (Buying)</div>
                        <div class="result-item" style="border-bottom: 1px solid #d2d2d7; margin-bottom: 8px;"><span>Interest</span><span>CHF ${result.MonthlyInterestPayment.toLocaleString()}</span></div>
                        <div class="result-item" style="border-bottom: 1px solid #d2d2d7; margin-bottom: 8px;"><span>Amortization</span><span>CHF ${result.MonthlyAmortizationPayment.toLocaleString()}</span></div>
                        <div class="result-item" style="border-bottom: 1px solid #d2d2d7; margin-bottom: 8px;"><span>Maintenance</span><span>CHF ${result.MonthlyMaintenanceCosts.toLocaleString()}</span></div>
                        <div class="result-item" style="font-weight: 600; color: #007aff;"><span>Total</span><span>CHF ${result.TotalMonthlyExpenses.toLocaleString()}</span></div>
                        <div class="result-item" style="margin-top: 6px; color: ${buyDeltaColor};"><span>vs Monthly Renting</span><span>${buyDeltaText}</span></div>
                    </div>
                    <div style="padding: 14px; background: #fff7e6; border: 1px solid #ffe3b3; border-radius: 8px;">
                        <div style="font-weight: 600; color: #ff9500; margin-bottom: 8px;">Monthly (Renting)</div>
                        <div class="result-item" style="border-bottom: 1px solid #d2d2d7; margin-bottom: 8px;"><span>Rent</span><span>CHF ${result.MonthlyRentPayment.toLocaleString()}</span></div>
                        <div class="result-item" style="border-bottom: 1px solid #d2d2d7; margin-bottom: 8px;"><span>Supplemental costs</span><span>CHF ${result.MonthlyRentalCosts.toLocaleString()}</span></div>
                        ${(result.ScenarioMode === 'equalSavings' || result.ScenarioMode === 'cashflowParity') ? `<div class="result-item" style="border-bottom: 1px solid #d2d2d7; margin-bottom: 8px;"><span>${result.ScenarioMode === 'cashflowParity' ? 'Investments / withdrawals (monthly difference)' : 'Investments (amortization equivalent)'}</span><span>${result.MonthlySavingsContribution >= 0 ? '' : '-'}CHF ${Math.abs(result.MonthlySavingsContribution).toLocaleString()}</span></div>` : ''}
                        <div class="result-item" style="font-weight: 600; color: #ff9500;"><span>Total</span><span>CHF ${result.TotalMonthlyRentingExpenses.toLocaleString()}</span></div>
                        <div class="result-item" style="margin-top: 6px; color: ${rentDeltaColor};"><span>vs Monthly Buying</span><span>${rentDeltaText}</span></div>
                    </div>
                </div>`;

            // Purchase breakdown
            const purchaseBreakdown = `
                <div class="result-item"><span>Interest costs</span><span>CHF ${Math.round(result.InterestCosts).toLocaleString()}.00</span></div>
                <div class="result-item"><span>Supplemental and maintenance costs</span><span>CHF ${Math.round(result.SupplementalMaintenanceCosts).toLocaleString()}.00</span></div>
                <div class="result-item"><span>Amortization</span><span>CHF ${Math.round(result.AmortizationCosts).toLocaleString()}.00</span></div>
                <div class="result-item"><span>Renovation expenses</span><span>CHF ${Math.round(result.RenovationExpenses).toLocaleString()}.00</span></div>
                <div class="result-item"><span>Additional purchase expenses</span><span>CHF ${Math.round(result.AdditionalPurchaseExpensesOutput).toLocaleString()}.00</span></div>
                <div class="result-item" style="font-weight: 600; background-color: #f0f8ff;"><span>General cost of purchase</span><span>CHF ${Math.round(result.GeneralCostOfPurchase).toLocaleString()}.00</span></div>
                <div class="result-item"><span>Tax difference to rental</span><span>CHF ${Math.round(result.TaxDifferenceToRental).toLocaleString()}.${Math.abs(Math.round((result.TaxDifferenceToRental % 1) * 100)).toString().padStart(2, '0')}</span></div>
                <div class="result-item"><span>Minus property value</span><span>CHF ${Math.round(result.MinusPropertyValue).toLocaleString()}.${Math.abs(Math.round((result.MinusPropertyValue % 1) * 100)).toString().padStart(2, '0')}</span></div>
                <div class="result-item"><span>Mortgage at end of period</span><span>CHF ${Math.round(result.MortgageAtEndOfRelevantTimePeriod).toLocaleString()}.00</span></div>
                <div class="result-item" style="font-weight: 600; background-color: #f0f8ff;"><span>Total purchase cost</span><span>CHF ${Math.round(result.TotalPurchaseCost).toLocaleString()}.${Math.abs(Math.round((result.TotalPurchaseCost % 1) * 100)).toString().padStart(2, '0')}</span></div>`;

            // Rent breakdown
            const rentBreakdown = `
                <div class="result-item"><span>General cost of rental</span><span>CHF ${Math.round(result.GeneralCostOfRental).toLocaleString()}.00</span></div>
                <div class="result-item"><span>Excluding yields on assets</span><span>CHF ${Math.round(result.ExcludingYieldsOnAssets).toLocaleString()}.${Math.abs(Math.round((result.ExcludingYieldsOnAssets % 1) * 100)).toString().padStart(2, '0')}</span></div>
                ${(result.ScenarioMode === 'equalSavings' || result.ScenarioMode === 'cashflowParity') ? `<div class="result-item"><span>Excluding savings contributions</span><span>CHF ${Math.round(result.ExcludingSavingsContributions).toLocaleString()}.00</span></div>` : ''}
                <div class="result-item"><span>Excluding down-payment</span><span>CHF ${Math.round(result.ExcludingDownPayment).toLocaleString()}.00</span></div>
                <div class="result-item" style="font-weight: 600; background-color: #f0f8ff;"><span>Total rental cost</span><span>CHF ${Math.round(result.TotalRentalCost).toLocaleString()}.${Math.abs(Math.round((result.TotalRentalCost % 1) * 100)).toString().padStart(2, '0')}</span></div>`;

            // Year by Year (collapsed by default) and quick jump
            const showAdvancedId = 'toggle-advanced-cols';
            const prevAdv = document.getElementById(showAdvancedId);
            const showAdvanced = prevAdv ? prevAdv.checked : true;
            const yearRows = result.YearlyBreakdown.map((y, index) => {
                const rowId = `year-row-${y.year}`;
                return `
                <tr id="${rowId}" style="border-bottom: 1px solid #dee2e6; ${index % 2 === 0 ? 'background: #f8f9fa;' : 'background: white;'}">
                    <td style="padding: 10px 8px; font-weight: 600;">${y.year}</td>
                    <td style="padding: 10px 8px; text-align: right;">${Math.round(y.endingBalance).toLocaleString()}</td>
                    <td style="padding: 10px 8px; text-align: right;">${Math.round(y.annualInterest).toLocaleString()}</td>
                    <td style="padding: 10px 8px; text-align: right;">${Math.round(y.annualAmortization).toLocaleString()}</td>
                    <td style="padding: 10px 8px; text-align: right;">${Math.round(y.annualMaintenance).toLocaleString()}</td>
                    <td style="padding: 10px 8px; text-align: right;">${Math.round(y.annualRent).toLocaleString()}</td>
                    ${showAdvanced ? `<td style=\"padding: 10px 8px; text-align: right;\">${(y.renterContribution >= 0 ? '' : '-')} ${Math.abs(Math.round(y.renterContribution || 0)).toLocaleString()}</td>` : ''}
                    ${showAdvanced ? `<td style=\"padding: 10px 8px; text-align: right;\">${(y.cumulativeRenterPrincipal >= 0 ? '' : '-')} ${Math.abs(Math.round(y.cumulativeRenterPrincipal || 0)).toLocaleString()}</td>` : ''}
                    ${showAdvanced ? `<td style=\"padding: 10px 8px; text-align: right;\">${Math.round(y.investmentGainsThisYear || 0).toLocaleString()}</td>` : ''}
                    ${showAdvanced ? `<td style=\"padding: 10px 8px; text-align: right;\">${Math.round(y.cumulativeInvestmentGains || 0).toLocaleString()}</td>` : ''}
                    ${showAdvanced ? `<td title=\"Tax on renter investment income (renter)\" style=\"padding: 10px 8px; text-align: right;\">${Math.round(y.investmentIncomeTaxThisYear || 0).toLocaleString()}</td>` : ''}
                    ${showAdvanced ? `<td title=\"Owner tax: imputed rent (positive)\" style=\"padding: 10px 8px; text-align: right;\">${Math.round(y.taxImputedRent || 0).toLocaleString()}</td>` : ''}
                    ${showAdvanced ? `<td title=\"Owner tax savings: mortgage interest (negative)\" style=\"padding: 10px 8px; text-align: right;\">${Math.round(y.taxSavingsInterest || 0).toLocaleString()}</td>` : ''}
                    ${showAdvanced ? `<td title=\"Owner tax savings: property expenses (negative)\" style=\"padding: 10px 8px; text-align: right;\">${Math.round(y.taxSavingsPropertyExpenses || 0).toLocaleString()}</td>` : ''}
                    ${showAdvanced ? `<td style=\"padding: 10px 8px; text-align: right;\">${Math.round(y.portfolioValueEndOfYear || 0).toLocaleString()}</td>` : ''}
                    ${showAdvanced ? `<td style=\"padding: 10px 8px; text-align: right;\">${Math.round(y.propertyValueEndOfYear || 0).toLocaleString()}</td>` : ''}
                    ${showAdvanced ? `<td style=\"padding: 10px 8px; text-align: right;\">${Math.round(y.homeownerEquityEndOfYear || 0).toLocaleString()}</td>` : ''}
                    ${showAdvanced ? `<td style=\"padding: 10px 8px; text-align: right;\">${(y.ltvPercentEndOfYear || 0).toFixed(1)}%</td>` : ''}
                    <td style="padding: 10px 8px; text-align: right; ${y.totalPurchaseCostToDate < 0 ? 'color: #28a745; font-weight: 600;' : 'color: #dc3545;'}">${y.totalPurchaseCostToDate >= 0 ? '' : '-'}${Math.abs(Math.round(y.totalPurchaseCostToDate)).toLocaleString()}</td>
                    <td style="padding: 10px 8px; text-align: right; ${y.totalRentalCostToDate < 0 ? 'color: #28a745; font-weight: 600;' : 'color: #dc3545;'}">${y.totalRentalCostToDate >= 0 ? '' : '-'}${Math.abs(Math.round(y.totalRentalCostToDate)).toLocaleString()}</td>
                    <td style="padding: 10px 8px; text-align: right; font-weight: 600; ${y.cumulativeAdvantage > 0 ? 'color: #28a745;' : y.cumulativeAdvantage < 0 ? 'color: #dc3545;' : 'color: #6c757d;'}"><span style="font-size: 11px; margin-right: 4px;">${y.cumulativeAdvantage > 0 ? 'BUY' : y.cumulativeAdvantage < 0 ? 'RENT' : 'EVEN'}</span>${y.cumulativeAdvantage >= 0 ? '+' : ''}${Math.round(y.cumulativeAdvantage).toLocaleString()}</td>
                    ${showAdvanced ? `<td style=\"padding: 10px 8px; text-align: right; color: #6c757d;\">${(y.advantageDeltaFromPriorYear || 0) >= 0 ? '+' : ''}${Math.round(y.advantageDeltaFromPriorYear || 0).toLocaleString()}</td>` : ''}
                </tr>`;
            }).join('');

            const yearByYear = `
                <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 8px;">
                    <div style="font-weight:600; color:#1d1d1f;">Year-by-Year Analysis</div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <label style="font-size:12px; color:#1d1d1f; display:flex; align-items:center; gap:6px;">
                            <input type="checkbox" id="${showAdvancedId}" ${showAdvanced ? 'checked' : ''}>
                            <span>Show advanced columns</span>
                        </label>
                        ${breakEvenYear ? `<button id="jumpBreakEvenBtn" class="button secondary" style="padding:6px 10px; font-size:12px;">Jump to break-even (or closest, Year ${breakEvenYear})</button>` : ''}
                        <button id="downloadYearlyCsvBtn" class="button secondary" style="padding:6px 10px; font-size:12px;">Download Year-by-Year CSV</button>
                    </div>
                </div>
                <div style="overflow-x: auto; margin-bottom: 12px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 14px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: #495057;">Year</th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;">Mortgage Balance<br><small style="font-size: 11px; color: #6c757d;">(CHF)</small></th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;">Interest<br><small style="font-size: 11px; color: #6c757d;">(CHF)</small></th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;">Amortization<br><small style="font-size: 11px; color: #6c757d;">(CHF)</small></th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;">Maintenance<br><small style="font-size: 11px; color: #6c757d;">(CHF)</small></th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;">Annual Rent<br><small style="font-size: 11px; color: #6c757d;">(CHF)</small></th>
                                ${showAdvanced ? `<th style=\"padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;\">Renter Contrib.<br><small style=\"font-size: 11px; color: #6c757d;\">(CHF)</small></th>` : ''}
                                ${showAdvanced ? `<th style=\"padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;\">Cum. Renter Principal<br><small style=\"font-size: 11px; color: #6c757d;\">(CHF)</small></th>` : ''}
                                ${showAdvanced ? `<th style=\"padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;\">Gains (Year)<br><small style=\"font-size: 11px; color: #6c757d;\">(CHF)</small></th>` : ''}
                                ${showAdvanced ? `<th style=\"padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;\">Gains (Cum.)<br><small style=\"font-size: 11px; color: #6c757d;\">(CHF)</small></th>` : ''}
                                ${showAdvanced ? `<th style=\"padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;\">Tax on Gains (Renter, Year)<br><small style=\"font-size: 11px; color: #6c757d;\">(CHF)</small></th>` : ''}
                                ${showAdvanced ? `<th style=\"padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;\">Imputed Rent Tax (Owner)<br><small style=\"font-size: 11px; color: #6c757d;\">(CHF)</small></th>` : ''}
                                ${showAdvanced ? `<th style=\"padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;\">Interest Deduction (Owner)<br><small style=\"font-size: 11px; color: #6c757d;\">(CHF)</small></th>` : ''}
                                ${showAdvanced ? `<th style=\"padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;\">Expense Deduction (Owner)<br><small style=\"font-size: 11px; color: #6c757d;\">(CHF)</small></th>` : ''}
                                ${showAdvanced ? `<th style=\"padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;\">Portfolio (End)<br><small style=\"font-size: 11px; color: #6c757d;\">(CHF)</small></th>` : ''}
                                ${showAdvanced ? `<th style=\"padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;\">Property Value (End)<br><small style=\"font-size: 11px; color: #6c757d;\">(CHF)</small></th>` : ''}
                                ${showAdvanced ? `<th style=\"padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;\">Equity (End)<br><small style=\"font-size: 11px; color: #6c757d;\">(CHF)</small></th>` : ''}
                                ${showAdvanced ? `<th style=\"padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;\">LTV (End)<br><small style=\"font-size: 11px; color: #6c757d;\">(%)</small></th>` : ''}
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;">Cumulative<br>Buy Cost<br><small style="font-size: 11px; color: #6c757d;">(CHF)</small></th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;">Cumulative<br>Rent Cost<br><small style="font-size: 11px; color: #6c757d;">(CHF)</small></th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;">Advantage<br><small style="font-size: 11px; color: #6c757d;">(CHF)</small></th>
                                ${showAdvanced ? `<th style=\"padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;\">Advantage Δ<br><small style=\"font-size: 11px; color: #6c757d;\">(CHF)</small></th>` : ''}
                            </tr>
                        </thead>
                        <tbody>
                            ${yearRows}
                        </tbody>
                    </table>
                </div>
                <div style="background: #f0f8ff; padding: 12px; border-radius: 8px; font-size: 13px; line-height: 1.5;">
                    <strong>How to read this table:</strong>
                    <ul style="margin: 6px 0 0 18px; padding: 0;">
                        <li><strong>Year</strong>: 1..T.</li>
                        <li><strong>Mortgage Balance (CHF)</strong>: Remaining debt at year end after paying interest and, if within the amortization period, principal for that year.</li>
                        <li><strong>Interest (CHF)</strong>: Interest on the starting balance of the year using the mortgage rate (declining-balance method).</li>
                        <li><strong>Amortization (CHF)</strong>: Principal reduction paid this year. Zero after the amortization period.</li>
                        <li><strong>Maintenance (CHF)</strong>: Annual property maintenance costs.</li>
                        <li><strong>Annual Rent (CHF)</strong>: 12 × monthly rent.</li>
                        <li><strong>Renter Contrib. (CHF)</strong>: Mode‑aware savings/withdrawals:
                            <ul style="margin: 4px 0 0 18px;">
                                <li><em>Equal consumption</em>: 0.</li>
                                <li><em>Cash‑flow parity</em>: (buyer cash outlay − renter cash outlay) × 12; negative = withdrawal.</li>
                                <li><em>Equal savings</em>: annual amortization amount (during amortization years).</li>
                            </ul>
                        </li>
                        <li><strong>Cum. Renter Principal (CHF)</strong>: Algebraic sum of renter contributions to date (savings minus withdrawals), excluding the initial investable amount (down payment + purchase costs).</li>
                        <li><strong>Gains (Year) (CHF)</strong>: Investment gains this year = portfolio at start of year × investment yield.</li>
                        <li><strong>Gains (Cum.) (CHF)</strong>: Sum of yearly gains up to this year.</li>
                        <li><strong>Tax on Gains (Renter, Year) (CHF)</strong>: Renter investment income tax this year = Gains (Year) × marginal tax rate.</li>
                        <li><strong>Imputed Rent Tax (Owner) (CHF)</strong>: Imputed rental value × marginal tax rate.</li>
                        <li><strong>Interest Deduction (Owner) (CHF)</strong>: Mortgage interest × marginal tax rate (shown as positive number but treated as a tax saving).</li>
                        <li><strong>Expense Deduction (Owner) (CHF)</strong>: Property expense deduction × marginal tax rate (shown as positive number but treated as a tax saving).</li>
                        <li><strong>Portfolio (End) (CHF)</strong>: Renter’s end‑of‑year portfolio = prior portfolio + gains (Year) + renter contribution.</li>
                        <li><strong>Property Value (End) (CHF)</strong>: Purchase price × (1 + appreciation)^Year.</li>
                        <li><strong>Equity (End) (CHF)</strong>: Property Value (End) − Mortgage Balance.</li>
                        <li><strong>LTV (End) (%)</strong>: Mortgage Balance ÷ Property Value (End) × 100.</li>
                        <li><strong>Cumulative Buy Cost (CHF)</strong>: Down payment + purchase costs + Σ(interest + amortization + maintenance + net tax difference) − Property Value (to date) + Mortgage Balance (to date).</li>
                        <li><strong>Cumulative Rent Cost (CHF)</strong>: Σ(rent + rental costs) − Investment gains (to date) + Tax on gains (to date) − Down payment − Cum. Renter Principal.</li>
                        <li><strong>Advantage (CHF)</strong>: Cumulative Rent Cost − Cumulative Buy Cost. Positive favors buying; negative favors renting.</li>
                        <li><strong>Advantage Δ (CHF)</strong>: Year‑over‑year change in Advantage.</li>
                    </ul>
                </div>`;

            // Assemble sections (with collapsibles)
            const content = [
                summary,
                section('Monthly Cash Flow', '#007aff', 'section-monthly', monthlySnapshot),
                section('Breakdown of purchase costs', '#34c759', 'section-purchase', purchaseBreakdown),
                section('Rent', '#ff3b30', 'section-rent', rentBreakdown),
                section('Year-by-Year Analysis', '#007aff', 'section-yyy', yearByYear)
            ].join('');

            resultsDiv.innerHTML = content;
            resultsDiv.style.display = 'block';

            // Collapsible behavior: collapse Year-by-Year by default
            const yyyBody = document.getElementById('section-yyy');
            if (yyyBody) yyyBody.style.display = 'block';

            // Add click listeners
            resultsDiv.querySelectorAll('.collapsible-header').forEach(h => {
                h.addEventListener('click', () => {
                    const targetId = h.getAttribute('data-target');
                    const body = document.getElementById(targetId);
                    if (body) body.style.display = (body.style.display === 'none') ? 'block' : 'none';
                });
            });

            // Jump to break-even button
            const jumpBtn = document.getElementById('jumpBreakEvenBtn');
            if (jumpBtn && breakEvenYear) {
                jumpBtn.addEventListener('click', () => {
                    const row = document.getElementById(`year-row-${breakEvenYear}`);
                    if (row) {
                        // ensure section open
                        if (yyyBody && yyyBody.style.display === 'none') yyyBody.style.display = 'block';
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        row.style.outline = '2px solid #007aff';
                        setTimeout(() => { row.style.outline = 'none'; }, 1500);
                    }
                });
            }

            // Basic toggle re-render
            const advToggle = document.getElementById(showAdvancedId);
            if (advToggle) {
                advToggle.addEventListener('change', () => displaySingleResult(result));
            }

            // Download Year-by-Year CSV
            const dlBtn = document.getElementById('downloadYearlyCsvBtn');
            if (dlBtn) {
                dlBtn.addEventListener('click', () => {
                    const rows = result.YearlyBreakdown.map(y => ({
                        year: y.year,
                        mortgageBalance: Math.round(y.endingBalance),
                        interest: Math.round(y.annualInterest),
                        amortization: Math.round(y.annualAmortization),
                        maintenance: Math.round(y.annualMaintenance),
                        annualRent: Math.round(y.annualRent),
                        renterContribution: Math.round(y.renterContribution || 0),
                        cumulativeRenterPrincipal: Math.round(y.cumulativeRenterPrincipal || 0),
                        gainsYear: Math.round(y.investmentGainsThisYear || 0),
                        gainsCumulative: Math.round(y.cumulativeInvestmentGains || 0),
                        taxOnGainsYear: Math.round(y.investmentIncomeTaxThisYear || 0),
                        portfolioEnd: Math.round(y.portfolioValueEndOfYear || 0),
                        propertyValueEnd: Math.round(y.propertyValueEndOfYear || 0),
                        equityEnd: Math.round(y.homeownerEquityEndOfYear || 0),
                        ltvEndPercent: (y.ltvPercentEndOfYear || 0).toFixed(1),
                        cumulativeBuyCost: Math.round(y.totalPurchaseCostToDate),
                        cumulativeRentCost: Math.round(y.totalRentalCostToDate),
                        advantage: Math.round(y.cumulativeAdvantage),
                        advantageDelta: Math.round(y.advantageDeltaFromPriorYear || 0)
                    }));
                    const headers = Object.keys(rows[0]);
                    const csv = [headers.join(','), ...rows.map(r => headers.map(h => r[h]).join(','))].join('\n');
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `year_by_year_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
            }
        }

        // Helper function to calculate auto-fields based on a test purchase price
        function getParametersWithAutoCalculations(testPurchasePrice) {
            const monthlyRent = parseFloat(document.getElementById('monthlyRent').value);
            const amortizationYears = parseInt(document.getElementById('amortizationYears').value);
            
            // Start with base parameters
            const params = {
                purchasePrice: testPurchasePrice,
                mortgageRate: parseFloat(document.getElementById('mortgageRate').value) / 100,
                monthlyRent: monthlyRent,
                propertyAppreciationRate: parseFloat(document.getElementById('propertyAppreciation').value) / 100,
                investmentYieldRate: parseFloat(document.getElementById('investmentYield').value) / 100,
                marginalTaxRate: parseFloat(document.getElementById('marginalTaxRate').value) / 100,
                termYears: parseInt(document.getElementById('termYears').value),
                amortizationYears: amortizationYears,
                totalRenovations: parseFloat(document.getElementById('totalRenovations').value),
                propertyTaxDeductions: parseFloat(document.getElementById('propertyTaxDeductions').value),
                annualRentalCosts: parseFloat(document.getElementById('annualRentalCosts').value),
                additionalPurchaseCosts: parseFloat(document.getElementById('additionalPurchaseCosts').value),
                scenarioMode: document.querySelector('input[name="scenarioMode"]:checked')?.value || 'equalConsumption'
            };
            
            // Handle down payment modes with 20% minimum enforcement
            const downPaymentMode = document.querySelector('input[name="downPaymentMode"]:checked').value;
            let downPayment = 0;
            
            if (downPaymentMode === 'auto') {
                // Auto: mortgage 80%, down payment 20%
                downPayment = Math.round(testPurchasePrice * 0.2);
            } else if (downPaymentMode === 'manual') {
                // Manual down payment with 20% minimum validation
                downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
                const minDownPayment = Math.round(testPurchasePrice * 0.2);
                if (downPayment < minDownPayment) {
                    downPayment = minDownPayment;
                }
            } else if (downPaymentMode === 'mortgage') {
                // Maximize mortgage up to 80% LTV, but below specified limit
                const maxMortgageLimit = parseFloat(document.getElementById('mortgageAmount').value) || 0;
                const ltvCapAmount = Math.round(testPurchasePrice * 0.8);
                const actualMortgageAmount = Math.min(maxMortgageLimit, ltvCapAmount);
                downPayment = testPurchasePrice - actualMortgageAmount;
            } else if (downPaymentMode === 'mortgage66') {
                // Maximize mortgage up to 66.6% LTV, but below specified limit
                const maxMortgageLimit = parseFloat(document.getElementById('mortgageAmount').value) || 0;
                const ltvCapAmount = Math.round(testPurchasePrice * (2/3));
                const actualMortgageAmount = Math.min(maxMortgageLimit, ltvCapAmount);
                downPayment = testPurchasePrice - actualMortgageAmount;
            }
            
            params.downPayment = downPayment;
            
            // Handle auto-calculated fields based on checkbox states
            if (document.getElementById('autoMaintenance').checked) {
                params.annualMaintenanceCosts = Math.round(testPurchasePrice * 0.0125);
            } else {
                params.annualMaintenanceCosts = parseFloat(document.getElementById('annualMaintenanceCosts').value);
            }
            
            // Handle amortization modes
            const amortizationMode = document.querySelector('input[name="amortizationMode"]:checked').value;
            const mortgageAmount = testPurchasePrice - params.downPayment;
            
            if (amortizationMode === 'auto') {
                params.annualAmortization = Math.round(mortgageAmount / amortizationYears);
            } else if (amortizationMode === 'swiss') {
                // Swiss regulation: amortize to 65% LTV within 15 years
                const currentLTV = mortgageAmount / testPurchasePrice;
                const targetLTV = 0.65;
                
                if (currentLTV > targetLTV) {
                    const targetMortgageAmount = testPurchasePrice * targetLTV;
                    const amortizationNeeded = mortgageAmount - targetMortgageAmount;
                    params.annualAmortization = Math.round(amortizationNeeded / 15);
                } else {
                    params.annualAmortization = 0;
                }
            } else {
                params.annualAmortization = parseFloat(document.getElementById('annualAmortization').value);
            }
            
            if (document.getElementById('autoImputedRental').checked) {
                params.imputedRentalValue = Math.round(monthlyRent * 12 * 0.65);
            } else {
                params.imputedRentalValue = parseFloat(document.getElementById('imputedRentalValue').value);
            }
            
            return params;
        }

        // Break-even finder
        document.getElementById('breakevenBtn').addEventListener('click', () => {
            // Create a custom findBreakevenPrice that handles auto-calculations
            const options = {
                minPrice: parseFloat(document.getElementById('beMinPrice').value),
                maxPrice: parseFloat(document.getElementById('beMaxPrice').value),
                tolerance: parseFloat(document.getElementById('beTolerance').value)
            };
            
            // Store original purchase price for comparison
            const originalPurchasePrice = parseFloat(document.getElementById('purchasePrice').value);
            
            // Custom binary search with proper auto-calculations
            let low = options.minPrice;
            let high = options.maxPrice;
            let iterations = 0;
            let bestResult = null;
            let bestDifference = Infinity;
            const tolerance = options.tolerance;
            const maxIterations = 1000;
            
            while (low <= high && iterations < maxIterations) {
                const testPrice = Math.round((low + high) / 2);
                const params = getParametersWithAutoCalculations(testPrice);
                
                const result = SwissRentBuyCalculator.calculate(params);
                const difference = Math.abs(result.ResultValue);
                
                if (difference < bestDifference) {
                    bestDifference = difference;
                    bestResult = {
                        breakevenFound: difference <= tolerance,
                        breakevenPrice: testPrice,
                        resultValue: result.ResultValue,
                        decision: result.Decision,
                        difference: difference,
                        originalPrice: originalPurchasePrice,
                        priceDifference: testPrice - originalPurchasePrice
                    };
                }
                
                if (difference <= tolerance) {
                    break;
                }
                
                if (result.ResultValue > 0) {
                    low = testPrice + 1;
                } else {
                    high = testPrice - 1;
                }
                
                iterations++;
            }
            
            if (bestResult) {
                bestResult.iterations = iterations;
                bestResult.message = bestResult.breakevenFound ? 
                    `Break-even found at ${bestResult.breakevenPrice.toLocaleString()} CHF` :
                    `Closest match found at ${bestResult.breakevenPrice.toLocaleString()} CHF (difference: ${bestResult.difference.toLocaleString()} CHF)`;
            }
            
            displayBreakevenResult(bestResult || {
                breakevenFound: false,
                message: `No break-even found in range ${options.minPrice.toLocaleString()}-${options.maxPrice.toLocaleString()} CHF`,
                iterations: iterations
            });
        });

        function displayBreakevenResult(result) {
            const resultsDiv = document.getElementById('breakevenResults');
            
            if (result.breakevenFound) {
                // Get detailed calculation with proper auto-calculations for the found price
                const detailedParams = getParametersWithAutoCalculations(result.breakevenPrice);
                const detailedResult = SwissRentBuyCalculator.calculate(detailedParams);
                
                // Calculate price difference information
                const priceDifference = result.priceDifference;
                const priceDifferenceText = priceDifference > 0 ? 
                    `CHF ${Math.abs(priceDifference).toLocaleString()} higher than current single calc price` :
                    `CHF ${Math.abs(priceDifference).toLocaleString()} lower than current single calc price`;
                
                resultsDiv.innerHTML = `
                    <div style="margin-bottom: 20px; padding: 20px; background: white; border-radius: 8px; border-left: 4px solid #34c759;">
                        <div class="result-item decision-even" style="font-size: 18px; font-weight: 600; margin-bottom: 10px; border-bottom: none;">
                            <span>Maximum Bid Price Found</span>
                            <span>CHF ${result.breakevenPrice.toLocaleString()}</span>
                        </div>
                        <div style="font-size: 16px; line-height: 1.4;">
                            <strong>At this price, buying and renting have equal total costs (break-even point)</strong><br>
                            <small>Break-even accuracy: ±CHF ${Math.abs(result.resultValue).toLocaleString()} (${result.iterations} iterations)</small><br>
                            <small>Price difference: ${priceDifferenceText}</small>
                        </div>
                    </div>
                    
                    <h4>Detailed Calculation Results at Maximum Bid Price</h4>
                    
                    <div class="result-item">
                        <span>Purchase Price:</span>
                        <span>CHF ${detailedResult.PurchasePrice.toLocaleString()}</span>
                    </div>
                    <div class="result-item">
                        <span>Down Payment:</span>
                        <span>CHF ${detailedResult.DownPayment.toLocaleString()}</span>
                    </div>
                    <div class="result-item">
                        <span>Mortgage Amount:</span>
                        <span>CHF ${detailedResult.MortgageAmount.toLocaleString()}</span>
                    </div>
                    <div class="result-item">
                        <span>Loan-to-Value Ratio:</span>
                        <span>${((detailedResult.MortgageAmount / detailedResult.PurchasePrice) * 100).toFixed(1)}%</span>
                    </div>
                    <div class="result-item">
                        <span>Interest Costs (${detailedResult.TermYears} years):</span>
                        <span>CHF ${Math.round(detailedResult.InterestCosts).toLocaleString()}</span>
                    </div>
                    <div class="result-item">
                        <span>Total Purchase Cost:</span>
                        <span>CHF ${Math.round(detailedResult.TotalPurchaseCost).toLocaleString()}</span>
                    </div>
                    <div class="result-item">
                        <span>Total Rental Cost:</span>
                        <span>CHF ${Math.round(detailedResult.TotalRentalCost).toLocaleString()}</span>
                    </div>
                    <div class="result-item">
                        <span>Net Financial Benefit:</span>
                        <span>CHF ${Math.round(detailedResult.ResultValue).toLocaleString()}</span>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #28a745;">
                        <strong>Verification:</strong> If you enter CHF ${result.breakevenPrice.toLocaleString()} as the purchase price in the Single Calculation tab, the financial benefit should be approximately CHF ${Math.round(detailedResult.ResultValue).toLocaleString()} (very close to zero).
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = `
                    <div style="padding: 15px; background: rgba(255, 59, 48, 0.1); border-radius: 8px; color: #ff3b30;">
                        <strong>${result.message}</strong>
                        <br>Search completed in ${result.iterations} iterations.
                        <br><br>Try adjusting the search price range or check your input parameters.
                    </div>
                `;
            }
            resultsDiv.style.display = 'block';
        }

        // Parameter sweep functionality
        let sweepData = [];

        function formatBidPrice(price) {
            if (!price || price <= 0) return 'N/A';
            
            if (price >= 1000000) {
                // Millions: 1.38M, 2.55M, etc.
                const millions = price / 1000000;
                if (millions >= 100) {
                    return Math.round(millions) + 'M';
                } else if (millions >= 10) {
                    return (Math.round(millions * 10) / 10) + 'M';
                } else {
                    return (Math.round(millions * 100) / 100) + 'M';
                }
            } else if (price >= 1000) {
                // Thousands: 786k, 1.25k, etc.
                const thousands = price / 1000;
                if (thousands >= 100) {
                    return Math.round(thousands) + 'k';
                } else {
                    return (Math.round(thousands * 10) / 10) + 'k';
                }
            } else {
                // Less than 1000, show as is
                return Math.round(price).toString();
            }
        }

        function runMaxBidPriceSweep(baseParams, sweepRanges) {
            const results = [];
            let totalCombinations = 0;
            let processedCombinations = 0;
            
            // Calculate total combinations for progress tracking
            const propRates = [];
            for (let val = sweepRanges.propertyAppreciationRate.min; val <= sweepRanges.propertyAppreciationRate.max; val += sweepRanges.propertyAppreciationRate.step) {
                propRates.push(val);
            }
            const invRates = [];
            for (let val = sweepRanges.investmentYieldRate.min; val <= sweepRanges.investmentYieldRate.max; val += sweepRanges.investmentYieldRate.step) {
                invRates.push(val);
            }
            const mortRates = [];
            for (let val = sweepRanges.mortgageRate.min; val <= sweepRanges.mortgageRate.max; val += sweepRanges.mortgageRate.step) {
                mortRates.push(val);
            }
            
            totalCombinations = propRates.length * invRates.length * mortRates.length;
            
            // Generate all parameter combinations and find max bid price for each
            propRates.forEach(propRate => {
                invRates.forEach(invRate => {
                    mortRates.forEach(mortRate => {
                        processedCombinations++;
                        
                        // Create parameters for this combination
                        const testParams = {
                            ...baseParams,
                            propertyAppreciationRate: propRate,
                            investmentYieldRate: invRate,
                            mortgageRate: mortRate
                        };
                        
                        // Find break-even price for this parameter combination using max bid tab settings
                        const options = {
                            minPrice: parseFloat(document.getElementById('beMinPrice').value) || 1500000,
                            maxPrice: parseFloat(document.getElementById('beMaxPrice').value) || 10000000,
                            tolerance: parseFloat(document.getElementById('beTolerance').value) || 2500,
                            maxIterations: 100  // Reduced for speed
                        };
                        
                        let maxBidPrice = null;
                        try {
                            // Use a simplified break-even finder for speed
                            let low = options.minPrice;
                            let high = options.maxPrice;
                            let iterations = 0;
                            let bestPrice = null;
                            let bestDifference = Infinity;
                            
                            while (low <= high && iterations < options.maxIterations) {
                                const testPrice = Math.round((low + high) / 2);
                                const paramsWithPrice = getParametersWithAutoCalculations(testPrice);
                                
                                // Override with sweep parameters
                                paramsWithPrice.propertyAppreciationRate = propRate;
                                paramsWithPrice.investmentYieldRate = invRate;
                                paramsWithPrice.mortgageRate = mortRate;
                                
                                const result = SwissRentBuyCalculator.calculate(paramsWithPrice);
                                const difference = Math.abs(result.ResultValue);
                                
                                if (difference < bestDifference) {
                                    bestDifference = difference;
                                    bestPrice = testPrice;
                                }
                                
                                if (difference <= options.tolerance) {
                                    break;
                                }
                                
                                if (result.ResultValue > 0) {
                                    low = testPrice + 1;
                                } else {
                                    high = testPrice - 1;
                                }
                                
                                iterations++;
                            }
                            
                            // Determine if we found a good break-even or hit search limits
                            if (bestDifference <= options.tolerance) {
                                // Found good break-even within tolerance
                                maxBidPrice = bestPrice;
                            } else {
                                // Didn't find good break-even - check if we're hitting search boundaries
                                
                                // Test the boundary conditions to see where the true max bid lies
                                const maxPriceParams = getParametersWithAutoCalculations(options.maxPrice);
                                maxPriceParams.propertyAppreciationRate = propRate;
                                maxPriceParams.investmentYieldRate = invRate;
                                maxPriceParams.mortgageRate = mortRate;
                                const maxPriceResult = SwissRentBuyCalculator.calculate(maxPriceParams);
                                
                                const minPriceParams = getParametersWithAutoCalculations(options.minPrice);
                                minPriceParams.propertyAppreciationRate = propRate;
                                minPriceParams.investmentYieldRate = invRate;
                                minPriceParams.mortgageRate = mortRate;
                                const minPriceResult = SwissRentBuyCalculator.calculate(minPriceParams);
                                
                                if (maxPriceResult.ResultValue > 0) {
                                    // Even at max price, buying is still cheaper - true max bid is above search range
                                    maxBidPrice = options.maxPrice; // Will be displayed as ">4M"
                                } else if (minPriceResult.ResultValue < 0) {
                                    // Even at min price, renting is still cheaper - true max bid is below search range
                                    maxBidPrice = options.minPrice; // Will be displayed as "<1.5M"
                                } else {
                                    // True max bid is somewhere in the range, use our best approximation
                                    // But if bestPrice is too close to boundaries, still indicate limit
                                    if (bestPrice >= options.maxPrice - 1000) {
                                        maxBidPrice = options.maxPrice; // Near max boundary
                                    } else if (bestPrice <= options.minPrice + 1000) {
                                        maxBidPrice = options.minPrice; // Near min boundary
                                    } else {
                                        maxBidPrice = bestPrice; // Use best approximation
                                    }
                                }
                            }
                            
                        } catch (error) {
                            console.warn(`Error calculating max bid for combination: prop=${propRate}, inv=${invRate}, mort=${mortRate}`, error);
                            maxBidPrice = null;
                        }
                        
                        // Store the result
                        // Calculate monthly costs for this combination using current purchase price
                        let monthlyExpenses = null;
                        try {
                            const currentPurchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 2000000;
                            const paramsForMonthly = getParametersWithAutoCalculations(currentPurchasePrice);
                            paramsForMonthly.propertyAppreciationRate = propRate;
                            paramsForMonthly.investmentYieldRate = invRate;
                            paramsForMonthly.mortgageRate = mortRate;
                            
                            const monthlyResult = SwissRentBuyCalculator.calculate(paramsForMonthly);
                            monthlyExpenses = monthlyResult.TotalMonthlyExpenses;
                        } catch (error) {
                            console.warn('Error calculating monthly expenses:', error);
                        }

                        results.push({
                            propertyAppreciationRate: propRate,
                            investmentYieldRate: invRate,
                            mortgageRate: mortRate,
                            maxBidPrice: maxBidPrice,
                            monthlyExpenses: monthlyExpenses,
                            propertyAppreciationPercent: (propRate * 100).toFixed(1),
                            investmentYieldPercent: (invRate * 100).toFixed(1),
                            mortgageRatePercent: (mortRate * 100).toFixed(1)
                        });
                        
                        // Update progress occasionally
                        if (processedCombinations % 10 === 0) {
                            const progress = Math.round((processedCombinations / totalCombinations) * 100);
                            document.getElementById('sweepResults').innerHTML = 
                                `<div class="loading">Progress: ${progress}% (${processedCombinations}/${totalCombinations} combinations)</div>`;
                        }
                    });
                });
            });
            
            return results;
        }

        document.getElementById('sweepBtn').addEventListener('click', () => {
            const sweepBtn = document.getElementById('sweepBtn');
            const resultsDiv = document.getElementById('sweepResults');
            
            sweepBtn.textContent = 'Running...';
            sweepBtn.disabled = true;
            resultsDiv.innerHTML = '<div class="loading">Running parameter sweep to find maximum bid prices...</div>';

            setTimeout(() => {
                try {
                    // Get the base parameters from the single calculation tab
                    const baseParams = {
                        // Get parameters from current form values
                        downPaymentMode: document.querySelector('input[name="downPaymentMode"]:checked')?.value || 'auto',
                        downPayment: parseFloat(document.getElementById('downPayment').value) || 400000,
                        mortgageAmount: parseFloat(document.getElementById('mortgageAmount').value) || 0,
                        additionalPurchaseCosts: parseFloat(document.getElementById('additionalPurchaseCosts').value) || 40000,
                        totalRenovations: parseFloat(document.getElementById('totalRenovations').value) || 0,
                        
                        amortizationYears: parseInt(document.getElementById('amortizationYears').value) || 10,
                        amortizationMode: document.querySelector('input[name="amortizationMode"]:checked')?.value || 'auto',
                        annualAmortization: parseFloat(document.getElementById('annualAmortization').value) || 32000,
                        
                        autoMaintenance: document.getElementById('autoMaintenance').checked,
                        annualMaintenanceCosts: parseFloat(document.getElementById('annualMaintenanceCosts').value) || 25000,
                        
                        autoImputedRental: document.getElementById('autoImputedRental').checked,
                        imputedRentalValue: parseFloat(document.getElementById('imputedRentalValue').value) || 42900,
                        propertyTaxDeductions: parseFloat(document.getElementById('propertyTaxDeductions').value) || 13000,
                        marginalTaxRate: parseFloat(document.getElementById('marginalTaxRate').value) / 100 || 0.236,
                        
                        monthlyRent: parseFloat(document.getElementById('monthlyRent').value) || 5500,
                        annualRentalCosts: parseFloat(document.getElementById('annualRentalCosts').value) || 20000,
                        
                        termYears: parseInt(document.getElementById('termYears').value) || 10
                    };

                    // Get sweep ranges
                    const sweepRanges = {
                        propertyAppreciationRate: {
                            min: parseFloat(document.getElementById('propAppMin').value) / 100,
                            max: parseFloat(document.getElementById('propAppMax').value) / 100,
                            step: parseFloat(document.getElementById('propAppStep').value) / 100
                        },
                        investmentYieldRate: {
                            min: parseFloat(document.getElementById('invYieldMin').value) / 100,
                            max: parseFloat(document.getElementById('invYieldMax').value) / 100,
                            step: parseFloat(document.getElementById('invYieldStep').value) / 100
                        },
                        mortgageRate: {
                            min: parseFloat(document.getElementById('mortRateMin').value) / 100,
                            max: parseFloat(document.getElementById('mortRateMax').value) / 100,
                            step: parseFloat(document.getElementById('mortRateStep').value) / 100
                        }
                    };

                    // Run parameter sweep to find maximum bid prices
                    sweepData = runMaxBidPriceSweep(baseParams, sweepRanges);
                    displaySweepResults(sweepData);
                    
                    // Set up CSV download buttons after results are displayed
                    setupCsvDownloadButtons();
                } catch (error) {
                    resultsDiv.textContent = `Error: ${error.message}`;
                } finally {
                    sweepBtn.textContent = 'Run Parameter Sweep';
                    sweepBtn.disabled = false;
                }
            }, 100);
        });

        function createMonthlyExpenseTable(data, propRates, invRates, mortRates, currentPurchasePrice) {
            // Get unique monthly expenses for each mortgage rate (they should all be the same regardless of other parameters)
            const monthlyExpensesByMortRate = {};
            
            mortRates.forEach(mortRate => {
                // Find any result with this mortgage rate to get the monthly expense
                const result = data.find(d => Math.abs(d.mortgageRate - mortRate) < 0.001);
                if (result && result.monthlyExpenses !== null && result.monthlyExpenses > 0) {
                    monthlyExpensesByMortRate[mortRate] = result.monthlyExpenses;
                }
            });
            
            const validExpenses = Object.values(monthlyExpensesByMortRate).filter(exp => exp > 0);
            if (validExpenses.length === 0) {
                return '<div style="text-align: center; color: #666; padding: 20px;">No monthly expense data available</div>';
            }
            
            const maxMonthlyExpense = Math.max(...validExpenses);
            const minMonthlyExpense = Math.min(...validExpenses);
            const currentMonthlyRent = parseFloat(document.getElementById('monthlyRent').value) || 5500;
            
            // Color scale function for monthly expenses (green = low, red = high)
            function getMonthlyExpenseColor(monthlyExpense) {
                if (!monthlyExpense || monthlyExpense <= 0) return '#f0f0f0';
                
                // Use monthly rent as reference point for coloring
                if (monthlyExpense < currentMonthlyRent * 0.9) {
                    // Much lower than rent: bright green
                    return 'rgb(0, 255, 150)';
                } else if (monthlyExpense < currentMonthlyRent) {
                    // Lower than rent: light green
                    return 'rgb(150, 255, 150)';
                } else if (monthlyExpense < currentMonthlyRent * 1.1) {
                    // Close to rent: yellow
                    return 'rgb(255, 255, 100)';
                } else {
                    // Higher than rent: red shades
                    const ratio = Math.min(1, (monthlyExpense - currentMonthlyRent) / (currentMonthlyRent * 0.5));
                    const red = 255;
                    const green = Math.max(60, 200 - ratio * 140);
                    const blue = Math.max(60, 100 - ratio * 40);
                    return `rgb(${red}, ${green}, ${blue})`;
                }
            }
            
            // Create simplified monthly expense table - just mortgage rates as rows
            let monthlyTable = '<div class="pivot-table"><table>';
            
            // Header row
            monthlyTable += '<thead><tr>';
            monthlyTable += '<th style="background: #f8f9fa; border: 1px solid #ddd; font-weight: bold; padding: 12px; text-align: center;">Mortgage Rate (%)</th>';
            monthlyTable += '<th style="background: #e3f2fd; border: 1px solid #ddd; font-weight: bold; padding: 12px; text-align: center;">Monthly Expenses</th>';
            monthlyTable += '<th style="background: #f0f8ff; border: 1px solid #ddd; font-weight: bold; padding: 12px; text-align: center;">vs. Monthly Rent</th>';
            monthlyTable += '</tr></thead><tbody>';
            
            // Create rows for each mortgage rate
            mortRates.forEach(mortRate => {
                const monthlyExpense = monthlyExpensesByMortRate[mortRate];
                
                if (monthlyExpense && monthlyExpense > 0) {
                    const bgColor = getMonthlyExpenseColor(monthlyExpense);
                    const formattedExpense = `CHF ${Math.round(monthlyExpense).toLocaleString()}`;
                    const difference = monthlyExpense - currentMonthlyRent;
                    const diffText = difference > 0 ? 
                        `+CHF ${Math.round(difference).toLocaleString()}` : 
                        `CHF ${Math.round(Math.abs(difference)).toLocaleString()} less`;
                    const diffColor = difference > 0 ? '#ff3b30' : '#34c759';
                    
                    monthlyTable += `<tr>
                        <td style="background: #fff3e0; font-weight: bold; text-align: center; border: 1px solid #ddd; font-size: 14px; padding: 12px;">${(mortRate * 100).toFixed(1)}%</td>
                        <td style="background: ${bgColor}; text-align: center; font-size: 14px; padding: 12px; border: 1px solid #ddd; font-weight: bold;">${formattedExpense}</td>
                        <td style="background: #f9f9f9; text-align: center; font-size: 13px; padding: 12px; border: 1px solid #ddd; color: ${diffColor}; font-weight: 600;">${diffText}</td>
                    </tr>`;
                } else {
                    monthlyTable += `<tr>
                        <td style="background: #fff3e0; font-weight: bold; text-align: center; border: 1px solid #ddd; font-size: 14px; padding: 12px;">${(mortRate * 100).toFixed(1)}%</td>
                        <td style="background: #f0f0f0; text-align: center; color: #999; border: 1px solid #ddd; font-size: 13px; padding: 12px;">N/A</td>
                        <td style="background: #f0f0f0; text-align: center; color: #999; border: 1px solid #ddd; font-size: 13px; padding: 12px;">N/A</td>
                    </tr>`;
                }
            });
            
            monthlyTable += '</tbody></table></div>';
            return monthlyTable;
        }

        function displaySweepResults(data) {
            const resultsDiv = document.getElementById('sweepResults');
            
            if (data.length === 0) {
                resultsDiv.innerHTML = '<div>No results to display</div>';
                return;
            }

            // Extract unique values for each dimension
            const propRates = [...new Set(data.map(d => d.propertyAppreciationRate))].sort((a, b) => a - b);
            const invRates = [...new Set(data.map(d => d.investmentYieldRate))].sort((a, b) => a - b);
            const mortRates = [...new Set(data.map(d => d.mortgageRate))].sort((a, b) => a - b);
            
            // Calculate color scale based on current purchase price and sweep results
            const currentPurchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 2000000;
            const validResults = data.filter(d => d.maxBidPrice !== null);
            const maxBidPrice = validResults.length > 0 ? Math.max(...validResults.map(d => d.maxBidPrice)) : currentPurchasePrice * 1.5;
            const minBidPrice = validResults.length > 0 ? Math.min(...validResults.map(d => d.maxBidPrice)) : currentPurchasePrice * 0.5;
            
            // Color scale function
            function getBidPriceColor(bidPrice) {
                if (!bidPrice || bidPrice <= 0) return '#f0f0f0';
                
                // Define color scale: red (below purchase price) -> yellow (at purchase price) -> green (high max bid)
                const redPoint = currentPurchasePrice;
                const greenPoint = maxBidPrice;
                
                if (bidPrice < redPoint) {
                    // Below purchase price: various shades of red (darker red for lower values)
                    const ratio = Math.max(0.3, bidPrice / redPoint); // Don't go too dark
                    const red = Math.round(255);
                    const green = Math.round(60 * ratio); // Some green to avoid pure red
                    const blue = Math.round(60 * ratio);  // Some blue to avoid pure red
                    return `rgb(${red}, ${green}, ${blue})`;
                } else if (bidPrice === redPoint) {
                    // Exactly at purchase price: bright yellow
                    return `rgb(255, 255, 0)`;
                } else if (bidPrice < greenPoint) {
                    // Between purchase price and max: yellow to green gradient
                    const ratio = (bidPrice - redPoint) / (greenPoint - redPoint);
                    const red = Math.round(255 * (1 - ratio));  // Fade from yellow (255) to green (0)
                    const green = 255;                          // Always full green
                    const blue = Math.round(100 * (1 - ratio)); // Fade from yellow (100) to green (200)
                    return `rgb(${red}, ${green}, ${Math.min(200, blue + 100)})`;
                } else {
                    // At or above max: bright green
                    return `rgb(0, 255, 150)`;
                }
            }
            
            // Create table with improved headers
            let table = '<div class="pivot-table"><table>';
            
            // Header row 1: Property Appreciation (merged header)
            table += '<thead><tr>';
            table += '<th rowspan="2" style="background: #f8f9fa; vertical-align: middle; border: 1px solid #ddd; font-weight: bold;">Mortgage<br>Rate (%)</th>';
            table += '<th rowspan="2" style="background: #f8f9fa; vertical-align: middle; border: 1px solid #ddd; font-weight: bold;">Investment<br>Yield (%)</th>';
            table += `<th colspan="${propRates.length}" style="background: #e3f2fd; text-align: center; border: 1px solid #ddd; font-weight: bold; font-size: 14px;">Property Appreciation (%/year)</th>`;
            table += '</tr>';
            
            // Header row 2: Individual property appreciation values
            table += '<tr>';
            propRates.forEach(rate => {
                table += `<th style="background: #e8f4f8; text-align: center; border: 1px solid #ddd; font-size: 12px; padding: 8px;">${(rate * 100).toFixed(1)}%</th>`;
            });
            table += '</tr></thead><tbody>';
            
            // Create rows with Mortgage Rate + Investment Yield combinations
            mortRates.forEach((mortRate, mortIdx) => {
                invRates.forEach((invRate, invIdx) => {
                    table += '<tr>';
                    
                    // First column shows mortgage rate (only on first investment yield row for each mortgage rate)
                    if (invIdx === 0) {
                        table += `<td rowspan="${invRates.length}" style="background: #fff3e0; vertical-align: middle; font-weight: bold; text-align: center; border: 1px solid #ddd; font-size: 13px;">${(mortRate * 100).toFixed(1)}</td>`;
                    }
                    
                    // Second column shows investment yield
                    table += `<td style="background: #f1f8e9; font-weight: 600; text-align: center; border: 1px solid #ddd; font-size: 13px;">${(invRate * 100).toFixed(1)}</td>`;
                    
                    // Data columns for each property appreciation rate
                    propRates.forEach(propRate => {
                        const result = data.find(d => 
                            Math.abs(d.propertyAppreciationRate - propRate) < 0.001 && 
                            Math.abs(d.investmentYieldRate - invRate) < 0.001 &&
                            Math.abs(d.mortgageRate - mortRate) < 0.001
                        );
                        
                        if (result && result.maxBidPrice !== null) {
                            const bgColor = getBidPriceColor(result.maxBidPrice);
                            let formattedPrice = formatBidPrice(result.maxBidPrice);
                            
                            // Check if we hit the search price limits
                            const maxSearchPrice = parseFloat(document.getElementById('beMaxPrice').value) || 10000000;
                            const minSearchPrice = parseFloat(document.getElementById('beMinPrice').value) || 1500000;
                            
                            if (result.maxBidPrice >= maxSearchPrice - 1000) {
                                formattedPrice = '>' + formatBidPrice(maxSearchPrice);
                            } else if (result.maxBidPrice <= minSearchPrice + 1000) {
                                formattedPrice = '<' + formatBidPrice(minSearchPrice);
                            }
                            
                            table += `<td class="bid-price-cell" style="background: ${bgColor}; text-align: center; font-size: 12px; padding: 6px; border: 1px solid #ddd; font-weight: bold;">
                                        ${formattedPrice}
                                      </td>`;
                        } else {
                            table += '<td style="background: #f0f0f0; text-align: center; color: #999; border: 1px solid #ddd; font-size: 11px;">N/A</td>';
                        }
                    });
                    table += '</tr>';
                });
                
                // Add separator line between mortgage rate groups (except for the last one)
                if (mortIdx < mortRates.length - 1) {
                    table += `<tr style="border-bottom: 3px solid #666;"><td colspan="${propRates.length + 2}" style="height: 2px; padding: 0; border: none;"></td></tr>`;
                }
            });
            
            table += '</tbody></table></div>';
            
            // Calculate some statistics with improved formatting
            const avgBidPrice = validResults.length > 0 ? 
                validResults.reduce((sum, d) => sum + d.maxBidPrice, 0) / validResults.length : 0;
            
            // Calculate buy vs rent recommendation percentages
            const abovePurchasePrice = validResults.filter(d => d.maxBidPrice > currentPurchasePrice).length;
            const belowPurchasePrice = validResults.filter(d => d.maxBidPrice < currentPurchasePrice).length;
            const atPurchasePrice = validResults.length - abovePurchasePrice - belowPurchasePrice;
            
            const buyRecommendedPercent = validResults.length > 0 ? Math.round((abovePurchasePrice / validResults.length) * 100) : 0;
            const rentRecommendedPercent = validResults.length > 0 ? Math.round((belowPurchasePrice / validResults.length) * 100) : 0;
            const neutralPercent = validResults.length > 0 ? Math.round((atPurchasePrice / validResults.length) * 100) : 0;
            
            // Create monthly cost table
            const monthlyTable = createMonthlyExpenseTable(data, propRates, invRates, mortRates, currentPurchasePrice);
            
            resultsDiv.innerHTML = `
                <h4>Parameter Sweep Analysis (${data.length} combinations)</h4>
                <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h5 style="margin: 0 0 10px 0; color: #1976d2;">Summary Statistics</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div><strong>Current Purchase Price:</strong> ${formatBidPrice(currentPurchasePrice)}</div>
                        <div><strong>Average Max Bid:</strong> ${formatBidPrice(avgBidPrice)}</div>
                        <div><strong>Highest Max Bid:</strong> ${formatBidPrice(maxBidPrice)}</div>
                        <div><strong>Lowest Max Bid:</strong> ${formatBidPrice(minBidPrice)}</div>
                        <div><strong>Valid Results:</strong> ${validResults.length}/${data.length}</div>
                        <div><strong>Buy Recommended:</strong> ${abovePurchasePrice} scenarios (${buyRecommendedPercent}%)</div>
                        <div><strong>Rent Recommended:</strong> ${belowPurchasePrice} scenarios (${rentRecommendedPercent}%)</div>
                        ${neutralPercent > 0 ? `<div><strong>Neutral:</strong> ${atPurchasePrice} scenarios (${neutralPercent}%)</div>` : ''}
                    </div>
                </div>
                
                <h5 style="margin: 20px 0 10px 0; color: #1976d2;">Maximum Bid Price Analysis</h5>
                <div style="background: #f9f9f9; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 13px;">
                    <strong>How to read this table:</strong><br>
                    • Rows represent combinations of <strong>Mortgage Rate</strong> and <strong>Investment Yield</strong><br>
                    • Columns represent different <strong>Property Appreciation</strong> rates<br>
                    • Values show the maximum price you should bid to break even with renting<br>
                    • <strong>Color scale:</strong> <span style="background: rgb(255, 60, 60); color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold;">Red</span> = below current purchase price (${formatBidPrice(currentPurchasePrice)}), <span style="background: rgb(255, 255, 0); color: black; padding: 2px 6px; border-radius: 3px; font-weight: bold;">Yellow</span> = moderate, <span style="background: rgb(0, 255, 150); color: black; padding: 2px 6px; border-radius: 3px; font-weight: bold;">Green</span> = highest opportunities
                </div>
                
                <div style="margin-bottom: 20px;">
                    <button class="button secondary" id="downloadMaxBidCsvBtn" style="margin-right: 10px;">Download Max Bid Price CSV</button>
                </div>
                
                ${table}
                
                <h5 style="margin: 30px 0 10px 0; color: #1976d2;">Monthly Cost Analysis</h5>
                <div style="background: #f9f9f9; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 13px;">
                    <strong>About this table:</strong><br>
                    • Shows total monthly expenses when buying at the current purchase price (${formatBidPrice(currentPurchasePrice)})<br>
                    • Includes mortgage interest, amortization, and maintenance costs<br>
                    • Monthly costs only depend on mortgage rate (independent of property appreciation and investment yield)<br>
                    • <strong>Color scale based on comparison to monthly rent (CHF ${Math.round(parseFloat(document.getElementById('monthlyRent').value) || 5500).toLocaleString()}):</strong> <span style="background: rgb(0, 255, 150); color: black; padding: 2px 6px; border-radius: 3px; font-weight: bold;">Green</span> = below rent, <span style="background: rgb(255, 255, 100); color: black; padding: 2px 6px; border-radius: 3px; font-weight: bold;">Yellow</span> = close to rent, <span style="background: rgb(255, 60, 60); color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold;">Red</span> = above rent
                </div>
                
                <div style="margin-bottom: 20px;">
                    <button class="button secondary" id="downloadMonthlyCsvBtn" style="margin-right: 10px;">Download Monthly Cost CSV</button>
                </div>
                
                ${monthlyTable}
            `;
        }

        // Set up CSV download buttons
        function setupCsvDownloadButtons() {
            // Download Max Bid Price CSV
            const downloadMaxBidBtn = document.getElementById('downloadMaxBidCsvBtn');
            if (downloadMaxBidBtn) {
                downloadMaxBidBtn.addEventListener('click', () => {
                    if (sweepData.length === 0) return;
                    
                    // Create data focused on max bid prices
                    const maxBidData = sweepData.map(d => ({
                        PropertyAppreciationRate: d.propertyAppreciationPercent + '%',
                        InvestmentYieldRate: d.investmentYieldPercent + '%',
                        MortgageRate: d.mortgageRatePercent + '%',
                        MaxBidPrice: d.maxBidPrice ? Math.round(d.maxBidPrice) : 'N/A'
                    }));
                    
                    const csv = arrayToCsv(maxBidData);
                    downloadCsv(csv, `max_bid_price_sweep_${new Date().toISOString().split('T')[0]}.csv`);
                });
            }
            
            // Download Monthly Cost CSV
            const downloadMonthlyBtn = document.getElementById('downloadMonthlyCsvBtn');
            if (downloadMonthlyBtn) {
                downloadMonthlyBtn.addEventListener('click', () => {
                    if (sweepData.length === 0) return;
                    
                    // Get unique mortgage rates and their corresponding monthly expenses
                    const mortgageRates = [...new Set(sweepData.map(d => d.mortgageRate))].sort((a, b) => a - b);
                    const currentMonthlyRent = parseFloat(document.getElementById('monthlyRent').value) || 5500;
                    
                    const monthlyData = mortgageRates.map(mortRate => {
                        const result = sweepData.find(d => Math.abs(d.mortgageRate - mortRate) < 0.001);
                        const monthlyExpense = result ? result.monthlyExpenses : null;
                        const difference = monthlyExpense ? monthlyExpense - currentMonthlyRent : null;
                        
                        return {
                            MortgageRate: (mortRate * 100).toFixed(1) + '%',
                            MonthlyExpenses: monthlyExpense ? Math.round(monthlyExpense) : 'N/A',
                            MonthlyRent: Math.round(currentMonthlyRent),
                            Difference: difference ? Math.round(difference) : 'N/A',
                            ComparisonToRent: difference ? (difference > 0 ? 'Higher' : 'Lower') : 'N/A'
                        };
                    });
                    
                    const csv = arrayToCsv(monthlyData);
                    downloadCsv(csv, `monthly_cost_analysis_${new Date().toISOString().split('T')[0]}.csv`);
                });
            }
        }
        
        // Helper function to convert array to CSV
        function arrayToCsv(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => 
                    headers.map(header => {
                        const value = row[header];
                        if (typeof value === 'string' && value.includes(',')) {
                            return `"${value}"`;
                        }
                        return value;
                    }).join(',')
                )
            ].join('\n');
            
            return csvContent;
        }
        
        // Helper function to download CSV
        function downloadCsv(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Save and Load Parameters functionality
        function getAllParameters() {
            // Collect all input parameters from all tabs
            const parameters = {
                version: '2.1.0',
                timestamp: new Date().toISOString(),
                
                // Single Calculation Tab Parameters
                single: {
                    purchasePrice: parseFloat(document.getElementById('purchasePrice').value) || 0,
                     scenarioMode: document.querySelector('input[name="scenarioMode"]:checked')?.value || 'equalConsumption',
                    downPaymentMode: document.querySelector('input[name="downPaymentMode"]:checked')?.value || 'auto',
                    downPayment: parseFloat(document.getElementById('downPayment').value) || 0,
                    mortgageAmount: parseFloat(document.getElementById('mortgageAmount').value) || 0,
                    additionalPurchaseCosts: parseFloat(document.getElementById('additionalPurchaseCosts').value) || 0,
                    totalRenovations: parseFloat(document.getElementById('totalRenovations').value) || 0,
                    
                    mortgageRate: parseFloat(document.getElementById('mortgageRate').value) || 0,
                    amortizationYears: parseInt(document.getElementById('amortizationYears').value) || 10,
                    amortizationMode: document.querySelector('input[name="amortizationMode"]:checked')?.value || 'auto',
                    annualAmortization: parseFloat(document.getElementById('annualAmortization').value) || 0,
                    
                    autoMaintenance: document.getElementById('autoMaintenance').checked,
                    annualMaintenanceCosts: parseFloat(document.getElementById('annualMaintenanceCosts').value) || 0,
                    propertyAppreciation: parseFloat(document.getElementById('propertyAppreciation').value) || 0,
                    
                    autoImputedRental: document.getElementById('autoImputedRental').checked,
                    imputedRentalValue: parseFloat(document.getElementById('imputedRentalValue').value) || 0,
                    propertyTaxDeductions: parseFloat(document.getElementById('propertyTaxDeductions').value) || 0,
                    marginalTaxRate: parseFloat(document.getElementById('marginalTaxRate').value) || 0,
                    
                    monthlyRent: parseFloat(document.getElementById('monthlyRent').value) || 0,
                    annualRentalCosts: parseFloat(document.getElementById('annualRentalCosts').value) || 0,
                    
                    investmentYield: parseFloat(document.getElementById('investmentYield').value) || 0,
                    termYears: parseInt(document.getElementById('termYears').value) || 10
                },
                
                // Max Bid Finder Tab Parameters
                breakeven: {
                    minPrice: parseFloat(document.getElementById('beMinPrice').value) || 1500000,
                    maxPrice: parseFloat(document.getElementById('beMaxPrice').value) || 10000000,
                    tolerance: parseFloat(document.getElementById('beTolerance').value) || 2500
                },
                
                // Parameter Sweep Tab Parameters
                sweep: {
                    propAppMin: parseFloat(document.getElementById('propAppMin').value) || -1,
                    propAppMax: parseFloat(document.getElementById('propAppMax').value) || 5,
                    propAppStep: parseFloat(document.getElementById('propAppStep').value) || 1,
                    
                    invYieldMin: parseFloat(document.getElementById('invYieldMin').value) || -1,
                    invYieldMax: parseFloat(document.getElementById('invYieldMax').value) || 8,
                    invYieldStep: parseFloat(document.getElementById('invYieldStep').value) || 1,
                    
                    mortRateMin: parseFloat(document.getElementById('mortRateMin').value) || 1,
                    mortRateMax: parseFloat(document.getElementById('mortRateMax').value) || 5,
                    mortRateStep: parseFloat(document.getElementById('mortRateStep').value) || 1
                }
            };
            
            return parameters;
        }
        
        function saveParameters() {
            try {
                const parameters = getAllParameters();
                const jsonString = JSON.stringify(parameters, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `swiss-rent-buy-calculator-params-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showSaveLoadStatus('Parameters saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving parameters:', error);
                showSaveLoadStatus('Error saving parameters: ' + error.message, 'error');
            }
        }
        
        function loadParameters(parametersData) {
            try {
                // Validate the data structure
                if (!parametersData || typeof parametersData !== 'object') {
                    throw new Error('Invalid parameter file format');
                }
                
                const params = parametersData;
                
                // Load Single Calculation Tab Parameters
                if (params.single) {
                    const s = params.single;
                    
                    // Comparison mode (scenario)
                    if (s.scenarioMode) {
                        const scenarioRadio = document.querySelector(`input[name="scenarioMode"][value="${s.scenarioMode}"]`);
                        if (scenarioRadio) scenarioRadio.checked = true;
                    }

                    // Basic purchase parameters
                    if (s.purchasePrice !== undefined) document.getElementById('purchasePrice').value = s.purchasePrice;
                    if (s.additionalPurchaseCosts !== undefined) document.getElementById('additionalPurchaseCosts').value = s.additionalPurchaseCosts;
                    if (s.totalRenovations !== undefined) document.getElementById('totalRenovations').value = s.totalRenovations;
                    
                    // Down payment mode
                    if (s.downPaymentMode) {
                        const downPaymentRadio = document.querySelector(`input[name="downPaymentMode"][value="${s.downPaymentMode}"]`);
                        if (downPaymentRadio) downPaymentRadio.checked = true;
                    }
                    if (s.downPayment !== undefined) document.getElementById('downPayment').value = s.downPayment;
                    if (s.mortgageAmount !== undefined) document.getElementById('mortgageAmount').value = s.mortgageAmount;
                    
                    // Mortgage parameters
                    if (s.mortgageRate !== undefined) document.getElementById('mortgageRate').value = s.mortgageRate;
                    if (s.amortizationYears !== undefined) document.getElementById('amortizationYears').value = s.amortizationYears;
                    
                    // Amortization mode
                    if (s.amortizationMode) {
                        const amortizationRadio = document.querySelector(`input[name="amortizationMode"][value="${s.amortizationMode}"]`);
                        if (amortizationRadio) amortizationRadio.checked = true;
                    }
                    if (s.annualAmortization !== undefined) document.getElementById('annualAmortization').value = s.annualAmortization;
                    
                    // Property costs
                    if (s.autoMaintenance !== undefined) document.getElementById('autoMaintenance').checked = s.autoMaintenance;
                    if (s.annualMaintenanceCosts !== undefined) document.getElementById('annualMaintenanceCosts').value = s.annualMaintenanceCosts;
                    if (s.propertyAppreciation !== undefined) document.getElementById('propertyAppreciation').value = s.propertyAppreciation;
                    
                    // Tax parameters
                    if (s.autoImputedRental !== undefined) document.getElementById('autoImputedRental').checked = s.autoImputedRental;
                    if (s.imputedRentalValue !== undefined) document.getElementById('imputedRentalValue').value = s.imputedRentalValue;
                    if (s.propertyTaxDeductions !== undefined) document.getElementById('propertyTaxDeductions').value = s.propertyTaxDeductions;
                    if (s.marginalTaxRate !== undefined) document.getElementById('marginalTaxRate').value = s.marginalTaxRate;
                    
                    // Rental parameters
                    if (s.monthlyRent !== undefined) document.getElementById('monthlyRent').value = s.monthlyRent;
                    if (s.annualRentalCosts !== undefined) document.getElementById('annualRentalCosts').value = s.annualRentalCosts;
                    
                    // Investment parameters
                    if (s.investmentYield !== undefined) document.getElementById('investmentYield').value = s.investmentYield;
                    if (s.termYears !== undefined) document.getElementById('termYears').value = s.termYears;
                }
                
                // Load Max Bid Finder Tab Parameters
                if (params.breakeven) {
                    const b = params.breakeven;
                    if (b.minPrice !== undefined) document.getElementById('beMinPrice').value = b.minPrice;
                    if (b.maxPrice !== undefined) document.getElementById('beMaxPrice').value = b.maxPrice;
                    if (b.tolerance !== undefined) document.getElementById('beTolerance').value = b.tolerance;
                }
                
                // Load Parameter Sweep Tab Parameters
                if (params.sweep) {
                    const sw = params.sweep;
                    if (sw.propAppMin !== undefined) document.getElementById('propAppMin').value = sw.propAppMin;
                    if (sw.propAppMax !== undefined) document.getElementById('propAppMax').value = sw.propAppMax;
                    if (sw.propAppStep !== undefined) document.getElementById('propAppStep').value = sw.propAppStep;
                    
                    if (sw.invYieldMin !== undefined) document.getElementById('invYieldMin').value = sw.invYieldMin;
                    if (sw.invYieldMax !== undefined) document.getElementById('invYieldMax').value = sw.invYieldMax;
                    if (sw.invYieldStep !== undefined) document.getElementById('invYieldStep').value = sw.invYieldStep;
                    
                    if (sw.mortRateMin !== undefined) document.getElementById('mortRateMin').value = sw.mortRateMin;
                    if (sw.mortRateMax !== undefined) document.getElementById('mortRateMax').value = sw.mortRateMax;
                    if (sw.mortRateStep !== undefined) document.getElementById('mortRateStep').value = sw.mortRateStep;
                }
                
                // Trigger recalculation of auto-calculated fields
                updateCalculatedFields();
                
                showSaveLoadStatus('Parameters loaded successfully!', 'success');
                
            } catch (error) {
                console.error('Error loading parameters:', error);
                showSaveLoadStatus('Error loading parameters: ' + error.message, 'error');
            }
        }
        
        function showSaveLoadStatus(message, type) {
            const statusElement = document.getElementById('saveLoadStatus');
            statusElement.textContent = message;
            statusElement.className = `save-load-status ${type}`;
            
            // Clear the message after 3 seconds
            setTimeout(() => {
                statusElement.textContent = '';
                statusElement.className = 'save-load-status';
            }, 3000);
        }

        // Initialize version numbering
        async function setVersionNumbers() {
            let version = '2.1.0'; // Fallback version
            
            try {
                // Attempt to fetch calculator.js and extract version from header
                const response = await fetch('calculator.js');
                const content = await response.text();
                
                // Look for @version tag in the header comment
                const versionMatch = content.match(/@version\s+(\d+\.\d+\.\d+)/);
                if (versionMatch) {
                    version = versionMatch[1];
                }
            } catch (error) {
                console.log('Could not extract version from calculator.js, using fallback:', version);
            }
            
            // Set version in About tab and footer
            const appVersionElement = document.getElementById('app-version');
            const footerVersionElement = document.getElementById('footer-version');
            
            if (appVersionElement) appVersionElement.textContent = version;
            if (footerVersionElement) footerVersionElement.textContent = version;
            
            // Also update page title to include version
            document.title = `Swiss Rent vs Buy Calculator v${version}`;
        }

        // Save and Load event listeners
        document.getElementById('saveParametersBtn').addEventListener('click', saveParameters);
        
        document.getElementById('loadParametersBtn').addEventListener('click', () => {
            document.getElementById('loadFileInput').click();
        });
        
        document.getElementById('loadFileInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const parametersData = JSON.parse(e.target.result);
                        loadParameters(parametersData);
                    } catch (error) {
                        showSaveLoadStatus('Error reading file: Invalid JSON format', 'error');
                    }
                };
                reader.readAsText(file);
            }
            // Reset the file input so same file can be loaded again
            event.target.value = '';
        });

        // Initialize
        setVersionNumbers();
        updateCalculatedFields();
        document.getElementById('calculateBtn').click();
    </script>
</body>
</html>