<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swiss Rent vs Buy Calculator</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f7;
            color: #1d1d1f;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #1d1d1f;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .lang-switch {
            display: inline-flex;
            border: 1px solid #d2d2d7;
            border-radius: 999px;
            overflow: hidden;
            background: #f2f2f7;
        }
        .lang-switch button {
            background: transparent;
            border: none;
            padding: 6px 12px;
            cursor: pointer;
            font-weight: 600;
            color: #1d1d1f;
        }
        .lang-switch button.active {
            background: white;
            color: #007aff;
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 1px solid #d2d2d7;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            color: #86868b;
            font-size: 16px;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            color: #007aff;
            border-bottom-color: #007aff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .form-section h3 {
            margin: 0 0 20px 0;
            color: #1d1d1f;
            font-size: 18px;
            border-bottom: 2px solid #007aff;
            padding-bottom: 8px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }
        
        .input-label {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1d1d1f;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 8px;
            cursor: help;
        }
        
        .tooltip .info-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: #007aff;
            color: white;
            border-radius: 50%;
            text-align: center;
            font-size: 12px;
            line-height: 16px;
            font-weight: bold;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 300px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 13px;
            line-height: 1.4;
            font-weight: normal;
        }
        
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .input-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .checkbox-container input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .checkbox-container label {
            font-size: 14px;
            color: #666;
            font-weight: normal;
        }
        
        input[type="number"], select {
            padding: 12px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            width: 100%;
            max-width: 300px;
        }
        
        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #007aff;
        }
        
        input[type="number"]:disabled {
            background-color: #f5f5f5;
            color: #999;
        }
        
        .unit {
            color: #666;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .button {
            background: #007aff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 20px;
        }
        
        .button:hover {
            background: #0056b3;
        }
        
        .button.secondary {
            background: #f2f2f7;
            color: #1d1d1f;
        }
        
        .button.secondary:hover {
            background: #e5e5ea;
        }
        
        .results {
            background: #f2f2f7;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px 0;
            border-bottom: 1px solid #d2d2d7;
        }
        
        .result-item:last-child {
            border-bottom: none;
            font-weight: 600;
            font-size: 18px;
        }
        
        .decision-buy {
            color: #34c759;
        }
        
        .decision-rent {
            color: #ff3b30;
        }
        
        .decision-even {
            color: #ff9500;
        }
        
        .pivot-table {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        .pivot-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .pivot-table th, .pivot-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #d2d2d7;
        }
        
        .pivot-table th {
            background: #f2f2f7;
            font-weight: 600;
        }
        
        .cell-buy {
            background: rgba(52, 199, 89, 0.2);
        }
        
        .cell-rent {
            background: rgba(255, 59, 48, 0.2);
        }
        
        .cell-even {
            background: rgba(255, 149, 0, 0.2);
        }
        
        .loading {
            text-align: center;
            color: #86868b;
            padding: 20px;
        }
        
        .sweep-controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .sweep-param {
            background: #f2f2f7;
            padding: 20px;
            border-radius: 8px;
        }
        
        .sweep-param h4 {
            margin: 0 0 15px 0;
            color: #1d1d1f;
        }
        
        .range-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        
        .range-inputs input {
            padding: 8px;
            font-size: 14px;
        }
        
        .save-load-controls {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 20px;
            padding: 0 10px;
        }
        
        .save-load-button {
            background: #f2f2f7;
            color: #1d1d1f;
            padding: 8px 16px;
            border: 1px solid #d2d2d7;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .save-load-button:hover {
            background: #e5e5ea;
            border-color: #007aff;
        }
        
        .save-load-button.save {
            background: #007aff;
            color: white;
            border-color: #007aff;
        }
        
        .save-load-button.save:hover {
            background: #0056b3;
        }
        
        #loadFileInput {
            display: none;
        }
        
        .save-load-status {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: right;
            min-height: 16px;
        }
        
        .save-load-status.success {
            color: #34c759;
        }
        
        .save-load-status.error {
            color: #ff3b30;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .range-inputs {
                grid-template-columns: 1fr;
            }
            
            .tooltip .tooltiptext {
                width: 250px;
                margin-left: -125px;
            }
            
            .save-load-controls {
                justify-content: center;
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="topbar">
            <h1><span data-i18n="appTitle">Swiss Rent vs Buy Calculator</span></h1>
            <div class="lang-switch" id="langSwitch">
                <button type="button" id="langEn" class="active">EN</button>
                <button type="button" id="langDe">🇨🇭 DE</button>
            </div>
        </div>
        
        <!-- Save/Load Controls -->
        <div class="save-load-controls">
            <button class="save-load-button" id="loadParametersBtn">
                📁 <span data-i18n="loadParameters">Load Parameters</span>
            </button>
            <button class="save-load-button save" id="saveParametersBtn">
                💾 <span data-i18n="saveParameters">Save Parameters</span>
            </button>
            <input type="file" id="loadFileInput" accept=".json">
        </div>
        <div class="save-load-status" id="saveLoadStatus"></div>
        
        <div class="tab-container">
            <button class="tab active" data-tab="single"><span data-i18n="tabSingle">Single Calculation</span></button>
            <button class="tab" data-tab="breakeven"><span data-i18n="tabBreakeven">Max Bid Finder</span></button>
            <button class="tab" data-tab="sweep"><span data-i18n="tabSweep">Parameter Sweep</span></button>
            <button class="tab" data-tab="about"><span data-i18n="tabAbout">About</span></button>
        </div>
        
        <!-- Single Calculation Tab -->
        <div class="tab-content active" id="single">
            <div style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid #007aff;">
                <p style="margin: 0; color: #1d1d1f; line-height: 1.5;" data-i18n="singleIntro">Calculate whether renting or buying a property makes more financial sense for your situation. This tool analyzes all costs, tax implications, and investment opportunities over your chosen time period to help you make an informed decision.</p>
            </div>
            <!-- Purchase Parameters Section -->
            <div class="form-section">
                <h3><span data-i18n="secPurchase">Purchase Parameters</span></h3>
                
                <div class="input-group">
                    <div class="input-label">
                        <span data-i18n="purchasePrice">Purchase Price</span>
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext" data-i18n="purchasePriceHelp">The total price you would pay to purchase the property, including all costs.</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <input type="number" id="purchasePrice" value="2000000" step="1000" min="0">
                        <span class="unit">CHF</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        <span data-i18n="downPaymentHeader">Down Payment / Mortgage Configuration</span>
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext" data-i18n="downPaymentHeaderHelp">Choose how to specify your financing: either set the down payment directly, calculate it automatically (20%), or maximize your mortgage up to a specified limit while maintaining the mandatory 20% minimum down payment.</span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div class="checkbox-container">
                            <input type="radio" id="autoDownPayment" name="downPaymentMode" value="auto" checked>
                            <label for="autoDownPayment" data-i18n="autoDownPayment">Calculate down payment automatically (20% of purchase price)</label>
                        </div>
                        <div class="checkbox-container">
                            <input type="radio" id="manualDownPayment" name="downPaymentMode" value="manual">
                            <label for="manualDownPayment" data-i18n="manualDownPayment">Specify down payment manually</label>
                        </div>
                        <div class="checkbox-container">
                            <input type="radio" id="mortgageAmountMode" name="downPaymentMode" value="mortgage">
                            <label for="mortgageAmountMode">
                                <span data-i18n="mortgageAmountMode">Maximize mortgage up to specified limit</span>
                                <div class="tooltip" style="margin-left: 5px;">
                                    <span class="info-icon">i</span>
                                    <span class="tooltiptext" data-i18n="mortgageAmountModeHelp">Sets the mortgage amount to your specified maximum, unless doing so would result in a down payment below 20% of the purchase price. In that case, the down payment is set to exactly 20% and the mortgage is reduced accordingly. Formula: Down Payment = max(20% × Purchase Price, Purchase Price - Max Mortgage)</span>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="input-container" id="downPaymentInput">
                        <label data-i18n="downPaymentLabel">Down Payment:</label>
                        <input type="number" id="downPayment" value="400000" step="1000" min="0" disabled>
                        <span class="unit">CHF</span>
                    </div>
                    
                    <div class="input-container" id="mortgageAmountInput" style="display: none;">
                        <label data-i18n="maxMortgageLabel">Maximum Mortgage Amount:</label>
                        <input type="number" id="mortgageAmount" value="1600000" step="1000" min="0">
                        <span class="unit">CHF</span>
                    </div>
                    
                    <div id="downPaymentWarning" style="display: none; margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 6px; color: #856404; font-size: 14px;">
                        <strong data-i18n="warning">Warning:</strong> <span data-i18n="downPaymentWarning">Down payment is below 20% minimum. Adjusting to 20%.</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        <span data-i18n="additionalCosts">Additional Purchase Costs</span>
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext" data-i18n="additionalCostsHelp">Additional costs when buying: notary fees, land registry, real estate agent commission, taxes.</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <input type="number" id="additionalPurchaseCosts" value="5000" step="1000" min="0">
                        <span class="unit">CHF</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        <span data-i18n="totalRenovations">Total Renovations</span>
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext" data-i18n="totalRenovationsHelp">One-time renovation and improvement costs over the analysis period.</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <input type="number" id="totalRenovations" value="0" step="1000" min="0">
                        <span class="unit">CHF</span>
                    </div>
                </div>
            </div>
            
            <!-- Mortgage Parameters Section -->
            <div class="form-section">
                <h3><span data-i18n="secMortgage">Mortgage Parameters</span></h3>
                
                <div class="input-group">
                    <div class="input-label">
                        <span data-i18n="mortgageRate">Mortgage Interest Rate</span>
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext" data-i18n="mortgageRateHelp">Annual interest rate for your mortgage. Current Swiss rates typically range from 0.5% to 3%.</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <input type="number" id="mortgageRate" value="0.9" step="0.1" min="0">
                        <span class="unit" data-i18n="perYearPercent">% per year</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        <span data-i18n="amortizationYears">Amortization Period</span>
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext" data-i18n="amortizationYearsHelp">Period over which you pay down the mortgage. Swiss regulations require amortization to 66.6% (2/3) LTV within 15 years.</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <input type="number" id="amortizationYears" value="10" step="1" min="1" max="20">
                        <span class="unit" data-i18n="years">years</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        <span data-i18n="annualAmortization">Annual Amortization Amount</span>
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext" data-i18n="annualAmortizationHelp">Annual amount paid to reduce mortgage principal. Choose calculation method below.</span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div class="checkbox-container">
                            <input type="radio" id="autoAmortization" name="amortizationMode" value="auto" checked>
                            <label for="autoAmortization" data-i18n="autoAmortization">Calculate automatically (mortgage ÷ amortization period)</label>
                        </div>
                        <div class="checkbox-container">
                            <input type="radio" id="swissAmortization" name="amortizationMode" value="swiss">
                            <label for="swissAmortization">
                                <span data-i18n="swissAmortization">Swiss regulation: amortize to 66.6% (2/3) LTV within 15 years</span>
                                <div class="tooltip" style="margin-left: 5px;">
                                    <span class="info-icon">i</span>
                                    <span class="tooltiptext" data-i18n="swissAmortizationHelp">Swiss mortgage regulations require that mortgages above 66.6% LTV (second mortgage) must be amortized down to 66.6% (2/3) within 15 years. This calculates the minimum required annual amortization to comply with Swiss banking regulations. If your LTV is already 66.6% or below, no mandatory amortization is required.</span>
                                </div>
                            </label>
                        </div>
                        <div class="checkbox-container">
                            <input type="radio" id="manualAmortization" name="amortizationMode" value="manual">
                            <label for="manualAmortization" data-i18n="manualAmortization">Specify amortization amount manually</label>
                        </div>
                    </div>
                    
                    <div class="input-container">
                        <input type="number" id="annualAmortization" value="32000" step="1000" min="0" disabled>
                        <span class="unit" data-i18n="chfPerYear">CHF per year</span>
                    </div>
                </div>
            </div>
            
            <!-- Property Costs Section -->
            <div class="form-section">
                <h3><span data-i18n="secPropertyCosts">Property Costs</span></h3>
                
                <div class="input-group">
                    <div class="input-label">
                        <span data-i18n="maintenanceCosts">Annual Maintenance Costs</span>
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext" data-i18n="maintenanceCostsHelp">Annual costs for property maintenance, repairs, and upkeep. Typically 1-1.5% of property value per year.</span>
                        </div>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" id="autoMaintenance" checked>
                        <label for="autoMaintenance" data-i18n="autoMaintenance">Calculate automatically (1.25% of purchase price)</label>
                    </div>
                    <div class="input-container">
                        <input type="number" id="annualMaintenanceCosts" value="25000" step="1000" min="0" disabled>
                        <span class="unit" data-i18n="chfPerYear">CHF per year</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        <span data-i18n="propertyAppreciation">Property Appreciation Rate</span>
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext" data-i18n="propertyAppreciationHelp">Expected annual increase in property value. Swiss real estate has historically appreciated 1-3% annually.</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <input type="number" id="propertyAppreciation" value="1.0" step="0.1" min="-5" max="10">
                        <span class="unit" data-i18n="perYearPercent">% per year</span>
                    </div>
                </div>
            </div>
            
            <!-- Tax Parameters Section -->
            <div class="form-section">
                <h3><span data-i18n="secTax">Tax Parameters</span></h3>
                
                <div class="input-group">
                    <div class="input-label">
                        <span data-i18n="imputedRental">Imputed Rental Value</span>
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext" data-i18n="imputedRentalHelp">Taxable benefit of living in your own property. Swiss tax authorities typically assess this at 60-70% of market rent.</span>
                        </div>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" id="autoImputedRental" checked>
                        <label for="autoImputedRental" data-i18n="autoImputedRental">Calculate automatically (65% of annual rent)</label>
                    </div>
                    <div class="input-container">
                        <input type="number" id="imputedRentalValue" value="42900" step="1000" min="0" disabled>
                        <span class="unit" data-i18n="chfPerYear">CHF per year</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        <span data-i18n="propertyTaxDeductions">Property Tax Deductions</span>
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext" data-i18n="propertyTaxDeductionsHelp">Annual tax-deductible expenses for property ownership: maintenance, repairs, mortgage interest, insurance, utilities.</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <input type="number" id="propertyTaxDeductions" value="13000" step="1000" min="0">
                        <span class="unit" data-i18n="chfPerYear">CHF per year</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        <span data-i18n="marginalTaxRate">Marginal Tax Rate</span>
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext" data-i18n="marginalTaxRateHelp">Your marginal tax rate (federal + cantonal + municipal). Varies by canton and income level, typically 15-45%.</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <input type="number" id="marginalTaxRate" value="30.0" step="0.1" min="0" max="50">
                        <span class="unit">%</span>
                    </div>
                </div>
            </div>
            
            <!-- Rental Parameters Section -->
            <div class="form-section">
                <h3><span data-i18n="secRental">Rental Parameters</span></h3>
                
                <div class="input-group">
                    <div class="input-label">
                        <span data-i18n="monthlyRent">Monthly Rent</span>
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext" data-i18n="monthlyRentHelp">Monthly rent for a comparable property. This is the alternative to buying.</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <input type="number" id="monthlyRent" value="5500" step="100" min="0">
                        <span class="unit" data-i18n="chfPerMonth">CHF per month</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        <span data-i18n="annualRentalCosts">Annual Rental Costs</span>
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext" data-i18n="annualRentalCostsHelp">Additional annual costs when renting: utilities, insurance, small repairs not covered by landlord.</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <input type="number" id="annualRentalCosts" value="20000" step="1000" min="0">
                        <span class="unit" data-i18n="chfPerYear">CHF per year</span>
                    </div>
                </div>
            </div>
            
            <!-- Investment Parameters Section -->
            <div class="form-section">
                <h3><span data-i18n="secInvestment">Investment Parameters</span></h3>
                
                <div class="input-group">
                    <div class="input-label">
                        <span data-i18n="investmentYield">Investment Yield Rate</span>
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext" data-i18n="investmentYieldHelp">Expected annual return on alternative investments (stocks, bonds, funds) if you rent instead of buying.</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <input type="number" id="investmentYield" value="3.5" step="0.1" min="0" max="15">
                        <span class="unit" data-i18n="perYearPercent">% per year</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        <span data-i18n="analysisPeriod">Analysis Period</span>
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext" data-i18n="analysisPeriodHelp">Time horizon for the rent vs buy comparison. Typically 5-15 years to account for transaction costs and market cycles.</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <input type="number" id="termYears" value="10" step="1" min="1" max="30">
                        <span class="unit" data-i18n="years">years</span>
                    </div>
                </div>
            </div>
            
            <!-- Comparison Mode -->
            <div class="form-section">
                <h3><span data-i18n="secComparison">Comparison Mode</span></h3>
                <div class="input-group">
                    <div class="input-label">
                        <span data-i18n="scenario">Scenario</span>
                        <div class="tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltiptext" data-i18n="scenarioHelp">Choose how to compare rent vs buy: Equal consumption (standard baseline) or Equal savings (the renter also invests an amount equal to the buyer's amortization each year).</span>
                        </div>
                    </div>
                    <div class="input-container">
                        <label style="margin-right: 16px; display: inline-flex; align-items: center; gap: 6px;">
                            <input type="radio" name="scenarioMode" value="equalConsumption" checked>
                            <span data-i18n="equalConsumption">Equal consumption (baseline)</span>
                        </label>
                        <label style="display: inline-flex; align-items: center; gap: 6px;">
                            <input type="radio" name="scenarioMode" value="equalSavings">
                            <span data-i18n="equalSavings">Equal savings (invest the difference)</span>
                        </label>
                    </div>
                </div>

                <div style="margin-top: 10px; background: #f9f9fb; border: 1px solid #e5e5ea; border-left: 4px solid #007aff; border-radius: 8px; padding: 12px; font-size: 13px; line-height: 1.5; color: #1d1d1f;">
                    <div style="font-weight: 600; margin-bottom: 6px;" data-i18n="aboutScenarios">About these scenarios</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 10px;">
                        <div>
                            <div style="font-weight: 600; color: #0b7dda; margin-bottom: 4px;" data-i18n="equalConsumptionTitle">Equal consumption (standard)</div>
                            <ul style="margin: 0 0 0 16px; padding: 0;">
                                <li data-i18n="ec1">Compares the economic cost of housing services.</li>
                                <li data-i18n="ec2">Buyer's amortization is treated as equity and reflected via "− property value + remaining mortgage."</li>
                                <li data-i18n="ec3">Renter invests only the initial capital not tied up (down payment + purchase costs).</li>
                                <li data-i18n="ec4">Renter's investment income is taxed at your marginal rate.</li>
                                <li data-i18n="ec5">Matches common banking and regulatory framing.</li>
                            </ul>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #0b7dda; margin-bottom: 4px;" data-i18n="equalSavingsTitle">Equal savings (invest the difference)</div>
                            <ul style="margin: 0 0 0 16px; padding: 0;">
                                <li data-i18n="es1">Assumes renter also saves and invests the amortization-equivalent each year (during amortization period).</li>
                                <li data-i18n="es2">Those contributions compound at the investment yield; investment income is taxed.</li>
                                <li data-i18n="es3">Useful to test disciplined saving behavior and market-return sensitivity.</li>
                                <li data-i18n="es4">Typically shifts results toward renting when investment return > property appreciation.</li>
                            </ul>
                        </div>
                    </div>
                    <div style="margin-top: 8px; color: #3c3c43;" data-i18n="scenarioGuidance"><strong>Guidance:</strong> Use <em>Equal consumption</em> for baseline comparisons and affordability framing. Switch to <em>Equal savings</em> to answer "what if I invest with the same discipline as amortization?"</div>
                </div>
            </div>

            <button class="button" id="calculateBtn" data-i18n="calculate">Calculate</button>
            
            <div id="singleResults" class="results" style="display: none;"></div>
        </div>
        
        <!-- Max Bid Finder Tab -->
        <div class="tab-content" id="breakeven">
            <div style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid #007aff;">
                <p style="margin: 0; color: #1d1d1f; line-height: 1.5;" data-i18n="breakevenIntro">Find the maximum price you should bid for a property to break even with renting. This tool uses all your detailed parameters from the single calculation to find the purchase price where buying and renting have equal total costs.</p>
            </div>
            
            <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                <p style="margin: 0; color: #856404; line-height: 1.5;" data-i18n="breakevenHow"><strong>How it works:</strong> This tool copies all your detailed parameters from the Single Calculation tab and searches for the maximum purchase price where the financial benefit equals zero (break-even point). Only adjust the search parameters below if needed.</p>
            </div>
            
            <div class="form-section">
                <h3><span data-i18n="searchConfig">Search Configuration</span></h3>
                
                <div class="input-group">
                    <div class="input-label"><span data-i18n="minSearchPrice">Min Search Price</span></div>
                    <div class="input-container">
                        <input type="number" id="beMinPrice" value="1500000" step="10000">
                        <span class="unit">CHF</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label"><span data-i18n="maxSearchPrice">Max Search Price</span></div>
                    <div class="input-container">
                        <input type="number" id="beMaxPrice" value="10000000" step="10000">
                        <span class="unit">CHF</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label"><span data-i18n="searchTolerance">Search Tolerance</span></div>
                    <div class="input-container">
                        <input type="number" id="beTolerance" value="2500" step="500">
                        <span class="unit">CHF</span>
                    </div>
                </div>
            </div>
            
            <button class="button" id="breakevenBtn" data-i18n="findMaxBid">Find Max Bid Price</button>
            
            <div id="breakevenResults" class="results" style="display: none;"></div>
        </div>
        
        <!-- Parameter Sweep Tab -->
        <div class="tab-content" id="sweep">
            <div style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid #007aff;">
                <p style="margin: 0; color: #1d1d1f; line-height: 1.5;" data-i18n="sweepIntro">Analyze how changing market conditions affect the rent vs buy decision. This tool runs multiple scenarios across different property appreciation rates, investment yields, and mortgage rates, displaying results in an interactive color-coded table.</p>
            </div>
            <h3><span data-i18n="sweepConfig">Parameter Sweep Configuration</span></h3>
            
            <div class="sweep-controls">
                <div class="sweep-param">
                    <h4 data-i18n="sweepPropApp">Property Appreciation (%/year)</h4>
                    <div class="range-inputs">
                        <input type="number" id="propAppMin" placeholder="Min" value="-1" step="0.5">
                        <input type="number" id="propAppMax" placeholder="Max" value="5" step="0.5">
                        <input type="number" id="propAppStep" placeholder="Step" value="1" step="0.1">
                    </div>
                </div>
                
                <div class="sweep-param">
                    <h4 data-i18n="sweepInvYield">Investment Yield (%/year)</h4>
                    <div class="range-inputs">
                        <input type="number" id="invYieldMin" placeholder="Min" value="-1" step="0.5">
                        <input type="number" id="invYieldMax" placeholder="Max" value="8" step="0.5">
                        <input type="number" id="invYieldStep" placeholder="Step" value="1" step="0.1">
                    </div>
                </div>
                
                <div class="sweep-param">
                    <h4 data-i18n="sweepMortRate">Mortgage Rate (%)</h4>
                    <div class="range-inputs">
                        <input type="number" id="mortRateMin" placeholder="Min" value="1" step="0.1">
                        <input type="number" id="mortRateMax" placeholder="Max" value="5" step="0.1">
                        <input type="number" id="mortRateStep" placeholder="Step" value="1" step="0.1">
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <button class="button" id="sweepBtn" data-i18n="runSweep">Run Parameter Sweep</button>
            </div>
            
            <div id="sweepResults"></div>
        </div>
        
        <!-- About Tab -->
        <div class="tab-content" id="about">
            <div style="max-width: 800px;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="color: #007aff; margin-bottom: 10px;">Swiss Rent vs Buy Calculator</h2>
                    <div style="color: #666; font-size: 14px; margin-bottom: 5px;">Version <span id="app-version">2.1.0</span></div>
                    <div style="color: #666; font-size: 14px;">Created by <strong>d57udy</strong></div>
                </div>
                
                <!-- About content unchanged for now -->
                
                <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                    <h3 style="margin-top: 0; color: #1d1d1f;">Project Overview</h3>
                    <p style="line-height: 1.6; color: #333;">
                        This comprehensive financial calculator was created to facilitate informed home purchase decisions in Switzerland. 
                        It provides sophisticated analysis tools beyond traditional rent vs buy calculators, helping you make one of 
                        life's most important financial decisions with confidence.
                    </p>
                </div>

                <!-- ... existing code ... -->
            </div>
        </div>
    </div>

    <script src="calculator.js"></script>
    <script>
        // i18n translations
        const translations = {
            en: {
                appTitle: 'Swiss Rent vs Buy Calculator',
                loadParameters: 'Load Parameters',
                saveParameters: 'Save Parameters',
                tabSingle: 'Single Calculation',
                tabBreakeven: 'Max Bid Finder',
                tabSweep: 'Parameter Sweep',
                tabAbout: 'About',
                singleIntro: 'Calculate whether renting or buying a property makes more financial sense for your situation. This tool analyzes all costs, tax implications, and investment opportunities over your chosen time period to help you make an informed decision.',
                secPurchase: 'Purchase Parameters',
                purchasePrice: 'Purchase Price',
                purchasePriceHelp: 'The total price you would pay to purchase the property, including all costs.',
                downPaymentHeader: 'Down Payment / Mortgage Configuration',
                downPaymentHeaderHelp: 'Choose how to specify your financing: either set the down payment directly, calculate it automatically (20%), or maximize your mortgage up to a specified limit while maintaining the mandatory 20% minimum down payment.',
                autoDownPayment: 'Calculate down payment automatically (20% of purchase price)',
                manualDownPayment: 'Specify down payment manually',
                mortgageAmountMode: 'Maximize mortgage up to specified limit',
                mortgageAmountModeHelp: 'Sets the mortgage amount to your specified maximum, unless doing so would result in a down payment below 20% of the purchase price. In that case, the down payment is set to exactly 20% and the mortgage is reduced accordingly. Formula: Down Payment = max(20% × Purchase Price, Purchase Price - Max Mortgage)',
                downPaymentLabel: 'Down Payment:',
                maxMortgageLabel: 'Maximum Mortgage Amount:',
                warning: 'Warning:',
                downPaymentWarning: 'Down payment is below 20% minimum. Adjusting to 20%.',
                additionalCosts: 'Additional Purchase Costs',
                additionalCostsHelp: 'Additional costs when buying: notary fees, land registry, real estate agent commission, taxes.',
                totalRenovations: 'Total Renovations',
                totalRenovationsHelp: 'One-time renovation and improvement costs over the analysis period.',
                secMortgage: 'Mortgage Parameters',
                mortgageRate: 'Mortgage Interest Rate',
                mortgageRateHelp: 'Annual interest rate for your mortgage. Current Swiss rates typically range from 0.5% to 3%.',
                perYearPercent: '% per year',
                amortizationYears: 'Amortization Period',
                amortizationYearsHelp: 'Period over which you pay down the mortgage. Swiss regulations require amortization to 66.6% (2/3) LTV within 15 years.',
                years: 'years',
                annualAmortization: 'Annual Amortization Amount',
                annualAmortizationHelp: 'Annual amount paid to reduce mortgage principal. Choose calculation method below.',
                autoAmortization: 'Calculate automatically (mortgage ÷ amortization period)',
                swissAmortization: 'Swiss regulation: amortize to 66.6% (2/3) LTV within 15 years',
                swissAmortizationHelp: 'Swiss mortgage regulations require that mortgages above 66.6% LTV (second mortgage) must be amortized down to 66.6% (2/3) within 15 years. This calculates the minimum required annual amortization to comply with Swiss banking regulations. If your LTV is already 66.6% or below, no mandatory amortization is required.',
                manualAmortization: 'Specify amortization amount manually',
                chfPerYear: 'CHF per year',
                secPropertyCosts: 'Property Costs',
                maintenanceCosts: 'Annual Maintenance Costs',
                maintenanceCostsHelp: 'Annual costs for property maintenance, repairs, and upkeep. Typically 1-1.5% of property value per year.',
                autoMaintenance: 'Calculate automatically (1.25% of purchase price)',
                propertyAppreciation: 'Property Appreciation Rate',
                propertyAppreciationHelp: 'Expected annual increase in property value. Swiss real estate has historically appreciated 1-3% annually.',
                secTax: 'Tax Parameters',
                imputedRental: 'Imputed Rental Value',
                imputedRentalHelp: 'Taxable benefit of living in your own property. Swiss tax authorities typically assess this at 60-70% of market rent.',
                autoImputedRental: 'Calculate automatically (65% of annual rent)',
                propertyTaxDeductions: 'Property Tax Deductions',
                propertyTaxDeductionsHelp: 'Annual tax-deductible expenses for property ownership: maintenance, repairs, mortgage interest, insurance, utilities.',
                marginalTaxRate: 'Marginal Tax Rate',
                secRental: 'Rental Parameters',
                monthlyRent: 'Monthly Rent',
                monthlyRentHelp: 'Monthly rent for a comparable property. This is the alternative to buying.',
                chfPerMonth: 'CHF per month',
                annualRentalCosts: 'Annual Rental Costs',
                annualRentalCostsHelp: 'Additional annual costs when renting: utilities, insurance, small repairs not covered by landlord.',
                secInvestment: 'Investment Parameters',
                investmentYield: 'Investment Yield Rate',
                investmentYieldHelp: 'Expected annual return on alternative investments (stocks, bonds, funds) if you rent instead of buying.',
                analysisPeriod: 'Analysis Period',
                analysisPeriodHelp: 'Time horizon for the rent vs buy comparison. Typically 5-15 years to account for transaction costs and market cycles.',
                secComparison: 'Comparison Mode',
                scenario: 'Scenario',
                scenarioHelp: "Choose how to compare rent vs buy: Equal consumption (standard baseline) or Equal savings (the renter also invests an amount equal to the buyer's amortization each year).",
                equalConsumption: 'Equal consumption (baseline)',
                equalSavings: 'Equal savings (invest the difference)',
                aboutScenarios: 'About these scenarios',
                equalConsumptionTitle: 'Equal consumption (standard)',
                ec1: 'Compares the economic cost of housing services.',
                ec2: 'Buyer's amortization is treated as equity and reflected via "− property value + remaining mortgage."',
                ec3: 'Renter invests only the initial capital not tied up (down payment + purchase costs).',
                ec4: 'Renter's investment income is taxed at your marginal rate.',
                ec5: 'Matches common banking and regulatory framing.',
                equalSavingsTitle: 'Equal savings (invest the difference)',
                es1: 'Assumes renter also saves and invests the amortization-equivalent each year (during amortization period).',
                es2: 'Those contributions compound at the investment yield; investment income is taxed.',
                es3: 'Useful to test disciplined saving behavior and market-return sensitivity.',
                es4: 'Typically shifts results toward renting when investment return > property appreciation.',
                scenarioGuidance: 'Guidance: Use <em>Equal consumption</em> for baseline comparisons and affordability framing. Switch to <em>Equal savings</em> to answer "what if I invest with the same discipline as amortization?"',
                calculate: 'Calculate',
                breakevenIntro: 'Find the maximum price you should bid for a property to break even with renting. This tool uses all your detailed parameters from the single calculation to find the purchase price where buying and renting have equal total costs.',
                breakevenHow: 'How it works: This tool copies all your detailed parameters from the Single Calculation tab and searches for the maximum purchase price where the financial benefit equals zero (break-even). Passen Sie nur die Suchparameter unten bei Bedarf an.',
                searchConfig: 'Suchkonfiguration',
                minSearchPrice: 'Min. Suchpreis',
                maxSearchPrice: 'Max. Suchpreis',
                searchTolerance: 'Suchgenauigkeit',
                findMaxBid: 'Maximalgebot suchen',
                sweepIntro: 'Analysieren Sie, wie Marktänderungen die Entscheidung beeinflussen. Es werden mehrere Szenarien über Wertsteigerung, Renditen und Zinsen berechnet und farblich dargestellt.',
                sweepConfig: 'Konfiguration der Parametersimulation',
                sweepPropApp: 'Wertsteigerung (%/Jahr)',
                sweepInvYield: 'Rendite (%/Jahr)',
                sweepMortRate: 'Hypothekarzins (%)',
                runSweep: 'Simulation starten',
                // Dynamic results
                mode: 'Modus:',
                equalConsumptionShort: 'Equal consumption',
                equalSavingsShort: 'Equal savings',
                clickToToggle: 'Zum Ein-/Ausklappen klicken',
                monthlyBuying: 'Monatlich (Kauf)',
                monthlyRenting: 'Monatlich (Miete)',
                interest: 'Zinsen',
                amortization: 'Amortisation',
                maintenance: 'Unterhalt',
                total: 'Total',
                vsMonthlyRenting: 'vs. monatliche Miete',
                rent: 'Miete',
                supplementalCosts: 'Nebenkosten',
                investmentsAmortizationEq: 'Investitionen (Amortisationsäquivalent)',
                vsMonthlyBuying: 'vs. monatlicher Kauf',
                purchaseBreakdownTitle: 'Aufschlüsselung Kaufkosten',
                rentBreakdownTitle: 'Miete',
                interestCosts: 'Zinskosten',
                supplementalMaintenanceCosts: 'Unterhalt und Nebenkosten',
                renovationExpenses: 'Renovationsaufwand',
                additionalPurchaseExpenses: 'Zusätzliche Kaufkosten',
                generalCostOfPurchase: 'Gesamtkosten Kauf',
                taxDifferenceToRental: 'Steuerdifferenz zur Miete',
                minusPropertyValue: 'Minus Immobilienwert',
                mortgageAtEnd: 'Hypothek am Periodenende',
                totalPurchaseCost: 'Total Kaufkosten',
                rentGeneralCost: 'Gesamtkosten Miete',
                excludingYieldsOnAssets: 'Abzüglich Anlageerträge',
                excludingSavingsContributions: 'Abzüglich Sparbeiträge',
                excludingDownPayment: 'Abzüglich Eigenmittel',
                totalRentalCost: 'Total Mietkosten',
                yearByYear: 'Jahresübersicht',
                jumpToBreakeven: 'Zum Break-even springen (Jahr {year})',
                year: 'Jahr',
                mortgageBalance: 'Hypothekarsaldo',
                annualInterest: 'Zinsen',
                annualAmortization: 'Amortisation',
                annualMaintenance: 'Unterhalt',
                annualRent: 'Jahresmiete',
                cumulativeBuyCost: 'Kumulierte\nKaufkosten',
                cumulativeRentCost: 'Kumulierte\nMietkosten',
                advantage: 'Vorteil',
                howToRead: 'So lesen Sie die Tabelle:',
                how1: 'Hypothekarsaldo: Restschuld am Jahresende',
                how2: 'Kumulierte Kosten: Netto-Kosten inkl. Immobilienwert (Kauf) bzw. Anlageerträge (Miete)',
                how3: 'Vorteil: Positiv begünstigt Kauf, negativ begünstigt Miete',
                BUY: 'KAUF',
                RENT: 'MIETE',
                EVEN: 'GLEICH'
            },
            de: {
                appTitle: 'Schweizer Miet- oder Kaufrechner',
                loadParameters: 'Parameter laden',
                saveParameters: 'Parameter speichern',
                tabSingle: 'Einzelberechnung',
                tabBreakeven: 'Maximalgebot finden',
                tabSweep: 'Parametersimulation',
                tabAbout: 'Info',
                singleIntro: 'Berechnen Sie, ob Mieten oder Kaufen für Ihre Situation finanziell sinnvoller ist. Dieses Tool analysiert alle Kosten, Steueraspekte und Anlagemöglichkeiten über den gewählten Zeitraum, um eine fundierte Entscheidung zu ermöglichen.',
                secPurchase: 'Kaufparameter',
                purchasePrice: 'Kaufpreis',
                purchasePriceHelp: 'Gesamter Preis für den Immobilienkauf, inklusive aller Kosten.',
                downPaymentHeader: 'Eigenmittel / Hypotheken-Konfiguration',
                downPaymentHeaderHelp: 'Wählen Sie die Finanzierung: Eigenmittel direkt angeben, automatisch berechnen (20%) oder die Hypothek bis zu einem Grenzwert maximieren (unter Einhaltung der 20%-Mindest-Eigenmittel).',
                autoDownPayment: 'Eigenmittel automatisch berechnen (20% des Kaufpreises)',
                manualDownPayment: 'Eigenmittel manuell angeben',
                mortgageAmountMode: 'Hypothek bis zum Grenzwert maximieren',
                mortgageAmountModeHelp: 'Setzt die Hypothek auf den angegebenen Maximalbetrag, ausser dies würde zu Eigenmitteln unter 20% führen. In diesem Fall werden genau 20% Eigenmittel gesetzt und die Hypothek entsprechend reduziert. Formel: Eigenmittel = max(20% × Kaufpreis, Kaufpreis − maximale Hypothek)',
                downPaymentLabel: 'Eigenmittel:',
                maxMortgageLabel: 'Maximale Hypothek:',
                warning: 'Hinweis:',
                downPaymentWarning: 'Eigenmittel unter 20%-Minimum. Anpassung auf 20%.',
                additionalCosts: 'Zusätzliche Kaufkosten',
                additionalCostsHelp: 'Zusätzliche Kosten beim Kauf: Notar, Grundbuch, Maklerprovision, Steuern.',
                totalRenovations: 'Gesamte Renovationen',
                totalRenovationsHelp: 'Einmalige Renovations- und Verbesserungsaufwände über den Analysezeitraum.',
                secMortgage: 'Hypothekenparameter',
                mortgageRate: 'Hypothekarzins',
                mortgageRateHelp: 'Jährlicher Zinssatz der Hypothek. Aktuelle Schweizer Sätze typischerweise 0.5–3%.',
                perYearPercent: '% pro Jahr',
                amortizationYears: 'Amortisationsdauer',
                amortizationYearsHelp: 'Zeitraum für den Schuldenabbau. Schweizer Regeln verlangen Amortisation auf 66.6% (2/3) Belehnung innerhalb von 15 Jahren.',
                years: 'Jahre',
                annualAmortization: 'Jährliche Amortisation',
                annualAmortizationHelp: 'Jährlicher Betrag zur Reduktion der Hypothek. Methode unten wählen.',
                autoAmortization: 'Automatisch berechnen (Hypothek ÷ Amortisationsdauer)',
                swissAmortization: 'Schweizer Regel: auf 66.6% (2/3) LTV in 15 Jahren amortisieren',
                swissAmortizationHelp: 'Schweizer Hypothekregeln verlangen, dass Hypotheken über 66.6% LTV (zweite Hypothek) innert 15 Jahren auf 66.6% amortisiert werden. Ist die Belehnung bereits ≤ 66.6%, ist keine Pflichtamortisation nötig.',
                manualAmortization: 'Amortisation manuell angeben',
                chfPerYear: 'CHF pro Jahr',
                secPropertyCosts: 'Liegenschaftskosten',
                maintenanceCosts: 'Jährliche Unterhaltskosten',
                maintenanceCostsHelp: 'Jährliche Kosten für Unterhalt und Reparaturen. Typischerweise 1–1.5% des Werts pro Jahr.',
                autoMaintenance: 'Automatisch berechnen (1.25% des Kaufpreises)',
                propertyAppreciation: 'Wertsteigerung der Immobilie',
                propertyAppreciationHelp: 'Erwartete jährliche Wertsteigerung. Historisch 1–3% p.a. in der Schweiz.',
                secTax: 'Steuerparameter',
                imputedRental: 'Eigenmietwert',
                imputedRentalHelp: 'Steuerbarer Vorteil des Selbstbewohnens. In der Schweiz meist 60–70% der Marktmiete.',
                autoImputedRental: 'Automatisch berechnen (65% der Jahresmiete)',
                propertyTaxDeductions: 'Abzüge Liegenschaftskosten',
                propertyTaxDeductionsHelp: 'Jährlich abzugsfähige Ausgaben: Unterhalt, Reparaturen, Hypothekarzinsen, Versicherungen, Nebenkosten.',
                marginalTaxRate: 'Grenzsteuersatz',
                secRental: 'Mietparameter',
                monthlyRent: 'Monatsmiete',
                monthlyRentHelp: 'Monatliche Miete einer vergleichbaren Wohnung/Haus. Alternative zum Kauf.',
                chfPerMonth: 'CHF pro Monat',
                annualRentalCosts: 'Jährliche Mietnebenkosten',
                annualRentalCostsHelp: 'Zusätzliche jährliche Kosten beim Mieten: Nebenkosten, Versicherungen, kleine Reparaturen.',
                secInvestment: 'Anlageparameter',
                investmentYield: 'Anlagerendite',
                investmentYieldHelp: 'Erwartete jährliche Rendite alternativer Anlagen (Aktien, Obligationen, Fonds), falls gemietet wird.',
                analysisPeriod: 'Analysezeitraum',
                analysisPeriodHelp: 'Zeithorizont für den Vergleich Mieten vs. Kaufen. Typisch 5–15 Jahre.',
                secComparison: 'Vergleichsmodus',
                scenario: 'Szenario',
                scenarioHelp: 'Vergleichsart wählen: Gleiches Konsum-Niveau (Standard) oder Gleiches Sparen (Renter investiert zusätzlich die Amortisationsbeträge).',
                equalConsumption: 'Gleicher Konsum (Basis)',
                equalSavings: 'Gleiches Sparen (Differenz investieren)',
                aboutScenarios: 'Hinweise zu den Szenarien',
                equalConsumptionTitle: 'Gleicher Konsum (Standard)',
                ec1: 'Vergleicht die wirtschaftlichen Wohnkosten.',
                ec2: 'Amortisation des Käufers gilt als Eigenkapital und wird via "− Immobilienwert + Resthypothek" berücksichtigt.',
                ec3: 'Mieter investiert nur das anfänglich freie Kapital (Eigenmittel + Kaufkosten).',
                ec4: 'Kapitalerträge des Mieters werden zum Grenzsteuersatz besteuert.',
                ec5: 'Entspricht gängiger Bank- und Regulierungslogik.',
                equalSavingsTitle: 'Gleiches Sparen (Differenz investieren)',
                es1: 'Unterstellt, dass der Mieter zusätzlich die Amortisationsbeträge jährlich spart und investiert (während der Amortisation).',
                es2: 'Diese Beiträge verzinsen sich mit der Anlagerendite; Erträge werden besteuert.',
                es3: 'Nützlich zur Prüfung disziplinierten Sparens und Rendite-Sensitivität.',
                es4: 'Verschiebt Resultate oft Richtung Mieten, wenn Rendite > Wertsteigerung.',
                scenarioGuidance: 'Hinweis: <em>Gleicher Konsum</em> für Basis- und Finanzierbarkeitsvergleiche nutzen. <em>Gleiches Sparen</em> beantwortet: "Was, wenn ich genauso diszipliniert spare wie amortisiere?"',
                calculate: 'Berechnen',
                breakevenIntro: 'Finden Sie den maximalen Kaufpreis, bei dem Kaufen mit Mieten gleichzieht. Alle Parameter aus der Einzelberechnung werden übernommen.',
                breakevenHow: 'Funktionsweise: Kopiert die Parameter der Einzelberechnung und sucht den Kaufpreis, bei dem der finanzielle Vorteil null ist (Break-even). Passen Sie nur die Suchparameter unten bei Bedarf an.',
                searchConfig: 'Suchkonfiguration',
                minSearchPrice: 'Min. Suchpreis',
                maxSearchPrice: 'Max. Suchpreis',
                searchTolerance: 'Suchgenauigkeit',
                findMaxBid: 'Maximalgebot suchen',
                sweepIntro: 'Analysieren Sie, wie Marktänderungen die Entscheidung beeinflussen. Es werden mehrere Szenarien über Wertsteigerung, Renditen und Zinsen berechnet und farblich dargestellt.',
                sweepConfig: 'Konfiguration der Parametersimulation',
                sweepPropApp: 'Wertsteigerung (%/Jahr)',
                sweepInvYield: 'Rendite (%/Jahr)',
                sweepMortRate: 'Hypothekarzins (%)',
                runSweep: 'Simulation starten',
                // Dynamic results
                mode: 'Modus:',
                equalConsumptionShort: 'Gleicher Konsum',
                equalSavingsShort: 'Gleiches Sparen',
                clickToToggle: 'Zum Ein-/Ausklappen klicken',
                monthlyBuying: 'Monatlich (Kauf)',
                monthlyRenting: 'Monatlich (Miete)',
                interest: 'Zinsen',
                amortization: 'Amortisation',
                maintenance: 'Unterhalt',
                total: 'Total',
                vsMonthlyRenting: 'vs. monatliche Miete',
                rent: 'Miete',
                supplementalCosts: 'Nebenkosten',
                investmentsAmortizationEq: 'Investitionen (Amortisationsäquivalent)',
                vsMonthlyBuying: 'vs. monatlicher Kauf',
                purchaseBreakdownTitle: 'Aufschlüsselung Kaufkosten',
                rentBreakdownTitle: 'Miete',
                interestCosts: 'Zinskosten',
                supplementalMaintenanceCosts: 'Unterhalt und Nebenkosten',
                renovationExpenses: 'Renovationsaufwand',
                additionalPurchaseExpenses: 'Zusätzliche Kaufkosten',
                generalCostOfPurchase: 'Gesamtkosten Kauf',
                taxDifferenceToRental: 'Steuerdifferenz zur Miete',
                minusPropertyValue: 'Minus Immobilienwert',
                mortgageAtEnd: 'Hypothek am Periodenende',
                totalPurchaseCost: 'Total Kaufkosten',
                rentGeneralCost: 'Gesamtkosten Miete',
                excludingYieldsOnAssets: 'Abzüglich Anlageerträge',
                excludingSavingsContributions: 'Abzüglich Sparbeiträge',
                excludingDownPayment: 'Abzüglich Eigenmittel',
                totalRentalCost: 'Total Mietkosten',
                yearByYear: 'Jahresübersicht',
                jumpToBreakeven: 'Zum Break-even springen (Jahr {year})',
                year: 'Jahr',
                mortgageBalance: 'Hypothekarsaldo',
                annualInterest: 'Zinsen',
                annualAmortization: 'Amortisation',
                annualMaintenance: 'Unterhalt',
                annualRent: 'Jahresmiete',
                cumulativeBuyCost: 'Kumulierte\nKaufkosten',
                cumulativeRentCost: 'Kumulierte\nMietkosten',
                advantage: 'Vorteil',
                howToRead: 'So lesen Sie die Tabelle:',
                how1: 'Hypothekarsaldo: Restschuld am Jahresende',
                how2: 'Kumulierte Kosten: Netto-Kosten inkl. Immobilienwert (Kauf) bzw. Anlageerträge (Miete)',
                how3: 'Vorteil: Positiv begünstigt Kauf, negativ begünstigt Miete',
                BUY: 'KAUF',
                RENT: 'MIETE',
                EVEN: 'GLEICH'
            }
        };

        let currentLang = localStorage.getItem('ui_lang') || 'en';
        const t = (key, params = {}) => {
            const str = translations[currentLang][key] ?? translations.en[key] ?? key;
            return str.replace(/\{(\w+)\}/g, (_, k) => params[k] ?? '');
        };

        function applyTranslations() {
            document.documentElement.lang = currentLang;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.innerHTML = t(key);
            });
            // Update lang switch active state
            document.getElementById('langEn').classList.toggle('active', currentLang === 'en');
            document.getElementById('langDe').classList.toggle('active', currentLang === 'de');

            // Re-render results if visible and lastResult present
            if (window.__lastSingleResult) {
                displaySingleResult(window.__lastSingleResult);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('langEn').addEventListener('click', () => {
                currentLang = 'en';
                localStorage.setItem('ui_lang', currentLang);
                applyTranslations();
            });
            document.getElementById('langDe').addEventListener('click', () => {
                currentLang = 'de';
                localStorage.setItem('ui_lang', currentLang);
                applyTranslations();
            });
            applyTranslations();
        });
        // ... existing code ...
        // Auto-calculation functions
        function updateCalculatedFields() {
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
            const monthlyRent = parseFloat(document.getElementById('monthlyRent').value) || 0;
            const amortizationYears = parseFloat(document.getElementById('amortizationYears').value) || 10;
            
            // Handle down payment modes
            const downPaymentMode = document.querySelector('input[name="downPaymentMode"]:checked').value;
            let downPayment = 0;
            let actualMortgageAmount = 0;
            let showWarning = false;
            
            if (downPaymentMode === 'auto') {
                // Auto down payment (20%)
                downPayment = Math.round(purchasePrice * 0.2);
                document.getElementById('downPayment').value = downPayment;
                document.getElementById('downPayment').disabled = true;
                document.getElementById('downPaymentInput').style.display = 'block';
                document.getElementById('mortgageAmountInput').style.display = 'none';
            } else if (downPaymentMode === 'manual') {
                // Manual down payment with 20% minimum validation
                downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
                const minDownPayment = Math.round(purchasePrice * 0.2);
                if (downPayment < minDownPayment && purchasePrice > 0) {
                    downPayment = minDownPayment;
                    document.getElementById('downPayment').value = downPayment;
                    showWarning = true;
                }
                document.getElementById('downPayment').disabled = false;
                document.getElementById('downPaymentInput').style.display = 'block';
                document.getElementById('mortgageAmountInput').style.display = 'none';
            } else if (downPaymentMode === 'mortgage') {
                // Maximize mortgage up to specified limit, respecting 20% minimum down payment
                const maxMortgageLimit = parseFloat(document.getElementById('mortgageAmount').value) || 0;
                const minDownPayment = Math.round(purchasePrice * 0.2);
                const maxPossibleMortgage = purchasePrice - minDownPayment;
                
                // Use the smaller of: user's limit or what's possible with 20% down payment
                actualMortgageAmount = Math.min(maxMortgageLimit, maxPossibleMortgage);
                downPayment = purchasePrice - actualMortgageAmount;
                
                // Ensure we never go below 20% down payment
                if (downPayment < minDownPayment && purchasePrice > 0) {
                    downPayment = minDownPayment;
                    actualMortgageAmount = purchasePrice - downPayment;
                    showWarning = true;
                }
                
                document.getElementById('downPayment').value = downPayment;
                document.getElementById('downPayment').disabled = true;
                document.getElementById('downPaymentInput').style.display = 'block';
                document.getElementById('mortgageAmountInput').style.display = 'block';
            }
            
            // Show/hide warning
            document.getElementById('downPaymentWarning').style.display = showWarning ? 'block' : 'none';
            
            // Calculate final mortgage amount for other calculations
            const finalMortgageAmount = purchasePrice - downPayment;
            
            // Auto maintenance (1.25%)
            if (document.getElementById('autoMaintenance').checked) {
                document.getElementById('annualMaintenanceCosts').value = Math.round(purchasePrice * 0.0125);
                document.getElementById('annualMaintenanceCosts').disabled = true;
            } else {
                document.getElementById('annualMaintenanceCosts').disabled = false;
            }
            
            // Handle amortization modes
            const amortizationMode = document.querySelector('input[name="amortizationMode"]:checked').value;
            
            if (amortizationMode === 'auto') {
                // Standard calculation: mortgage ÷ amortization period
                document.getElementById('annualAmortization').value = Math.round(finalMortgageAmount / amortizationYears);
                document.getElementById('annualAmortization').disabled = true;
            } else if (amortizationMode === 'swiss') {
                // Swiss regulation: amortize to 66.6% (2/3) LTV within 15 years
                const currentLTV = finalMortgageAmount / purchasePrice;
                const targetLTV = 2/3; // 66.6%
                
                if (currentLTV > targetLTV) {
                    // Calculate amount needed to amortize down to 66.6% LTV
                    const targetMortgageAmount = purchasePrice * targetLTV;
                    const amortizationNeeded = finalMortgageAmount - targetMortgageAmount;
                    // Divide by 15 years (Swiss regulation requirement)
                    const swissAnnualAmortization = Math.round(amortizationNeeded / 15);
                    document.getElementById('annualAmortization').value = swissAnnualAmortization;
                } else {
                    // If already at or below 66.6% LTV, no mandatory amortization required
                    document.getElementById('annualAmortization').value = 0;
                }
                document.getElementById('annualAmortization').disabled = true;
            } else {
                // Manual mode
                document.getElementById('annualAmortization').disabled = false;
            }
            
            // Auto imputed rental (65% of annual rent)
            if (document.getElementById('autoImputedRental').checked) {
                document.getElementById('imputedRentalValue').value = Math.round(monthlyRent * 12 * 0.65);
                document.getElementById('imputedRentalValue').disabled = true;
            } else {
                document.getElementById('imputedRentalValue').disabled = false;
            }
        }
        
        // Tab functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tabName).classList.add('active');
            });
        });

        // Auto-calculation event listeners
        document.getElementById('purchasePrice').addEventListener('input', updateCalculatedFields);
        document.getElementById('downPayment').addEventListener('input', updateCalculatedFields);
        document.getElementById('mortgageAmount').addEventListener('input', updateCalculatedFields);
        document.getElementById('monthlyRent').addEventListener('input', updateCalculatedFields);
        document.getElementById('amortizationYears').addEventListener('input', updateCalculatedFields);
        
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateCalculatedFields);
        });
        
        document.querySelectorAll('input[name="downPaymentMode"]').forEach(radio => {
            radio.addEventListener('change', updateCalculatedFields);
        });
        
        document.querySelectorAll('input[name="amortizationMode"]').forEach(radio => {
            radio.addEventListener('change', updateCalculatedFields);
        });

        // Single calculation
        document.getElementById('calculateBtn').addEventListener('click', () => {
            const params = {
                purchasePrice: parseFloat(document.getElementById('purchasePrice').value),
                downPayment: parseFloat(document.getElementById('downPayment').value),
                mortgageRate: parseFloat(document.getElementById('mortgageRate').value) / 100,
                monthlyRent: parseFloat(document.getElementById('monthlyRent').value),
                propertyAppreciationRate: parseFloat(document.getElementById('propertyAppreciation').value) / 100,
                investmentYieldRate: parseFloat(document.getElementById('investmentYield').value) / 100,
                marginalTaxRate: parseFloat(document.getElementById('marginalTaxRate').value) / 100,
                termYears: parseInt(document.getElementById('termYears').value),
                annualMaintenanceCosts: parseFloat(document.getElementById('annualMaintenanceCosts').value),
                amortizationYears: parseInt(document.getElementById('amortizationYears').value),
                annualAmortization: parseFloat(document.getElementById('annualAmortization').value),
                totalRenovations: parseFloat(document.getElementById('totalRenovations').value),
                additionalPurchaseCosts: parseFloat(document.getElementById('additionalPurchaseCosts').value),
                imputedRentalValue: parseFloat(document.getElementById('imputedRentalValue').value),
                propertyTaxDeductions: parseFloat(document.getElementById('propertyTaxDeductions').value),
                annualRentalCosts: parseFloat(document.getElementById('annualRentalCosts').value),
                scenarioMode: document.querySelector('input[name="scenarioMode"]:checked')?.value || 'equalConsumption'
            };

            const result = SwissRentBuyCalculator.calculate(params);
            window.__lastSingleResult = result;
            displaySingleResult(result);
        });

        function displaySingleResult(result) {
            const resultsDiv = document.getElementById('singleResults');
            const decisionKey = result.Decision; // BUY/RENT/EVEN
            const decisionClass = result.Decision.toLowerCase();
            const modeText = result.ScenarioMode === 'equalSavings' ? t('equalSavingsShort') : t('equalConsumptionShort');
            const modeInfo = result.ScenarioMode === 'equalSavings'
                ? (currentLang === 'de' ? 'Mieter investiert jährlich den Amortisationsbetrag; Erträge werden besteuert.' : 'Renter invests amortization-equivalent each year; gains taxed.')
                : (currentLang === 'de' ? 'Mieter investiert nur das anfängliche freie Kapital; Erträge werden besteuert.' : 'Renter invests initial capital only (down payment + costs); gains taxed.');

            // Localized compare text
            let compareTextLocal = result.CompareText;
            const diffAbs = Math.abs(result.ResultValue).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            if (currentLang === 'de') {
                if (result.ResultValue > 0) {
                    compareTextLocal = `Kaufen ist um CHF ${diffAbs} günstiger als Mieten über den relevanten Zeitraum.`;
                } else if (result.ResultValue < 0) {
                    compareTextLocal = `Mieten ist um CHF ${diffAbs} günstiger als Kaufen über den relevanten Zeitraum.`;
                } else {
                    compareTextLocal = 'Kaufen und Mieten kosten über den relevanten Zeitraum gleich viel.';
                }
            }

            // Compute monthly comparison deltas
            const buyMonthly = result.TotalMonthlyExpenses || 0;
            const rentMonthly = result.TotalMonthlyRentingExpenses || 0;
            const buyVsRentDelta = Math.round(buyMonthly - rentMonthly);
            const rentVsBuyDelta = -buyVsRentDelta;

            // Compute break-even year
            let breakEvenYear = null;
            if (Array.isArray(result.YearlyBreakdown)) {
                for (let i = 0; i < result.YearlyBreakdown.length; i++) {
                    const curr = result.YearlyBreakdown[i].cumulativeAdvantage;
                    const prev = i > 0 ? result.YearlyBreakdown[i - 1].cumulativeAdvantage : null;
                    if ((prev !== null && prev < 0 && curr >= 0) || (i === 0 && curr >= 0)) {
                        breakEvenYear = result.YearlyBreakdown[i].year;
                        break;
                    }
                }
                if (!breakEvenYear) {
                    let minAbs = Infinity;
                    result.YearlyBreakdown.forEach(y => {
                        const a = Math.abs(y.cumulativeAdvantage);
                        if (a < minAbs) { minAbs = a; breakEvenYear = y.year; }
                    });
                }
            }

            function section(title, color, id, inner) {
                return `
                <div class="collapsible" style="margin-bottom: 16px; background: white; border: 1px solid #e5e5ea; border-left: 4px solid ${color}; border-radius: 8px; overflow: hidden;">
                    <div class="collapsible-header" data-target="${id}" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; background: #f8f9fa;">
                        <div style="font-weight: 600; color: #1d1d1f;">${title}</div>
                        <div style="color: #6c757d; font-size: 12px;">${t('clickToToggle')}</div>
                    </div>
                    <div id="${id}" class="collapsible-body" style="padding: 14px;">
                        ${inner}
                    </div>
                </div>`;
            }

            const summary = `
                <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                    <div style="flex: 1; padding: 16px; background: white; border-radius: 8px; border-left: 4px solid ${decisionClass === 'buy' ? '#34c759' : decisionClass === 'rent' ? '#ff3b30' : '#ff9500'};">
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: ${decisionClass === 'buy' ? '#34c759' : decisionClass === 'rent' ? '#ff3b30' : '#ff9500'};">${t(decisionKey)}</div>
                        <div style="font-size: 15px; color: #1d1d1f;">${compareTextLocal}</div>
                    </div>
                    <div title="${modeInfo}" style="white-space: nowrap; font-size: 12px; color: #1d1d1f; background: #f2f2f7; border: 1px solid #e5e5ea; padding: 8px 10px; border-radius: 999px;">${t('mode')} <strong>${modeText}</strong></div>
                </div>`;

            const buyDeltaText = buyVsRentDelta >= 0 ? `+CHF ${buyVsRentDelta.toLocaleString()}` : `CHF ${Math.abs(buyVsRentDelta).toLocaleString()} less`;
            const buyDeltaColor = buyVsRentDelta >= 0 ? '#ff3b30' : '#34c759';
            const rentDeltaText = rentVsBuyDelta >= 0 ? `+CHF ${rentVsBuyDelta.toLocaleString()}` : `CHF ${Math.abs(rentVsBuyDelta).toLocaleString()} less`;
            const rentDeltaColor = rentVsBuyDelta >= 0 ? '#ff3b30' : '#34c759';

            const buyDeltaTextLoc = currentLang === 'de'
                ? (buyVsRentDelta >= 0 ? `+CHF ${buyVsRentDelta.toLocaleString()}` : `CHF ${Math.abs(buyVsRentDelta).toLocaleString()} weniger`)
                : buyDeltaText;
            const rentDeltaTextLoc = currentLang === 'de'
                ? (rentVsBuyDelta >= 0 ? `+CHF ${rentVsBuyDelta.toLocaleString()}` : `CHF ${Math.abs(rentVsBuyDelta).toLocaleString()} weniger`)
                : rentDeltaText;

            const monthlySnapshot = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px;">
                    <div style="padding: 14px; background: #f0f8ff; border: 1px solid #d6e9ff; border-radius: 8px;">
                        <div style="font-weight: 600; color: #007aff; margin-bottom: 8px;">${t('monthlyBuying')}</div>
                        <div class="result-item" style="border-bottom: 1px solid #d2d2d7; margin-bottom: 8px;"><span>${t('interest')}</span><span>CHF ${result.MonthlyInterestPayment.toLocaleString()}</span></div>
                        <div class="result-item" style="border-bottom: 1px solid #d2d2d7; margin-bottom: 8px;"><span>${t('amortization')}</span><span>CHF ${result.MonthlyAmortizationPayment.toLocaleString()}</span></div>
                        <div class="result-item" style="border-bottom: 1px solid #d2d2d7; margin-bottom: 8px;"><span>${t('maintenance')}</span><span>CHF ${result.MonthlyMaintenanceCosts.toLocaleString()}</span></div>
                        <div class="result-item" style="font-weight: 600; color: #007aff;"><span>${t('total')}</span><span>CHF ${result.TotalMonthlyExpenses.toLocaleString()}</span></div>
                        <div class="result-item" style="margin-top: 6px; color: ${buyDeltaColor};"><span>${t('vsMonthlyRenting')}</span><span>${buyDeltaTextLoc}</span></div>
                    </div>
                    <div style="padding: 14px; background: #fff7e6; border: 1px solid #ffe3b3; border-radius: 8px;">
                        <div style="font-weight: 600; color: #ff9500; margin-bottom: 8px;">${t('monthlyRenting')}</div>
                        <div class="result-item" style="border-bottom: 1px solid #d2d2d7; margin-bottom: 8px;"><span>${t('rent')}</span><span>CHF ${result.MonthlyRentPayment.toLocaleString()}</span></div>
                        <div class="result-item" style="border-bottom: 1px solid #d2d2d7; margin-bottom: 8px;"><span>${t('supplementalCosts')}</span><span>CHF ${result.MonthlyRentalCosts.toLocaleString()}</span></div>
                        ${result.ScenarioMode === 'equalSavings' ? `<div class="result-item" style="border-bottom: 1px solid #d2d2d7; margin-bottom: 8px;"><span>${t('investmentsAmortizationEq')}</span><span>CHF ${result.MonthlySavingsContribution.toLocaleString()}</span></div>` : ''}
                        <div class="result-item" style="font-weight: 600; color: #ff9500;"><span>${t('total')}</span><span>CHF ${result.TotalMonthlyRentingExpenses.toLocaleString()}</span></div>
                        <div class="result-item" style="margin-top: 6px; color: ${rentDeltaColor};"><span>${t('vsMonthlyBuying')}</span><span>${rentDeltaTextLoc}</span></div>
                    </div>
                </div>`;

            const purchaseBreakdown = `
                <div class="result-item"><span>${t('interestCosts')}</span><span>CHF ${Math.round(result.InterestCosts).toLocaleString()}.00</span></div>
                <div class="result-item"><span>${t('supplementalMaintenanceCosts')}</span><span>CHF ${Math.round(result.SupplementalMaintenanceCosts).toLocaleString()}.00</span></div>
                <div class="result-item"><span>${t('amortization')}</span><span>CHF ${Math.round(result.AmortizationCosts).toLocaleString()}.00</span></div>
                <div class="result-item"><span>${t('renovationExpenses')}</span><span>CHF ${Math.round(result.RenovationExpenses).toLocaleString()}.00</span></div>
                <div class="result-item"><span>${t('additionalPurchaseExpenses')}</span><span>CHF ${Math.round(result.AdditionalPurchaseExpensesOutput).toLocaleString()}.00</span></div>
                <div class="result-item" style="font-weight: 600; background-color: #f0f8ff;"><span>${t('generalCostOfPurchase')}</span><span>CHF ${Math.round(result.GeneralCostOfPurchase).toLocaleString()}.00</span></div>
                <div class="result-item"><span>${t('taxDifferenceToRental')}</span><span>CHF ${Math.round(result.TaxDifferenceToRental).toLocaleString()}.${Math.abs(Math.round((result.TaxDifferenceToRental % 1) * 100)).toString().padStart(2, '0')}</span></div>
                <div class="result-item"><span>${t('minusPropertyValue')}</span><span>CHF ${Math.round(result.MinusPropertyValue).toLocaleString()}.${Math.abs(Math.round((result.MinusPropertyValue % 1) * 100)).toString().padStart(2, '0')}</span></div>
                <div class="result-item"><span>${t('mortgageAtEnd')}</span><span>CHF ${Math.round(result.MortgageAtEndOfRelevantTimePeriod).toLocaleString()}.00</span></div>
                <div class="result-item" style="font-weight: 600; background-color: #f0f8ff;"><span>${t('totalPurchaseCost')}</span><span>CHF ${Math.round(result.TotalPurchaseCost).toLocaleString()}.${Math.abs(Math.round((result.TotalPurchaseCost % 1) * 100)).toString().padStart(2, '0')}</span></div>`;

            const rentBreakdown = `
                <div class="result-item"><span>${t('rentGeneralCost')}</span><span>CHF ${Math.round(result.GeneralCostOfRental).toLocaleString()}.00</span></div>
                <div class="result-item"><span>${t('excludingYieldsOnAssets')}</span><span>CHF ${Math.round(result.ExcludingYieldsOnAssets).toLocaleString()}.${Math.abs(Math.round((result.ExcludingYieldsOnAssets % 1) * 100)).toString().padStart(2, '0')}</span></div>
                ${result.ScenarioMode === 'equalSavings' ? `<div class="result-item"><span>${t('excludingSavingsContributions')}</span><span>CHF ${Math.round(result.ExcludingSavingsContributions).toLocaleString()}.00</span></div>` : ''}
                <div class="result-item"><span>${t('excludingDownPayment')}</span><span>CHF ${Math.round(result.ExcludingDownPayment).toLocaleString()}.00</span></div>
                <div class="result-item" style="font-weight: 600; background-color: #f0f8ff;"><span>${t('totalRentalCost')}</span><span>CHF ${Math.round(result.TotalRentalCost).toLocaleString()}.${Math.abs(Math.round((result.TotalRentalCost % 1) * 100)).toString().padStart(2, '0')}</span></div>`;

            const yearRows = result.YearlyBreakdown.map((y, index) => {
                const rowId = `year-row-${y.year}`;
                return `
                <tr id="${rowId}" style="border-bottom: 1px solid #dee2e6; ${index % 2 === 0 ? 'background: #f8f9fa;' : 'background: white;'}">
                    <td style="padding: 10px 8px; font-weight: 600;">${y.year}</td>
                    <td style="padding: 10px 8px; text-align: right;">${Math.round(y.endingBalance).toLocaleString()}</td>
                    <td style="padding: 10px 8px; text-align: right;">${Math.round(y.annualInterest).toLocaleString()}</td>
                    <td style="padding: 10px 8px; text-align: right;">${Math.round(y.annualAmortization).toLocaleString()}</td>
                    <td style="padding: 10px 8px; text-align: right;">${Math.round(y.annualMaintenance).toLocaleString()}</td>
                    <td style="padding: 10px 8px; text-align: right;">${Math.round(y.annualRent).toLocaleString()}</td>
                    <td style="padding: 10px 8px; text-align: right; ${y.totalPurchaseCostToDate < 0 ? 'color: #28a745; font-weight: 600;' : 'color: #dc3545;'}">${y.totalPurchaseCostToDate >= 0 ? '' : '-'}${Math.abs(Math.round(y.totalPurchaseCostToDate)).toLocaleString()}</td>
                    <td style="padding: 10px 8px; text-align: right; ${y.totalRentalCostToDate < 0 ? 'color: #28a745; font-weight: 600;' : 'color: #dc3545;'}">${y.totalRentalCostToDate >= 0 ? '' : '-'}${Math.abs(Math.round(y.totalRentalCostToDate)).toLocaleString()}</td>
                    <td style="padding: 10px 8px; text-align: right; font-weight: 600; ${y.cumulativeAdvantage > 0 ? 'color: #28a745;' : y.cumulativeAdvantage < 0 ? 'color: #dc3545;' : 'color: #6c757d;'}"><span style="font-size: 11px; margin-right: 4px;">${t(y.cumulativeAdvantage > 0 ? 'BUY' : y.cumulativeAdvantage < 0 ? 'RENT' : 'EVEN')}</span>${y.cumulativeAdvantage >= 0 ? '+' : ''}${Math.round(y.cumulativeAdvantage).toLocaleString()}</td>
                </tr>`;
            }).join('');

            const yearByYear = `
                <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 8px;">
                    <div style="font-weight:600; color:#1d1d1f;">${t('yearByYear')}</div>
                    ${breakEvenYear ? `<button id="jumpBreakEvenBtn" class="button secondary" style="padding:6px 10px; font-size:12px;">${t('jumpToBreakeven', { year: breakEvenYear })}</button>` : ''}
                </div>
                <div style="overflow-x: auto; margin-bottom: 12px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 14px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: #495057;">${t('year')}</th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;">${t('mortgageBalance')}<br><small style="font-size: 11px; color: #6c757d;">(CHF)</small></th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;">${t('annualInterest')}<br><small style="font-size: 11px; color: #6c757d;">(CHF)</small></th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;">${t('annualAmortization')}<br><small style="font-size: 11px; color: #6c757d;">(CHF)</small></th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;">${t('annualMaintenance')}<br><small style="font-size: 11px; color: #6c757d;">(CHF)</small></th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;">${t('annualRent')}<br><small style="font-size: 11px; color: #6c757d;">(CHF)</small></th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;">${t('cumulativeBuyCost').replace('\n','<br>')}<br><small style="font-size: 11px; color: #6c757d;">(CHF)</small></th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;">${t('cumulativeRentCost').replace('\n','<br>')}<br><small style="font-size: 11px; color: #6c757d;">(CHF)</small></th>
                                <th style="padding: 12px 8px; text-align: right; font-weight: 600; color: #495057;">${t('advantage')}<br><small style="font-size: 11px; color: #6c757d;">(CHF)</small></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${yearRows}
                        </tbody>
                    </table>
                </div>
                <div style="background: #f0f8ff; padding: 12px; border-radius: 8px; font-size: 13px; line-height: 1.5;">
                    <strong>${t('howToRead')}</strong><br>
                    • <strong>${t('mortgageBalance')}:</strong> ${t('how1').split(':')[1] ? t('how1').split(':')[1].trim() : t('how1')}<br>
                    • <strong>${t('cumulativeBuyCost').replace('\\n', ' ')} / ${t('cumulativeRentCost').replace('\\n', ' ')}:</strong> ${t('how2').split(':')[1] ? t('how2').split(':')[1].trim() : t('how2')}<br>
                    • <strong>${t('advantage')}:</strong> ${t('how3').split(':')[1] ? t('how3').split(':')[1].trim() : t('how3')}
                </div>`;

            const content = [
                summary,
                section(t('monthlyBuying').replace(' (Buying)', ''), '#007aff', 'section-monthly', monthlySnapshot),
                section(t('purchaseBreakdownTitle'), '#34c759', 'section-purchase', purchaseBreakdown),
                section(t('rentBreakdownTitle'), '#ff3b30', 'section-rent', rentBreakdown),
                section(t('yearByYear'), '#007aff', 'section-yyy', yearByYear)
            ].join('');

            resultsDiv.innerHTML = content;
            resultsDiv.style.display = 'block';

            const yyyBody = document.getElementById('section-yyy');
            if (yyyBody) yyyBody.style.display = 'block';

            resultsDiv.querySelectorAll('.collapsible-header').forEach(h => {
                h.addEventListener('click', () => {
                    const targetId = h.getAttribute('data-target');
                    const body = document.getElementById(targetId);
                    if (body) body.style.display = (body.style.display === 'none') ? 'block' : 'none';
                });
            });

            const jumpBtn = document.getElementById('jumpBreakEvenBtn');
            if (jumpBtn && breakEvenYear) {
                jumpBtn.addEventListener('click', () => {
                    const row = document.getElementById(`year-row-${breakEvenYear}`);
                    if (row) {
                        if (yyyBody && yyyBody.style.display === 'none') yyyBody.style.display = 'block';
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        row.style.outline = '2px solid #007aff';
                        setTimeout(() => { row.style.outline = 'none'; }, 1500);
                    }
                });
            }
        }

        // Helper function to calculate auto-fields based on a test purchase price
        function getParametersWithAutoCalculations(testPurchasePrice) {
            const monthlyRent = parseFloat(document.getElementById('monthlyRent').value);
            const amortizationYears = parseInt(document.getElementById('amortizationYears').value);
            
            // Start with base parameters
            const params = {
                purchasePrice: testPurchasePrice,
                mortgageRate: parseFloat(document.getElementById('mortgageRate').value) / 100,
                monthlyRent: monthlyRent,
                propertyAppreciationRate: parseFloat(document.getElementById('propertyAppreciation').value) / 100,
                investmentYieldRate: parseFloat(document.getElementById('investmentYield').value) / 100,
                marginalTaxRate: parseFloat(document.getElementById('marginalTaxRate').value) / 100,
                termYears: parseInt(document.getElementById('termYears').value),
                amortizationYears: amortizationYears,
                totalRenovations: parseFloat(document.getElementById('totalRenovations').value),
                propertyTaxDeductions: parseFloat(document.getElementById('propertyTaxDeductions').value),
                annualRentalCosts: parseFloat(document.getElementById('annualRentalCosts').value),
                additionalPurchaseCosts: parseFloat(document.getElementById('additionalPurchaseCosts').value),
                scenarioMode: document.querySelector('input[name="scenarioMode"]:checked')?.value || 'equalConsumption'
            };
            
            // Handle down payment modes with 20% minimum enforcement
            const downPaymentMode = document.querySelector('input[name="downPaymentMode"]:checked').value;
            let downPayment = 0;
            
            if (downPaymentMode === 'auto') {
                downPayment = Math.round(testPurchasePrice * 0.2);
            } else if (downPaymentMode === 'manual') {
                downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
                const minDownPayment = Math.round(testPurchasePrice * 0.2);
                if (downPayment < minDownPayment) {
                    downPayment = minDownPayment;
                }
            } else if (downPaymentMode === 'mortgage') {
                const maxMortgageLimit = parseFloat(document.getElementById('mortgageAmount').value) || 0;
                const minDownPayment = Math.round(testPurchasePrice * 0.2);
                const maxPossibleMortgage = testPurchasePrice - minDownPayment;
                const actualMortgageAmount = Math.min(maxMortgageLimit, maxPossibleMortgage);
                downPayment = testPurchasePrice - actualMortgageAmount;
                if (downPayment < minDownPayment) {
                    downPayment = minDownPayment;
                }
            }
            
            params.downPayment = downPayment;
            
            if (document.getElementById('autoMaintenance').checked) {
                params.annualMaintenanceCosts = Math.round(testPurchasePrice * 0.0125);
            } else {
                params.annualMaintenanceCosts = parseFloat(document.getElementById('annualMaintenanceCosts').value);
            }
            
            const amortizationMode = document.querySelector('input[name="amortizationMode"]:checked').value;
            const mortgageAmount = testPurchasePrice - params.downPayment;
            
            if (amortizationMode === 'auto') {
                params.annualAmortization = Math.round(mortgageAmount / amortizationYears);
            } else if (amortizationMode === 'swiss') {
                const currentLTV = mortgageAmount / testPurchasePrice;
                const targetLTV = 0.65;
                
                if (currentLTV > targetLTV) {
                    const targetMortgageAmount = testPurchasePrice * targetLTV;
                    const amortizationNeeded = mortgageAmount - targetMortgageAmount;
                    params.annualAmortization = Math.round(amortizationNeeded / 15);
                } else {
                    params.annualAmortization = 0;
                }
            } else {
                params.annualAmortization = parseFloat(document.getElementById('annualAmortization').value);
            }
            
            if (document.getElementById('autoImputedRental').checked) {
                params.imputedRentalValue = Math.round(monthlyRent * 12 * 0.65);
            } else {
                params.imputedRentalValue = parseFloat(document.getElementById('imputedRentalValue').value);
            }
            
            return params;
        }
        // ... existing code ...

        // Break-even finder
        document.getElementById('breakevenBtn')?.addEventListener('click', () => {
            const options = {
                minPrice: parseFloat(document.getElementById('beMinPrice').value) || 1500000,
                maxPrice: parseFloat(document.getElementById('beMaxPrice').value) || 10000000,
                tolerance: parseFloat(document.getElementById('beTolerance').value) || 2500
            };

            const originalPurchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
            let low = options.minPrice;
            let high = options.maxPrice;
            let iterations = 0;
            let bestResult = null;
            let bestDifference = Infinity;
            const tolerance = options.tolerance;
            const maxIterations = 1000;

            while (low <= high && iterations < maxIterations) {
                const testPrice = Math.round((low + high) / 2);
                const params = getParametersWithAutoCalculations(testPrice);
                const result = SwissRentBuyCalculator.calculate(params);
                const difference = Math.abs(result.ResultValue);

                if (difference < bestDifference) {
                    bestDifference = difference;
                    bestResult = {
                        breakevenFound: difference <= tolerance,
                        breakevenPrice: testPrice,
                        resultValue: result.ResultValue,
                        decision: result.Decision,
                        difference: difference,
                        originalPrice: originalPurchasePrice,
                        priceDifference: testPrice - originalPurchasePrice
                    };
                }

                if (difference <= tolerance) break;
                if (result.ResultValue > 0) low = testPrice + 1; else high = testPrice - 1;
                iterations++;
            }

            if (bestResult) {
                bestResult.iterations = iterations;
                bestResult.message = bestResult.breakevenFound ? 
                    `Break-even found at ${bestResult.breakevenPrice.toLocaleString()} CHF` :
                    `Closest match found at ${bestResult.breakevenPrice.toLocaleString()} CHF (difference: ${bestResult.difference.toLocaleString()} CHF)`;
            }

            displayBreakevenResult(bestResult || {
                breakevenFound: false,
                message: `No break-even found in range ${options.minPrice.toLocaleString()}-${options.maxPrice.toLocaleString()} CHF`,
                iterations
            });
        });

        function displayBreakevenResult(result) {
            const resultsDiv = document.getElementById('breakevenResults');
            if (!resultsDiv) return;

            if (result.breakevenFound) {
                const detailedParams = getParametersWithAutoCalculations(result.breakevenPrice);
                const detailedResult = SwissRentBuyCalculator.calculate(detailedParams);
                const priceDifference = result.priceDifference || 0;
                const priceDifferenceTextEn = priceDifference > 0 ? 
                    `CHF ${Math.abs(priceDifference).toLocaleString()} higher than current single calc price` :
                    `CHF ${Math.abs(priceDifference).toLocaleString()} lower than current single calc price`;
                const priceDifferenceTextDe = priceDifference > 0 ?
                    `CHF ${Math.abs(priceDifference).toLocaleString()} höher als aktueller Einzelpreis` :
                    `CHF ${Math.abs(priceDifference).toLocaleString()} tiefer als aktueller Einzelpreis`;

                resultsDiv.innerHTML = `
                    <div style="margin-bottom: 20px; padding: 20px; background: white; border-radius: 8px; border-left: 4px solid #34c759;">
                        <div class="result-item decision-even" style="font-size: 18px; font-weight: 600; margin-bottom: 10px; border-bottom: none;">
                            <span>${currentLang==='de'?'Maximaler Gebotspreis gefunden':'Maximum Bid Price Found'}</span>
                            <span>CHF ${result.breakevenPrice.toLocaleString()}</span>
                        </div>
                        <div style="font-size: 16px; line-height: 1.4;">
                            <strong>${currentLang==='de'?'Bei diesem Preis sind Kauf und Miete kostenmässig gleich (Break-even)':'At this price, buying and renting have equal total costs (break-even point)'}</strong><br>
                            <small>${currentLang==='de'?'Break-even-Genauigkeit':'Break-even accuracy'}: ±CHF ${Math.abs(result.resultValue).toLocaleString()} (${result.iterations} iterations)</small><br>
                            <small>${currentLang==='de'?priceDifferenceTextDe:priceDifferenceTextEn}</small>
                        </div>
                    </div>
                    <h4>${currentLang==='de'?'Detailresultate beim Maximalgebotspreis':'Detailed Calculation Results at Maximum Bid Price'}</h4>
                    <div class="result-item"><span>${currentLang==='de'?'Kaufpreis:':'Purchase Price:'}</span><span>CHF ${detailedResult.PurchasePrice.toLocaleString()}</span></div>
                    <div class="result-item"><span>${currentLang==='de'?'Eigenmittel:':'Down Payment:'}</span><span>CHF ${detailedResult.DownPayment.toLocaleString()}</span></div>
                    <div class="result-item"><span>${currentLang==='de'?'Hypothek:':'Mortgage Amount:'}</span><span>CHF ${detailedResult.MortgageAmount.toLocaleString()}</span></div>
                    <div class="result-item"><span>${currentLang==='de'?'Belehnung:':'Loan-to-Value Ratio:'}</span><span>${((detailedResult.MortgageAmount / detailedResult.PurchasePrice) * 100).toFixed(1)}%</span></div>
                    <div class="result-item"><span>${currentLang==='de'?'Zinskosten ('+detailedResult.TermYears+' Jahre):':'Interest Costs ('+detailedResult.TermYears+' years):'}</span><span>CHF ${Math.round(detailedResult.InterestCosts).toLocaleString()}</span></div>
                    <div class="result-item"><span>${currentLang==='de'?'Total Kaufkosten:':'Total Purchase Cost:'}</span><span>CHF ${Math.round(detailedResult.TotalPurchaseCost).toLocaleString()}</span></div>
                    <div class="result-item"><span>${currentLang==='de'?'Total Mietkosten:':'Total Rental Cost:'}</span><span>CHF ${Math.round(detailedResult.TotalRentalCost).toLocaleString()}</span></div>
                    <div class="result-item"><span>${currentLang==='de'?'Finanzieller Vorteil:':'Net Financial Benefit:'}</span><span>CHF ${Math.round(detailedResult.ResultValue).toLocaleString()}</span></div>
                `;
            } else {
                resultsDiv.innerHTML = `
                    <div style="padding: 15px; background: rgba(255, 59, 48, 0.1); border-radius: 8px; color: #ff3b30;">
                        <strong>${result.message}</strong>
                        <br>${currentLang==='de'?'Suche abgeschlossen in':'Search completed in'} ${result.iterations} iterations.
                        <br><br>${currentLang==='de'?'Passen Sie den Suchbereich an oder prüfen Sie die Eingaben.':'Try adjusting the search price range or check your input parameters.'}
                    </div>
                `;
            }
            resultsDiv.style.display = 'block';
        }

        // Parameter sweep functionality (simplified, preserves previous behavior)
        let sweepData = [];
        function formatBidPrice(price) {
            if (!price || price <= 0) return 'N/A';
            if (price >= 1000000) {
                const millions = price / 1000000;
                return (millions >= 10 ? (Math.round(millions * 10) / 10) : (Math.round(millions * 100) / 100)) + 'M';
            } else if (price >= 1000) {
                const thousands = price / 1000;
                return (Math.round(thousands * 10) / 10) + 'k';
            }
            return Math.round(price).toString();
        }
        function runMaxBidPriceSweep(baseParams, sweepRanges) {
            const results = [];
            const propRates = [];
            for (let v = sweepRanges.propertyAppreciationRate.min; v <= sweepRanges.propertyAppreciationRate.max + 1e-9; v += sweepRanges.propertyAppreciationRate.step) propRates.push(Number(v.toFixed(4)));
            const invRates = [];
            for (let v = sweepRanges.investmentYieldRate.min; v <= sweepRanges.investmentYieldRate.max + 1e-9; v += sweepRanges.investmentYieldRate.step) invRates.push(Number(v.toFixed(4)));
            const mortRates = [];
            for (let v = sweepRanges.mortgageRate.min; v <= sweepRanges.mortgageRate.max + 1e-9; v += sweepRanges.mortgageRate.step) mortRates.push(Number(v.toFixed(4)));

            propRates.forEach(propRate => {
                invRates.forEach(invRate => {
                    mortRates.forEach(mortRate => {
                        // Binary search for this combination
                        const minPrice = parseFloat(document.getElementById('beMinPrice').value) || 1500000;
                        const maxPrice = parseFloat(document.getElementById('beMaxPrice').value) || 10000000;
                        const tolerance = parseFloat(document.getElementById('beTolerance').value) || 2500;
                        let low = minPrice, high = maxPrice;
                        let bestPrice = null, bestDifference = Infinity;
                        let iterations = 0;
                        while (low <= high && iterations < 150) {
                            const testPrice = Math.round((low + high) / 2);
                            const paramsWithPrice = getParametersWithAutoCalculations(testPrice);
                            paramsWithPrice.propertyAppreciationRate = propRate;
                            paramsWithPrice.investmentYieldRate = invRate;
                            paramsWithPrice.mortgageRate = mortRate;
                            const result = SwissRentBuyCalculator.calculate(paramsWithPrice);
                            const difference = Math.abs(result.ResultValue);
                            if (difference < bestDifference) { bestDifference = difference; bestPrice = testPrice; }
                            if (difference <= tolerance) break;
                            if (result.ResultValue > 0) low = testPrice + 1; else high = testPrice - 1;
                            iterations++;
                        }
                        // boundary checks
                        if (bestPrice === null) bestPrice = minPrice;
                        results.push({
                            propertyAppreciationRate: propRate,
                            investmentYieldRate: invRate,
                            mortgageRate: mortRate,
                            maxBidPrice: bestPrice,
                            propertyAppreciationPercent: (propRate * 100).toFixed(1),
                            investmentYieldPercent: (invRate * 100).toFixed(1),
                            mortgageRatePercent: (mortRate * 100).toFixed(1)
                        });
                    });
                });
            });
            return results;
        }
        function createMonthlyExpenseTable(data, propRates, invRates, mortRates, currentPurchasePrice) {
            const monthlyExpensesByMortRate = {};
            mortRates.forEach(mortRate => {
                const testParams = getParametersWithAutoCalculations(currentPurchasePrice);
                testParams.mortgageRate = mortRate;
                const res = SwissRentBuyCalculator.calculate(testParams);
                monthlyExpensesByMortRate[mortRate] = res.TotalMonthlyExpenses;
            });
            let monthlyTable = '<div class="pivot-table"><table>';
            monthlyTable += '<thead><tr>' +
                '<th style="background:#f8f9fa;border:1px solid #ddd; font-weight:bold; padding:12px; text-align:center;">'+(currentLang==='de'?'Hypothekarzins (%)':'Mortgage Rate (%)')+'</th>' +
                '<th style="background:#e3f2fd;border:1px solid #ddd; font-weight:bold; padding:12px; text-align:center;">'+(currentLang==='de'?'Monatliche Kosten':'Monthly Expenses')+'</th>' +
                '</tr></thead><tbody>';
            mortRates.forEach(mortRate => {
                const monthlyExpense = monthlyExpensesByMortRate[mortRate];
                const formattedExpense = `CHF ${Math.round(monthlyExpense).toLocaleString()}`;
                monthlyTable += `<tr>
                    <td style="background:#fff3e0; font-weight:bold; text-align:center; border:1px solid #ddd; font-size:14px; padding:12px;">${(mortRate * 100).toFixed(1)}%</td>
                    <td style="background:#f9f9f9; text-align:center; font-size:14px; padding:12px; border:1px solid #ddd; font-weight:bold;">${formattedExpense}</td>
                </tr>`;
            });
            monthlyTable += '</tbody></table></div>';
            return monthlyTable;
        }
        function displaySweepResults(data) {
            const resultsDiv = document.getElementById('sweepResults');
            if (!data || data.length === 0) { resultsDiv.innerHTML = '<div>No results</div>'; return; }
            const propRates = [...new Set(data.map(d => d.propertyAppreciationRate))].sort((a,b)=>a-b);
            const invRates = [...new Set(data.map(d => d.investmentYieldRate))].sort((a,b)=>a-b);
            const mortRates = [...new Set(data.map(d => d.mortgageRate))].sort((a,b)=>a-b);
            let table = '<div class="pivot-table"><table>';
            table += '<thead><tr>'+
                '<th rowspan="2" style="background:#f8f9fa; vertical-align:middle; border:1px solid #ddd; font-weight:bold;">'+(currentLang==='de'?'Hypothekar-\nZins (%)':'Mortgage\nRate (%)')+'</th>'+ 
                '<th rowspan="2" style="background:#f8f9fa; vertical-align:middle; border:1px solid #ddd; font-weight:bold;">'+(currentLang==='de'?'Rendite (%)':'Yield (%)')+'</th>'+ 
                `<th colspan="${propRates.length}" style="background:#e3f2fd; text-align:center; border:1px solid #ddd; font-weight:bold; font-size:14px;">${currentLang==='de'?'Wertsteigerung (%/Jahr)':'Property Appreciation (%/year)'}</th>`+
                '</tr><tr>';
            propRates.forEach(rate => { table += `<th style="background:#e8f4f8; text-align:center; border:1px solid #ddd; font-size:12px; padding:8px;">${(rate*100).toFixed(1)}%</th>`; });
            table += '</tr></thead><tbody>';
            mortRates.forEach((mortRate, mortIdx) => {
                invRates.forEach((invRate, invIdx) => {
                    table += '<tr>';
                    if (invIdx === 0) table += `<td rowspan="${invRates.length}" style="background:#fff3e0; vertical-align:middle; font-weight:bold; text-align:center; border:1px solid #ddd; font-size:13px;">${(mortRate*100).toFixed(1)}</td>`;
                    table += `<td style="background:#f1f8e9; font-weight:600; text-align:center; border:1px solid #ddd; font-size:13px;">${(invRate*100).toFixed(1)}</td>`;
                    propRates.forEach(propRate => {
                        const row = data.find(d => Math.abs(d.propertyAppreciationRate-propRate)<0.0001 && Math.abs(d.investmentYieldRate-invRate)<0.0001 && Math.abs(d.mortgageRate-mortRate)<0.0001);
                        table += `<td style="text-align:center; font-size:12px; padding:6px; border:1px solid #ddd; font-weight:bold;">${row?formatBidPrice(row.maxBidPrice):'N/A'}</td>`;
                    });
                    table += '</tr>';
                });
                if (mortIdx < mortRates.length - 1) {
                    table += `<tr style="border-bottom: 3px solid #666;"><td colspan="${propRates.length + 2}" style="height:2px; padding:0; border:none;"></td></tr>`;
                }
            });
            table += '</tbody></table></div>';
            const currentPurchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 2000000;
            const monthlyTable = createMonthlyExpenseTable(data, propRates, invRates, mortRates, currentPurchasePrice);
            resultsDiv.innerHTML = `
                <h4>${currentLang==='de'?'Analyse der Parametersimulation':'Parameter Sweep Analysis'} (${data.length} ${currentLang==='de'?'Kombinationen':'combinations'})</h4>
                ${table}
                <h5 style="margin: 30px 0 10px 0; color: #1976d2;">${currentLang==='de'?'Monatliche Kosten':'Monthly Cost Analysis'}</h5>
                ${monthlyTable}
            `;
        }
        function arrayToCsv(data) {
            if (!data || data.length === 0) return '';
            const headers = Object.keys(data[0]);
            const csvContent = [headers.join(','), ...data.map(row => headers.map(h => {
                const v = row[h];
                if (typeof v === 'string' && v.includes(',')) return `"${v}"`;
                return v;
            }).join(','))].join('\n');
            return csvContent;
        }
        function downloadCsv(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        function setupCsvDownloadButtons() {
            const btnMax = document.getElementById('downloadMaxBidCsvBtn');
            if (btnMax) btnMax.addEventListener('click', () => {
                if (!sweepData || sweepData.length === 0) return;
                const rows = sweepData.map(d => ({
                    PropertyAppreciationRate: d.propertyAppreciationPercent + '%',
                    InvestmentYieldRate: d.investmentYieldPercent + '%',
                    MortgageRate: d.mortgageRatePercent + '%',
                    MaxBidPrice: d.maxBidPrice ? Math.round(d.maxBidPrice) : 'N/A'
                }));
                downloadCsv(arrayToCsv(rows), `max_bid_price_sweep_${new Date().toISOString().split('T')[0]}.csv`);
            });
            const btnMonthly = document.getElementById('downloadMonthlyCsvBtn');
            if (btnMonthly) btnMonthly.addEventListener('click', () => {
                // Build a small monthly CSV from current mortgage rates
                const mortRates = [...new Set(sweepData.map(d => d.mortgageRate))].sort((a,b)=>a-b);
                const currentPurchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 2000000;
                const rows = mortRates.map(r => {
                    const params = getParametersWithAutoCalculations(currentPurchasePrice);
                    params.mortgageRate = r;
                    const res = SwissRentBuyCalculator.calculate(params);
                    return { MortgageRate: (r*100).toFixed(1)+'%', MonthlyExpenses: Math.round(res.TotalMonthlyExpenses) };
                });
                downloadCsv(arrayToCsv(rows), `monthly_cost_analysis_${new Date().toISOString().split('T')[0]}.csv`);
            });
        }
        document.getElementById('sweepBtn')?.addEventListener('click', () => {
            const sweepBtn = document.getElementById('sweepBtn');
            const resultsDiv = document.getElementById('sweepResults');
            if (!sweepBtn || !resultsDiv) return;
            sweepBtn.textContent = currentLang==='de'?'Läuft...':'Running...';
            sweepBtn.disabled = true;
            resultsDiv.innerHTML = '<div class="loading">'+(currentLang==='de'?'Parametersimulation wird ausgeführt...':'Running parameter sweep...')+'</div>';
            setTimeout(() => {
                try {
                    const baseParams = {}; // not used directly due to getParametersWithAutoCalculations
                    const sweepRanges = {
                        propertyAppreciationRate: {
                            min: parseFloat(document.getElementById('propAppMin').value) / 100,
                            max: parseFloat(document.getElementById('propAppMax').value) / 100,
                            step: parseFloat(document.getElementById('propAppStep').value) / 100
                        },
                        investmentYieldRate: {
                            min: parseFloat(document.getElementById('invYieldMin').value) / 100,
                            max: parseFloat(document.getElementById('invYieldMax').value) / 100,
                            step: parseFloat(document.getElementById('invYieldStep').value) / 100
                        },
                        mortgageRate: {
                            min: parseFloat(document.getElementById('mortRateMin').value) / 100,
                            max: parseFloat(document.getElementById('mortRateMax').value) / 100,
                            step: parseFloat(document.getElementById('mortRateStep').value) / 100
                        }
                    };
                    sweepData = runMaxBidPriceSweep(baseParams, sweepRanges);
                    displaySweepResults(sweepData);
                    setupCsvDownloadButtons();
                } catch (e) {
                    resultsDiv.innerHTML = `<div style="color:#ff3b30;">Error: ${e.message}</div>`;
                } finally {
                    sweepBtn.textContent = t('runSweep');
                    sweepBtn.disabled = false;
                }
            }, 50);
        });

        // Save/Load parameters
        function getAllParameters() {
            return {
                version: '2.1.0',
                timestamp: new Date().toISOString(),
                single: {
                    purchasePrice: parseFloat(document.getElementById('purchasePrice').value) || 0,
                    scenarioMode: document.querySelector('input[name="scenarioMode"]:checked')?.value || 'equalConsumption',
                    downPaymentMode: document.querySelector('input[name="downPaymentMode"]:checked')?.value || 'auto',
                    downPayment: parseFloat(document.getElementById('downPayment').value) || 0,
                    mortgageAmount: parseFloat(document.getElementById('mortgageAmount').value) || 0,
                    additionalPurchaseCosts: parseFloat(document.getElementById('additionalPurchaseCosts').value) || 0,
                    totalRenovations: parseFloat(document.getElementById('totalRenovations').value) || 0,
                    mortgageRate: parseFloat(document.getElementById('mortgageRate').value) || 0,
                    amortizationYears: parseInt(document.getElementById('amortizationYears').value) || 10,
                    amortizationMode: document.querySelector('input[name="amortizationMode"]:checked')?.value || 'auto',
                    annualAmortization: parseFloat(document.getElementById('annualAmortization').value) || 0,
                    autoMaintenance: document.getElementById('autoMaintenance').checked,
                    annualMaintenanceCosts: parseFloat(document.getElementById('annualMaintenanceCosts').value) || 0,
                    propertyAppreciation: parseFloat(document.getElementById('propertyAppreciation').value) || 0,
                    autoImputedRental: document.getElementById('autoImputedRental').checked,
                    imputedRentalValue: parseFloat(document.getElementById('imputedRentalValue').value) || 0,
                    propertyTaxDeductions: parseFloat(document.getElementById('propertyTaxDeductions').value) || 0,
                    marginalTaxRate: parseFloat(document.getElementById('marginalTaxRate').value) || 0,
                    monthlyRent: parseFloat(document.getElementById('monthlyRent').value) || 0,
                    annualRentalCosts: parseFloat(document.getElementById('annualRentalCosts').value) || 0,
                    investmentYield: parseFloat(document.getElementById('investmentYield').value) || 0,
                    termYears: parseInt(document.getElementById('termYears').value) || 10
                },
                breakeven: {
                    minPrice: parseFloat(document.getElementById('beMinPrice').value) || 1500000,
                    maxPrice: parseFloat(document.getElementById('beMaxPrice').value) || 10000000,
                    tolerance: parseFloat(document.getElementById('beTolerance').value) || 2500
                },
                sweep: {
                    propAppMin: parseFloat(document.getElementById('propAppMin').value) || -1,
                    propAppMax: parseFloat(document.getElementById('propAppMax').value) || 5,
                    propAppStep: parseFloat(document.getElementById('propAppStep').value) || 1,
                    invYieldMin: parseFloat(document.getElementById('invYieldMin').value) || -1,
                    invYieldMax: parseFloat(document.getElementById('invYieldMax').value) || 8,
                    invYieldStep: parseFloat(document.getElementById('invYieldStep').value) || 1,
                    mortRateMin: parseFloat(document.getElementById('mortRateMin').value) || 1,
                    mortRateMax: parseFloat(document.getElementById('mortRateMax').value) || 5,
                    mortRateStep: parseFloat(document.getElementById('mortRateStep').value) || 1
                }
            };
        }
        function saveParameters() {
            try {
                const parameters = getAllParameters();
                const jsonString = JSON.stringify(parameters, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `swiss-rent-buy-calculator-params-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                showSaveLoadStatus(currentLang==='de'?'Parameter erfolgreich gespeichert!':'Parameters saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving parameters:', error);
                showSaveLoadStatus((currentLang==='de'?'Fehler beim Speichern: ':'Error saving parameters: ') + error.message, 'error');
            }
        }
        function loadParameters(parametersData) {
            try {
                if (!parametersData || typeof parametersData !== 'object') throw new Error('Invalid parameter file format');
                const params = parametersData;
                if (params.single) {
                    const s = params.single;
                    if (s.scenarioMode) document.querySelector(`input[name="scenarioMode"][value="${s.scenarioMode}"]`)?.click();
                    if (s.purchasePrice !== undefined) document.getElementById('purchasePrice').value = s.purchasePrice;
                    if (s.additionalPurchaseCosts !== undefined) document.getElementById('additionalPurchaseCosts').value = s.additionalPurchaseCosts;
                    if (s.totalRenovations !== undefined) document.getElementById('totalRenovations').value = s.totalRenovations;
                    if (s.downPaymentMode) document.querySelector(`input[name="downPaymentMode"][value="${s.downPaymentMode}"]`)?.click();
                    if (s.downPayment !== undefined) document.getElementById('downPayment').value = s.downPayment;
                    if (s.mortgageAmount !== undefined) document.getElementById('mortgageAmount').value = s.mortgageAmount;
                    if (s.mortgageRate !== undefined) document.getElementById('mortgageRate').value = s.mortgageRate;
                    if (s.amortizationYears !== undefined) document.getElementById('amortizationYears').value = s.amortizationYears;
                    if (s.amortizationMode) document.querySelector(`input[name="amortizationMode"][value="${s.amortizationMode}"]`)?.click();
                    if (s.annualAmortization !== undefined) document.getElementById('annualAmortization').value = s.annualAmortization;
                    if (s.autoMaintenance !== undefined) document.getElementById('autoMaintenance').checked = s.autoMaintenance;
                    if (s.annualMaintenanceCosts !== undefined) document.getElementById('annualMaintenanceCosts').value = s.annualMaintenanceCosts;
                    if (s.propertyAppreciation !== undefined) document.getElementById('propertyAppreciation').value = s.propertyAppreciation;
                    if (s.autoImputedRental !== undefined) document.getElementById('autoImputedRental').checked = s.autoImputedRental;
                    if (s.imputedRentalValue !== undefined) document.getElementById('imputedRentalValue').value = s.imputedRentalValue;
                    if (s.propertyTaxDeductions !== undefined) document.getElementById('propertyTaxDeductions').value = s.propertyTaxDeductions;
                    if (s.marginalTaxRate !== undefined) document.getElementById('marginalTaxRate').value = s.marginalTaxRate;
                    if (s.monthlyRent !== undefined) document.getElementById('monthlyRent').value = s.monthlyRent;
                    if (s.annualRentalCosts !== undefined) document.getElementById('annualRentalCosts').value = s.annualRentalCosts;
                    if (s.investmentYield !== undefined) document.getElementById('investmentYield').value = s.investmentYield;
                    if (s.termYears !== undefined) document.getElementById('termYears').value = s.termYears;
                }
                if (params.breakeven) {
                    const b = params.breakeven;
                    if (b.minPrice !== undefined) document.getElementById('beMinPrice').value = b.minPrice;
                    if (b.maxPrice !== undefined) document.getElementById('beMaxPrice').value = b.maxPrice;
                    if (b.tolerance !== undefined) document.getElementById('beTolerance').value = b.tolerance;
                }
                if (params.sweep) {
                    const sw = params.sweep;
                    if (sw.propAppMin !== undefined) document.getElementById('propAppMin').value = sw.propAppMin;
                    if (sw.propAppMax !== undefined) document.getElementById('propAppMax').value = sw.propAppMax;
                    if (sw.propAppStep !== undefined) document.getElementById('propAppStep').value = sw.propAppStep;
                    if (sw.invYieldMin !== undefined) document.getElementById('invYieldMin').value = sw.invYieldMin;
                    if (sw.invYieldMax !== undefined) document.getElementById('invYieldMax').value = sw.invYieldMax;
                    if (sw.invYieldStep !== undefined) document.getElementById('invYieldStep').value = sw.invYieldStep;
                    if (sw.mortRateMin !== undefined) document.getElementById('mortRateMin').value = sw.mortRateMin;
                    if (sw.mortRateMax !== undefined) document.getElementById('mortRateMax').value = sw.mortRateMax;
                    if (sw.mortRateStep !== undefined) document.getElementById('mortRateStep').value = sw.mortRateStep;
                }
                updateCalculatedFields();
                showSaveLoadStatus(currentLang==='de'?'Parameter erfolgreich geladen!':'Parameters loaded successfully!', 'success');
            } catch (error) {
                console.error('Error loading parameters:', error);
                showSaveLoadStatus((currentLang==='de'?'Fehler beim Laden: ':'Error loading parameters: ') + error.message, 'error');
            }
        }
        function showSaveLoadStatus(message, type) {
            const statusElement = document.getElementById('saveLoadStatus');
            if (!statusElement) return;
            statusElement.textContent = message;
            statusElement.className = `save-load-status ${type}`;
            setTimeout(() => { statusElement.textContent = ''; statusElement.className = 'save-load-status'; }, 3000);
        }
        async function setVersionNumbers() {
            let version = '2.1.0';
            try {
                const response = await fetch('calculator.js');
                const content = await response.text();
                const versionMatch = content.match(/@version\s+(\d+\.\d+\.\d+)/);
                if (versionMatch) version = versionMatch[1];
            } catch {}
            const appVersionElement = document.getElementById('app-version');
            const footerVersionElement = document.getElementById('footer-version');
            if (appVersionElement) appVersionElement.textContent = version;
            if (footerVersionElement) footerVersionElement.textContent = version;
            document.title = `Swiss Rent vs Buy Calculator v${version}`;
        }
        document.getElementById('saveParametersBtn')?.addEventListener('click', saveParameters);
        document.getElementById('loadParametersBtn')?.addEventListener('click', () => document.getElementById('loadFileInput').click());
        document.getElementById('loadFileInput')?.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try { const parametersData = JSON.parse(e.target.result); loadParameters(parametersData); }
                    catch { showSaveLoadStatus(currentLang==='de'?'Fehlerhafte JSON-Datei':'Error reading file: Invalid JSON format', 'error'); }
                };
                reader.readAsText(file);
            }
            event.target.value = '';
        });

        // Initialize
        setVersionNumbers();
        updateCalculatedFields();
        document.getElementById('calculateBtn')?.click();
    </script>
</body>
</html>